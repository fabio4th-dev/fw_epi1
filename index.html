<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestão de EPIs</title>
    <link rel="icon" type="image/x-icon" href="fw_mini.ico">
    <link rel="icon" type="image/x-icon" href="fw_mini.ico">
    <link rel="shortcut icon" href="fw_mini.ico">
    <link rel="icon" type="image/png" href="fw_mini.ico">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <!-- Adicione no HEAD do seu HTML -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        /* ============================================
           ESTILOS GERAIS
           ============================================ */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #2980b9;
            --light-color: #ecf0f1;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --gray-color: #95a5a6;
            --text-color: #2c3e50;
            --border-color: #bdc3c7;
            --epi-color: #8e44ad;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ============================================
           TELA DE LOGIN
           ============================================ */
        .login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-box {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .login-box::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 200%;
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(25deg);
        }

        .login-header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
            z-index: 1;
        }

        .login-logo-fw {
            width: 180px;
            margin: 0 auto 20px;
        }

        .login-logo-fw img {
            width: 100%;
            height: auto;
        }

        .login-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .login-subtitle {
            font-size: 16px;
            opacity: 0.9;
        }

        .login-form {
            position: relative;
            z-index: 1;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: white;
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .form-group input:focus {
            outline: none;
            border-color: white;
            background: rgba(255, 255, 255, 0.2);
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            background-color: white;
            color: var(--primary-color);
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .login-btn:hover {
            background-color: var(--light-color);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .login-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            position: relative;
            z-index: 1;
        }

        .login-error {
            background-color: rgba(231, 76, 60, 0.2);
            border: 1px solid var(--danger-color);
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            position: relative;
            z-index: 1;
        }

        .login-error.show {
            display: block;
        }

        /* ============================================
           DASHBOARD
           ============================================ */
        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            flex: 1;
        }

        .dashboard-header {
            background: linear-gradient(135deg, var(--primary-color), var(--epi-color));
            border-radius: 12px;
            padding: 2px;
            margin-bottom: 5px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .dashboard-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 200%;
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(25deg);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            position: relative;
            z-index: 1;
            margin-bottom: 2px;
        }

        .logo-fw {
            width: 140px;
            flex-shrink: 0;
            margin-left: 25px;
            position: relative;
            top: 42px;
        }

        .logo-fw img {
            width: 100%;
            height: auto;
            margin-left: 20px;
            margin-top: 10px;
            max-height: 650px;
            object-fit: contain;
        }

        .header-center {
            text-align: center;
            flex-grow: 1;
            padding: 0 20px;
        }

        .project-title {
            font-size: 40px;
            font-weight: 700;
            position: relative;
            left: 70px;
            z-index: 1;
            margin-bottom: 5px;
        }

        .project-subtitle {
            font-size: 16px;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .header-right {
            display: flex;
            gap: 30px;
            flex-shrink: 0;
        }

        .logo-right img {
            width: 100%;
            height: auto;
            max-height: 60px;
            object-fit: contain;
        }

        .logo-delservin {
            width: 130px;
            position: relative;
            top: 38px;
            flex-shrink: 0;
        }

        .logo-altercon {
            width: 100px;
            position: relative;
            top: 38px;
            margin-right: 30px;
            flex-shrink: 0;
        }

        .user-info {
            position: absolute;
            top: 0px;
            right: 30px;
            /* ← Mude de 450px para 30px */
            z-index: 2;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        @media (max-width: 1200px) {
            .user-info {
                right: 20px !important;
                top: 100px !important;
            }
        }

        .user-welcome {
            color: white;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .project-info {
            display: flex;
            gap: 20px;
            position: relative;
            z-index: 1;
            align-items: center;
            justify-content: center;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .info-item {
            text-align: center;
            min-width: 100px;
        }

        .info-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .info-value {
            font-size: 20px;
            font-weight: 700;
        }

        /* ============================================
           ABAS
           ============================================ */
        .tabs-container {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
            overflow: hidden;
        }

        .tabs-header {
            display: flex;
            background-color: var(--light-color);
            border-bottom: 1px solid var(--border-color);
            padding: 0 20px;
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 18px 25px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-color);
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-button:hover {
            background-color: rgba(255, 255, 255, 0.5);
        }

        .tab-button.active {
            background-color: white;
            color: var(--epi-color);
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: var(--epi-color);
        }

        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.5s ease;
            color: var(--text-color);
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-title {
            font-size: 22px;
            margin-bottom: 25px;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            color: var(--epi-color);
        }

        /* ============================================
           BOTÕES DE SINCRONIZAÇÃO
           ============================================ */
        .sync-buttons-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .sync-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .sync-btn-cloud {
            background-color: var(--secondary-color);
            color: white;
        }

        .sync-btn-cloud:hover {
            background-color: #2980b9;
        }

        .sync-btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .sync-btn-success:hover {
            background-color: #219653;
        }

        .sync-btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .sync-btn-warning:hover {
            background-color: #e67e22;
        }

        .sync-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 10px;
        }

        .sync-status.online {
            background-color: rgba(39, 174, 96, 0.1);
            color: var(--success-color);
        }

        .sync-status.offline {
            background-color: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
        }

        /* ============================================
           FORMULÁRIOS
           ============================================ */
        .form-container {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--primary-color);
        }

        label.required::after {
            content: " *";
            color: var(--danger-color);
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 15px;
            transition: border 0.3s ease;
            background-color: white;
            color: var(--text-color);
        }

        input::placeholder,
        select::placeholder,
        textarea::placeholder {
            color: var(--gray-color);
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--epi-color);
        }

        /* ============================================
           BOTÕES
           ============================================ */
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--epi-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #7d3c98;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #219653;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background-color: #e67e22;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* ============================================
           FOTOGRAFIA
           ============================================ */
        .image-capture-container {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
        }

        .camera-area {
            width: 100%;
            height: 300px;
            background-color: var(--light-color);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
        }

        .camera-area img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .camera-placeholder {
            text-align: center;
            color: var(--gray-color);
        }

        .camera-placeholder i {
            font-size: 60px;
            margin-bottom: 15px;
        }

        .camera-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        /* ============================================
           TABELAS
           ============================================ */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th {
            background-color: var(--light-color);
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
            color: var(--text-color);
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background-color: rgba(236, 240, 241, 0.5);
        }

        /* ============================================
           MODAL
           ============================================ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalFadeIn 0.3s ease;
        }

        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            color: var(--primary-color);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--gray-color);
        }

        .modal-body {
            padding: 25px;
            color: var(--text-color);
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ============================================
           NOTIFICAÇÕES
           ============================================ */
        .notification {
            position: fixed;
            top: 150px;
            right: 20px;
            padding: 10px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1100;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 400px;
        }

        .notification-success {
            background-color: var(--success-color);
        }

        .notification-error {
            background-color: var(--danger-color);
        }

        .notification-warning {
            background-color: var(--warning-color);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ============================================
           CARDS
           ============================================ */
        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 35px;
        }

        .card {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-left: 4px solid var(--epi-color);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title i {
            color: var(--epi-color);
        }

        /* ============================================
           BADGES DE STATUS
           ============================================ */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }

        .status-completed {
            background-color: rgba(39, 174, 96, 0.1);
            color: var(--success-color);
        }

        .status-ontrack {
            background-color: rgba(52, 152, 219, 0.1);
            color: var(--secondary-color);
        }

        .status-delayed {
            background-color: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
        }

        /* ============================================
           GRÁFICOS
           ============================================ */
        .chart-container {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
            height: 450px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-title i {
            color: var(--epi-color);
        }

        /* ============================================
           PROGRESS BAR
           ============================================ */
        .progress-container {
            margin-bottom: 18px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--text-color);
        }

        .progress-bar {
            height: 10px;
            background-color: var(--light-color);
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.8s ease;
        }

        .progress-fill.actual {
            background-color: var(--success-color) !important;
        }

        .progress-fill.planned {
            background-color: var(--warning-color) !important;
        }

        .progress-fill {
            background-color: var(--danger-color) !important;
        }

        /* ============================================
           FORMULÁRIO EM LOTE
           ============================================ */
        .batch-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .batch-table th {
            background-color: var(--light-color);
            padding: 12px;
            text-align: left;
        }

        .batch-table td {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .batch-table input,
        .batch-table select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        .add-row-btn {
            margin-top: 15px;
            background-color: var(--success-color);
            color: white;
        }

        .remove-row-btn {
            background-color: var(--danger-color);
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        /* ============================================
           FORMULÁRIO AVARIAS
           ============================================ */
        .damage-form-container {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
        }

        /* ============================================
           RESPONSIVIDADE
           ============================================ */
        @media (max-width: 992px) {
            .header-top {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .logo-fw,
            .header-right {
                width: 100%;
                justify-content: center;
            }

            .header-center {
                padding: 0;
            }

            .project-info {
                gap: 15px;
            }

            .info-item {
                min-width: 80px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .user-info {
                position: relative;
                top: 0;
                right: 0;
                justify-content: center;
                margin-top: 10px;
            }
        }

        @media (max-width: 768px) {
            .tabs-header {
                justify-content: center;
            }

            .btn-group {
                justify-content: center;
            }

            table {
                font-size: 13px;
            }

            th,
            td {
                padding: 10px 8px;
            }

            .login-box {
                padding: 30px 20px;
            }

            .login-title {
                font-size: 28px;
            }

            .sync-buttons-container {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .dashboard-container {
                padding: 10px;
            }

            .tab-content {
                padding: 15px;
            }

            .section-title {
                font-size: 18px;
            }

            .card {
                padding: 15px;
            }

            .btn {
                padding: 10px 15px;
                font-size: 14px;
            }

            .camera-controls {
                flex-wrap: wrap;
            }

            .login-box {
                padding: 25px 15px;
            }

            .login-title {
                font-size: 24px;
            }
        }

        /* ============================================
           SEPARADORES
           ============================================ */
        .form-section {
            margin-bottom: 30px;
            padding-bottom: 25px;
            border-bottom: 2px solid var(--light-color);
        }

        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .form-section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-section-title i {
            color: var(--epi-color);
        }

        .separator {
            height: 2px;
            background: var(--light-color);
            margin: 25px 0;
        }

        /* ============================================
           TERMO DE RESPONSABILIDADE
           ============================================ */
        .termo-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            color: var(--text-color);
        }

        .termo-content {
            border: 1px solid var(--border-color);
            padding: 30px;
            margin: 20px 0;
            background-color: #f9f9f9;
            line-height: 1.8;
            font-size: 14px;
            max-height: 500px;
            overflow-y: auto;
        }

        /* ============================================
           COLABORADORES
           ============================================ */
        .collaborator-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--epi-color);
            color: var(--text-color);
        }

        .collaborator-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .collaborator-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .collaborator-actions {
            display: flex;
            gap: 8px;
        }

        /* ============================================
           CERTIFICADOS
           ============================================ */
        .certificate-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--epi-color);
            color: var(--text-color);
        }

        /* ============================================
           VALIDADE
           ============================================ */
        .validity-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid var(--epi-color);
            color: var(--text-color);
        }

        .validity-item.expiring {
            border-left-color: var(--warning-color);
            background-color: rgba(243, 156, 18, 0.1);
        }

        .validity-item.expired {
            border-left-color: var(--danger-color);
            background-color: rgba(231, 76, 60, 0.1);
        }

        .days-left {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 14px;
        }

        .days-left.expired {
            background-color: var(--danger-color);
            color: white;
        }

        .days-left.expiring {
            background-color: var(--warning-color);
            color: white;
        }

        .days-left.ok {
            background-color: var(--success-color);
            color: white;
        }

        /* ============================================
           FOOTER
           ============================================ */
        .site-footer {
            background-color: var(--primary-color);
            color: white;
            padding: 20px;
            text-align: center;
            margin-top: 40px;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        .footer-version {
            margin-top: 10px;
            font-size: 14px;
            opacity: 0.8;
        }

        /* ============================================
           BARRA DE PESQUISA
           ============================================ */
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }

        .search-box input {
            padding-left: 40px;
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-color);
        }

        /* ============================================
           CORREÇÕES DE COR
           ============================================ */
        #epiModalBody .form-group label,
        #epiModalBody label,
        #epiModalBody .required::after,
        #epiModalBody h3,
        #epiModalBody h4,
        #epiModalBody p,
        #epiModalBody strong {
            color: var(--text-color) !important;
        }

        .tab-content,
        .tab-content *:not(.btn):not(.btn *):not(.status-badge):not(.status-badge *):not(.notification):not(.notification *) {
            color: var(--text-color) !important;
        }

        .tab-content input,
        .tab-content select,
        .tab-content textarea {
            background-color: white !important;
            color: var(--text-color) !important;
            border: 1px solid var(--border-color) !important;
        }

        .tab-content label,
        .tab-content .form-group label,
        .tab-content .section-title,
        .tab-content .card-title {
            color: var(--text-color) !important;
            font-weight: 500 !important;
        }

        /* ============================================
           QR CODE
           ============================================ */
        .qrcode-container {
            text-align: center;
            padding: 20px;
        }

        .qrcode-container canvas {
            max-width: 200px;
            max-height: 200px;
            margin: 0 auto 20px;
        }

        /* ============================================
           BOTÕES PEQUENOS
           ============================================ */
        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
            border-radius: 6px;
        }

        /* ============================================
           CORREÇÕES ESPECÍFICAS PARA MODAIS
           ============================================ */
        .modal-body,
        .modal-body *:not(.btn):not(.btn *):not(.status-badge):not(.status-badge *) {
            color: var(--text-color) !important;
        }

        .modal-body label,
        .modal-body .form-group label {
            color: var(--text-color) !important;
            font-weight: 500 !important;
        }

        .modal-body input,
        .modal-body select,
        .modal-body textarea {
            background-color: white !important;
            color: var(--text-color) !important;
            border: 1px solid var(--border-color) !important;
        }

        .modal-body input::placeholder,
        .modal-body select::placeholder,
        .modal-body textarea::placeholder {
            color: var(--gray-color) !important;
        }

        .modal-body h3,
        .modal-body h4,
        .modal-body p,
        .modal-body strong {
            color: var(--text-color) !important;
        }

        /* Correção específica para o formulário de colaborador */
        #collaboratorModal .modal-body * {
            color: var(--text-color) !important;
        }

        #collaboratorModal label,
        #collaboratorModal input,
        #collaboratorModal select,
        #collaboratorModal textarea {
            color: var(--text-color) !important;
        }

        #collaboratorModal label.required::after {
            color: var(--danger-color) !important;
        }

        /* ============================================
           CHECKBOXES PARA SELEÇÃO MÚLTIPLA
           ============================================ */
        .select-all-checkbox {
            margin-right: 8px;
        }

        .epi-checkbox {
            margin: 0;
        }

        /* ============================================
           NOVA ABA: DEVOLUÇÃO DE EPI
           ============================================ */
        .return-epi-container {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
        }

        .assigned-epi-list {
            margin-top: 20px;
        }

        .epi-return-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid var(--epi-color);
            transition: all 0.3s ease;
        }

        .epi-return-item:hover {
            background-color: #e9ecef;
            transform: translateX(5px);
        }

        .epi-return-item.selected {
            border-left-color: var(--success-color);
            background-color: rgba(39, 174, 96, 0.1);
        }

        .epi-return-item .epi-info {
            flex: 1;
        }

        .epi-return-item .epi-info h4 {
            margin-bottom: 5px;
            color: var(--primary-color);
        }

        .epi-return-item .epi-details {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            font-size: 13px;
            color: var(--gray-color);
        }

        .epi-return-item .select-checkbox {
            margin-right: 15px;
        }

        .epi-return-item .days-left {
            margin-left: auto;
            margin-right: 15px;
        }

        .no-assignments-message {
            text-align: center;
            padding: 40px;
            color: var(--gray-color);
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .return-actions {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
    </style>
</head>

<body>
    <!-- TELA DE LOGIN -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <div class="login-logo-fw">
                    <img src="FW Logo.png" alt="FW Logo">
                </div>
                <h1 class="login-title">Sistema de Gestão de EPIs</h1>
                <p class="login-subtitle">Faça login para acessar o sistema</p>
            </div>

            <div class="login-error" id="loginError">
                <i class="fas fa-exclamation-circle"></i> Credenciais inválidas. Tente novamente.
            </div>

            <div class="login-form">
                <div class="form-group">
                    <label for="loginEmail">Email ou Usuário</label>
                    <input type="text" id="loginEmail" placeholder="Digite seu email ou usuário">
                </div>

                <div class="form-group">
                    <label for="loginPassword">Senha</label>
                    <input type="password" id="loginPassword" placeholder="Digite sua senha">
                </div>

                <button type="button" class="login-btn" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i> Entrar no Sistema
                </button>

                <div style="margin-top: 20px; text-align: center;">
                    <p style="font-size: 14px; opacity: 0.9;">Credenciais de exemplo:</p>
                    <div
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
                        <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px;">
                            <span style="font-size: 12px; display: block;">DEV (Acesso Total)</span>
                            <span style="font-size: 0px;">fabio@fwcompany.com.br / FabioFW123@</span>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px;">
                            <span style="font-size: 12px; display: block;">Segurança</span>
                            <span style="font-size: 0px;">seguranca@fwcompany.com.br / Seguranca123@</span>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px;">
                            <span style="font-size: 12px; display: block;">Almoxarife</span>
                            <span style="font-size: 0px;">almoxarife@fwcompany.com.br / Almoxarife123@</span>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px;">
                            <span style="font-size: 12px; display: block;">Colaborador</span>
                            <span style="font-size: 0px;">colaborador@fwcompany.com.br / Colaborador123@</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="login-footer">
                <div class="login-logo-delservin">
                    <img src="Delservin Logo.png" alt="Delservin Logo">
                </div>
                <div class="login-logo-altercon">
                    <img src="Altercon Logo.png" alt="Altercon Logo">
                </div>
            </div>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboardScreen" class="dashboard-container" style="display: none;">
        <header class="dashboard-header">
            <div class="user-info">
                <div class="user-welcome">
                    <i class="fas fa-user"></i>
                    <span id="userWelcomeText">Bem-vindo!</span>
                    <span class="user-badge" id="userRoleBadge">DEV</span>
                </div>
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </button>
            </div>

            <div class="header-top">
                <div class="logo-fw">
                    <img src="FW Logo.png" alt="FW Logo">
                </div>

                <div class="header-center">
                    <h1 class="project-title">Sistema de Gestão de EPIs</h1>
                    <p class="project-subtitle">Conformidade NR-6 | Controle e Validade de Equipamentos de Proteção
                        Individual</p>
                </div>

                <div class="header-right">
                    <div class="logo-right logo-delservin">
                        <img src="Delservin Logo.png" alt="Delservin Logo">
                    </div>
                    <div class="logo-right logo-altercon">
                        <img src="Altercon Logo.png" alt="Altercon Logo">
                    </div>
                </div>
            </div>

            <div class="project-info">
                <div class="info-item">
                    <div class="info-label">Total de EPIs</div>
                    <div class="info-value" id="totalEpis">0</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Colaboradores</div>
                    <div class="info-value" id="totalColaboradores">0</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Vencendo</div>
                    <div class="info-value">
                        <span class="status-badge status-delayed" id="expiringCount">0</span>
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label">Conformidade</div>
                    <div class="info-value">
                        <span class="status-badge status-completed" id="complianceRate">100%</span>
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label">Última Atualização</div>
                    <div class="info-value" id="lastUpdate">Hoje</div>
                </div>
            </div>
        </header>

        <!-- ABAS -->
        <div class="tabs-container">
            <div class="tabs-header">
                <button class="tab-button active" data-tab="dashboard">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </button>
                <button class="tab-button" data-tab="cadastro-epi">
                    <i class="fas fa-hard-hat"></i> Cadastro de EPI
                </button>
                <button class="tab-button" data-tab="controle-colaborador">
                    <i class="fas fa-users"></i> Controle por Colaborador
                </button>
                <button class="tab-button" data-tab="devolucao-epi">
                    <i class="fas fa-undo-alt"></i> Devolução de EPI
                </button>
                <button class="tab-button" data-tab="termo-responsabilidade">
                    <i class="fas fa-file-signature"></i> Termo de Responsabilidade
                </button>
                <button class="tab-button" data-tab="certificados-laudos">
                    <i class="fas fa-file-certificate"></i> Certificados e Laudos
                </button>
                <button class="tab-button" data-tab="cadastro-avarias">
                    <i class="fas fa-exclamation-triangle"></i> Cadastro de Avarias
                </button>
                <button class="tab-button" data-tab="catalogo">
                    <i class="fas fa-list"></i> Catálogo de EPIs
                </button>
                <button class="tab-button" data-tab="database">
                    <i class="fas fa-database"></i> Banco de Dados
                </button>
            </div>

            <!-- ABA 1: DASHBOARD -->
            <div id="dashboard" class="tab-content active">
                <h2 class="section-title"><i class="fas fa-chart-line"></i> Dashboard de EPIs</h2>

                <div class="cards-container">
                    <div class="card">
                        <h3 class="card-title"><i class="fas fa-exclamation-triangle"></i> EPIs Vencendo (30 dias)</h3>
                        <div id="expiringEpiList">
                            <p style="text-align: center; color: var(--gray-color); padding: 20px 0;">Carregando
                                dados...</p>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="card-title"><i class="fas fa-helmet-safety"></i> Status dos EPIs</h3>
                        <div class="progress-container">
                            <div class="progress-label">
                                <span>Conforme</span>
                                <span id="conformePercent">0%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill actual" id="conformeBar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="progress-container">
                            <div class="progress-label">
                                <span>Vencendo</span>
                                <span id="vencendoPercent">0%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill planned" id="vencendoBar"
                                    style="width: 0%; background-color: var(--warning-color)"></div>
                            </div>
                        </div>
                        <div class="progress-container">
                            <div class="progress-label">
                                <span>Vencidos</span>
                                <span id="vencidosPercent">0%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="vencidosBar"
                                    style="width: 0%; background-color: var(--danger-color)"></div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="card-title"><i class="fas fa-users"></i> Colaboradores por Setor</h3>
                        <div id="sectorStats">
                            <p style="text-align: center; color: var(--gray-color); padding: 20px 0;">Carregando
                                dados...</p>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <h3 class="chart-title"><i class="fas fa-chart-bar"></i> Distribuição de EPIs por Categoria</h3>
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>

            <!-- ABA 2: CADASTRO DE EPI -->
            <div id="cadastro-epi" class="tab-content">
                <h2 class="section-title"><i class="fas fa-hard-hat"></i> Cadastrar Novo EPI</h2>

                <div class="sync-buttons-container">
                    <button class="sync-btn sync-btn-cloud" id="syncEpiBtn">
                        <i class="fas fa-cloud-upload"></i> Subir EPIs na Nuvem
                    </button>
                    <button class="sync-btn sync-btn-success" id="downloadEpiBtn">
                        <i class="fas fa-cloud-download"></i> Baixar EPIs da Nuvem
                    </button>
                    <span class="sync-status" id="epiSyncStatus">Offline</span>
                </div>

                <div class="form-container">
                    <form id="epiForm">
                        <div class="form-section">
                            <h3 class="form-section-title"><i class="fas fa-info-circle"></i> Informações do EPI</h3>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="epiName" class="required">Nome do EPI</label>
                                    <input type="text" id="epiName" required placeholder="Ex: Capacete de Segurança">
                                </div>
                                <div class="form-group">
                                    <label for="caNumber" class="required">Nº do CA (Certificado de Aprovação)</label>
                                    <input type="text" id="caNumber" required placeholder="Ex: CA-12345">
                                </div>
                            </div>
                        </div>

                        <div class="separator"></div>

                        <div class="form-section">
                            <h3 class="form-section-title"><i class="fas fa-check-circle"></i> Conformidade NR-6</h3>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="conformity" class="required">Conformidade NR-6</label>
                                    <select id="conformity" required>
                                        <option value="">Selecione</option>
                                        <option value="Conforme">Conforme</option>
                                        <option value="Não Conforme">Não Conforme</option>
                                        <option value="Em Análise">Em Análise</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="inspectionObservations">Observações da Inspeção</label>
                                    <textarea id="inspectionObservations" rows="3"
                                        placeholder="Observações sobre a inspeção..."></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="separator"></div>

                        <div class="form-section">
                            <h3 class="form-section-title"><i class="fas fa-info-circle"></i> Informações Adicionais
                            </h3>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="status" class="required">Status</label>
                                    <select id="status" required>
                                        <option value="">Selecione</option>
                                        <option value="Disponível">Disponível</option>
                                        <option value="Em Uso">Em Uso</option>
                                        <option value="Manutenção">Manutenção</option>
                                        <option value="Danificado">Danificado</option>
                                        <option value="Descartado">Descartado</option>
                                        <option value="Vencido">Vencido</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="quantity">Quantidade em Estoque</label>
                                    <input type="number" id="quantity" min="1" value="1">
                                </div>
                                <div class="form-group">
                                    <label for="code" class="required">Código</label>
                                    <input type="text" id="code" required placeholder="Ex: EPI-CAP-001">
                                </div>
                            </div>
                        </div>

                        <div class="separator"></div>

                        <div class="form-section">
                            <h3 class="form-section-title"><i class="fas fa-tags"></i> Categoria e Fabricante</h3>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="category" class="required">Categoria</label>
                                    <select id="category" required>
                                        <option value="">Selecione uma categoria</option>
                                        <option value="Proteção da Cabeça">Proteção da Cabeça</option>
                                        <option value="Proteção Auditiva">Proteção Auditiva</option>
                                        <option value="Proteção Respiratória">Proteção Respiratória</option>
                                        <option value="Proteção Visual">Proteção Visual</option>
                                        <option value="Proteção das Mãos">Proteção das Mãos</option>
                                        <option value="Proteção dos Pés">Proteção dos Pés</option>
                                        <option value="Proteção Contra Quedas">Proteção Contra Quedas</option>
                                        <option value="Vestimentas de Proteção">Vestimentas de Proteção</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="manufacturer">Fabricante</label>
                                    <input type="text" id="manufacturer" placeholder="Nome do fabricante">
                                </div>
                            </div>
                        </div>

                        <div class="separator"></div>

                        <div class="form-section">
                            <h3 class="form-section-title"><i class="fas fa-calendar-alt"></i> Data da Última Inspeção
                            </h3>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="inspectionDate">Data da Última Inspeção</label>
                                    <input type="date" id="inspectionDate" value="">
                                </div>
                                <div class="form-group">
                                    <label for="nextInspectionDate">Vencimento</label>
                                    <input type="date" id="nextInspectionDate">
                                </div>
                                <div class="form-group">
                                    <label for="stockMin">Estoque Mínimo</label>
                                    <input type="number" id="stockMin" min="0" value="0">
                                </div>
                            </div>
                        </div>

                        <div class="separator"></div>

                        <div class="form-section">
                            <h3 class="form-section-title"><i class="fas fa-image"></i> Fotografia do EPI</h3>

                            <div class="image-capture-container">
                                <div class="camera-area" id="cameraArea">
                                    <div class="camera-placeholder" id="cameraPlaceholder">
                                        <i class="fas fa-camera"></i>
                                        <p>Clique para adicionar uma fotografia do EPI</p>
                                        <p style="font-size: 12px; margin-top: 10px;">Formatos aceitos: JPG, PNG, GIF
                                        </p>
                                    </div>
                                    <img id="epiImagePreview" style="display: none; max-width: 100%; max-height: 100%;">
                                </div>

                                <div class="camera-controls">
                                    <button type="button" class="btn btn-primary" id="takePhotoBtn">
                                        <i class="fas fa-camera"></i> Tirar Foto
                                    </button>
                                    <button type="button" class="btn btn-secondary" id="uploadPhotoBtn">
                                        <i class="fas fa-upload"></i> Carregar Imagem
                                    </button>
                                    <button type="button" class="btn btn-warning" id="clearPhotoBtn"
                                        style="display: none;">
                                        <i class="fas fa-times"></i> Remover Foto
                                    </button>
                                </div>

                                <input type="file" id="imageFileInput" accept="image/*" style="display: none;">
                                <input type="hidden" id="epiImageBase64">
                            </div>
                        </div>

                        <div class="separator"></div>

                        <div class="form-section">
                            <h3 class="form-section-title"><i class="fas fa-list"></i> Cadastro em Lote (Itens
                                Adicionais)</h3>
                            <p style="margin-bottom: 15px; color: var(--gray-color); font-size: 14px;">
                                Adicione itens em lote com códigos diferentes (opcional)
                            </p>

                            <div class="table-container">
                                <table class="batch-table" id="batchTable">
                                    <thead>
                                        <tr>
                                            <th>Código</th>
                                            <th>Quantidade</th>
                                            <th>Observações</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="batchTableBody">
                                        <!-- Linhas serão adicionadas aqui -->
                                    </tbody>
                                </table>
                            </div>

                            <button type="button" class="btn add-row-btn" id="addBatchRowBtn">
                                <i class="fas fa-plus"></i> Adicionar Item em Lote
                            </button>
                        </div>

                        <!-- BOTÕES DE AÇÃO -->
                        <div class="btn-group" style="margin-top: 30px;">
                            <button type="button" class="btn btn-success" id="saveEpiBtn">
                                <i class="fas fa-save"></i> Salvar EPI
                            </button>
                            <button type="button" class="btn btn-primary" id="saveAndAddBtn">
                                <i class="fas fa-plus-circle"></i> Salvar e Adicionar Outro
                            </button>
                            <button type="button" class="btn btn-warning" id="clearFormBtn">
                                <i class="fas fa-eraser"></i> Limpar Formulário
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- ABA 3: CONTROLE POR COLABORADOR -->
            <div id="controle-colaborador" class="tab-content">
                <h2 class="section-title"><i class="fas fa-users"></i> Controle de EPIs por Colaborador</h2>

                <div class="sync-buttons-container">
                    <button class="sync-btn sync-btn-cloud" id="syncCollaboratorsBtn">
                        <i class="fas fa-cloud-upload"></i> Subir Colaboradores na Nuvem
                    </button>
                    <button class="sync-btn sync-btn-success" id="downloadCollaboratorsBtn">
                        <i class="fas fa-cloud-download"></i> Baixar Colaboradores da Nuvem
                    </button>
                    <button class="sync-btn sync-btn-warning" id="syncAssignmentsBtn">
                        <i class="fas fa-sync-alt"></i> Sincronizar Atribuições
                    </button>
                    <span class="sync-status" id="collaboratorSyncStatus">Offline</span>
                </div>

                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchCollaborator"
                        placeholder="Buscar colaborador por nome, matrícula ou setor...">
                </div>

                <div class="btn-group" style="margin-bottom: 20px;">
                    <button type="button" class="btn btn-primary" id="addCollaboratorBtn">
                        <i class="fas fa-user-plus"></i> Adicionar Colaborador
                    </button>
                    <button type="button" class="btn btn-success" id="assignEpiBtn">
                        <i class="fas fa-hard-hat"></i> Atribuir EPI
                    </button>
                    <button type="button" class="btn btn-danger" id="deleteSelectedCollaboratorsBtn"
                        style="display: none;">
                        <i class="fas fa-trash"></i> Deletar Selecionados
                    </button>
                </div>

                <div id="collaboratorsList">
                    <p style="text-align: center; color: var(--gray-color); padding: 40px 0;">
                        Nenhum colaborador cadastrado. Clique em "Adicionar Colaborador" para começar.
                    </p>
                </div>
            </div>

            <!-- ABA 4: DEVOLUÇÃO DE EPI -->
            <div id="devolucao-epi" class="tab-content">
                <h2 class="section-title"><i class="fas fa-undo-alt"></i> Devolução de EPI</h2>

                <div class="sync-buttons-container">
                    <button class="sync-btn sync-btn-cloud" id="syncReturnsBtn">
                        <i class="fas fa-cloud-upload"></i> Subir Devoluções na Nuvem
                    </button>
                    <button class="sync-btn sync-btn-success" id="downloadReturnsBtn">
                        <i class="fas fa-cloud-download"></i> Baixar Devoluções da Nuvem
                    </button>
                    <button class="sync-btn sync-btn-warning" id="syncAllReturnsBtn">
                        <i class="fas fa-sync-alt"></i> Sincronizar Tudo
                    </button>
                    <span class="sync-status" id="returnSyncStatus">Offline</span>
                </div>

                <div class="return-epi-container">
                    <div class="form-section">
                        <h3 class="form-section-title"><i class="fas fa-user"></i> Selecione o Colaborador</h3>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="selectCollaboratorReturn" class="required">Colaborador</label>
                                <select id="selectCollaboratorReturn" class="required">
                                    <option value="">Selecione um colaborador</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="returnDate">Data de Devolução</label>
                                <input type="date" id="returnDate" value="">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="returnReason" class="required">Motivo da Devolução</label>
                                <select id="returnReason" class="required">
                                    <option value="">Selecione o motivo</option>
                                    <option value="Troca de EPI">Troca de EPI</option>
                                    <option value="Fim da Validade">Fim da Validade</option>
                                    <option value="Danificado">Danificado</option>
                                    <option value="Desgaste Natural">Desgaste Natural</option>
                                    <option value="Demissão/Afastamento">Demissão/Afastamento</option>
                                    <option value="Troca de Função">Troca de Função</option>
                                    <option value="Outro">Outro</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="returnObservations">Observações</label>
                                <textarea id="returnObservations" rows="3"
                                    placeholder="Observações sobre a devolução..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="assigned-epi-list" id="assignedEpiList">
                        <h3 class="form-section-title"><i class="fas fa-hard-hat"></i> EPIs Atribuídos ao Colaborador
                        </h3>
                        <div class="no-assignments-message">
                            <i class="fas fa-info-circle" style="font-size: 40px; margin-bottom: 15px;"></i>
                            <p>Selecione um colaborador para visualizar os EPIs atribuídos.</p>
                        </div>
                    </div>

                    <div class="return-actions" style="display: none;" id="returnActions">
                        <h3 class="form-section-title"><i class="fas fa-check-circle"></i> Confirmar Devolução</h3>
                        <div class="form-group">
                            <label for="returnCondition">Condição do EPI</label>
                            <select id="returnCondition" class="required">
                                <option value="">Selecione a condição</option>
                                <option value="Bom">Bom estado</option>
                                <option value="Regular">Estado regular</option>
                                <option value="Ruim">Estado ruim</option>
                                <option value="Danificado">Danificado</option>
                                <option value="Extraviado">Extraviado</option>
                            </select>
                        </div>

                        <div class="btn-group">
                            <button type="button" class="btn btn-success" id="confirmReturnBtn">
                                <i class="fas fa-check"></i> Confirmar Devolução
                            </button>
                            <button type="button" class="btn btn-warning" id="clearReturnFormBtn">
                                <i class="fas fa-eraser"></i> Limpar Seleção
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ABA 5: TERMO DE RESPONSABILIDADE -->
            <div id="termo-responsabilidade" class="tab-content">
                <h2 class="section-title"><i class="fas fa-file-signature"></i> Termo de Responsabilidade</h2>

                <div class="termo-card">
                    <div class="termo-content">
                        <div style="text-align: center; margin-bottom: 30px;">
                            <h3 style="color: var(--primary-color);">TERMO DE RESPONSABILIDADE</h3>
                        </div>

                        <p style="text-indent: 40px; margin-bottom: 15px;">
                            Pelo presente, declaro que recebi da Empresa DELSERVIN o material especificado no verso,
                            assumindo o compromisso, nos termos das letras "a" e "b" do item 1.8 da NR – 1 e letras "a",
                            "b" e "c" do item 6.7.1 da NR – 6 da Portaria 3.214/78, de usá-lo em trabalho, zelar pela
                            sua guarda e conservação e devolve-lo ao setor competente da empresa, quando se tornar
                            impróprio para o uso ou por motivo de demissão ou afastamento.
                        </p>

                        <p style="text-indent: 40px; margin-bottom: 15px;">
                            Em caso de perda, extravio ou inutilização proposital do material recebido autoriza a
                            empresa na forma prevista no parágrafo primeiro do art. 462 da CLT – Consolidação das Leis
                            do Trabalho, a descontar de meu salário, inclusive no que me couber, a título de indenização
                            por rescisão de contrato de trabalho, a importância correspondente ao valor do material.
                        </p>

                        <p style="text-indent: 40px; margin-bottom: 15px;">
                            Declaro que no ato do recebimento dos equipamentos indicados neste campo, foi me dada a
                            orientação técnica e prática quanto ao seu uso, bem como quanto às condições e locais em que
                            os mesmos deverão ser utilizados.
                        </p>

                        <div style="text-align: center; margin-top: 50px;">
                            <p>De acordo,</p>
                            <div style="margin-top: 80px; text-align: center;">
                                _______________________________________
                            </div>
                            <p style="margin-top: 5px;">Assinatura do Funcionário</p>

                            <div style="margin-top: 40px;">
                                ____________, ____ de ____________ de _____.
                            </div>
                            <p style="margin-top: 5px;">(Data)</p>
                        </div>
                    </div>

                    <div class="btn-group" style="margin-top: 30px;">
                        <button type="button" class="btn btn-primary" id="printTermoBtn">
                            <i class="fas fa-print"></i> Imprimir Termo
                        </button>
                        <button type="button" class="btn btn-success" id="generateTermoBtn">
                            <i class="fas fa-file-pdf"></i> Gerar PDF
                        </button>
                    </div>
                </div>
            </div>

            <!-- ABA 6: CERTIFICADOS E LAUDOS -->
            <div id="certificados-laudos" class="tab-content">
                <h2 class="section-title"><i class="fas fa-file-certificate"></i> Certificados e Laudos</h2>

                <div class="form-container">
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-file-certificate"
                            style="font-size: 60px; color: var(--epi-color); margin-bottom: 20px;"></i>
                        <h3>Módulo de Certificados e Laudos</h3>
                        <p style="color: var(--gray-color); margin-top: 10px;">
                            Em desenvolvimento. Esta funcionalidade estará disponível em breve.
                        </p>
                    </div>
                </div>
            </div>

            <!-- ABA 7: CADASTRO DE AVARIAS -->
            <div id="cadastro-avarias" class="tab-content">
                <h2 class="section-title"><i class="fas fa-exclamation-triangle"></i> Cadastro de Avarias</h2>

                <div class="sync-buttons-container">
                    <button class="sync-btn sync-btn-cloud" id="syncDamagesBtn">
                        <i class="fas fa-cloud-upload"></i> Subir Avarias na Nuvem
                    </button>
                    <button class="sync-btn sync-btn-success" id="downloadDamagesBtn">
                        <i class="fas fa-cloud-download"></i> Baixar Avarias da Nuvem
                    </button>
                    <span class="sync-status" id="damageSyncStatus">Offline</span>
                </div>

                <div class="form-container">
                    <form id="damageForm">
                        <div class="form-section">
                            <h3 class="form-section-title"><i class="fas fa-info-circle"></i> Informações da Avaria</h3>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="damageEpiSelect" class="required">EPI Avariado</label>
                                    <select id="damageEpiSelect" required>
                                        <option value="">Selecione o EPI</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="damageDate" class="required">Data da Avaria</label>
                                    <input type="date" id="damageDate" required value="">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="damageReason" class="required">Motivo da Avaria</label>
                                    <select id="damageReason" required>
                                        <option value="">Selecione o motivo</option>
                                        <option value="Desgaste Natural">Desgaste Natural</option>
                                        <option value="Uso Inadequado">Uso Inadequado</option>
                                        <option value="Acidente">Acidente</option>
                                        <option value="Defeito de Fabricação">Defeito de Fabricação</option>
                                        <option value="Armazenamento Inadequado">Armazenamento Inadequado</option>
                                        <option value="Outro">Outro</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="damageResponsible" class="required">Responsável</label>
                                    <select id="damageResponsible" required>
                                        <option value="">Selecione o responsável</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="damageDescription" class="required">Descrição da Avaria</label>
                                <textarea id="damageDescription" rows="4" required
                                    placeholder="Descreva detalhadamente a avaria..."></textarea>
                            </div>

                            <div class="form-group">
                                <label for="damageSolution">Solução Aplicada</label>
                                <select id="damageSolution">
                                    <option value="">Selecione a solução</option>
                                    <option value="Reparo">Reparo</option>
                                    <option value="Substituição">Substituição</option>
                                    <option value="Descarte">Descarte</option>
                                    <option value="Enviado para Manutenção">Enviado para Manutenção</option>
                                    <option value="Aguardando Análise">Aguardando Análise</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="damageObservations">Observações Adicionais</label>
                                <textarea id="damageObservations" rows="3"
                                    placeholder="Observações complementares..."></textarea>
                            </div>
                        </div>

                        <div class="btn-group" style="margin-top: 30px;">
                            <button type="button" class="btn btn-success" id="saveDamageBtn">
                                <i class="fas fa-save"></i> Salvar Avaria
                            </button>
                            <button type="button" class="btn btn-warning" id="clearDamageBtn">
                                <i class="fas fa-eraser"></i> Limpar Formulário
                            </button>
                        </div>
                    </form>
                </div>

                <div style="margin-top: 40px;">
                    <h3 class="section-title"><i class="fas fa-history"></i> Histórico de Avarias</h3>

                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchDamage"
                            placeholder="Buscar avaria por EPI, motivo ou responsável...">
                    </div>

                    <div id="damageHistory">
                        <p style="text-align: center; color: var(--gray-color); padding: 40px 0;">
                            Nenhuma avaria registrada. Registre a primeira avaria acima.
                        </p>
                    </div>
                </div>
            </div>

            <!-- ABA 8: CATÁLOGO DE EPIs -->
            <div id="catalogo" class="tab-content">
                <h2 class="section-title"><i class="fas fa-list"></i> Catálogo de EPIs</h2>

                <div class="sync-buttons-container">
                    <button class="sync-btn sync-btn-cloud" id="syncCatalogBtn">
                        <i class="fas fa-cloud-upload"></i> Subir Catálogo na Nuvem
                    </button>
                    <button class="sync-btn sync-btn-success" id="downloadCatalogBtn">
                        <i class="fas fa-cloud-download"></i> Baixar Catálogo da Nuvem
                    </button>
                    <button class="sync-btn sync-btn-warning" id="syncCatalogAllBtn">
                        <i class="fas fa-sync-alt"></i> Sincronizar Completo
                    </button>
                    <button class="sync-btn sync-btn-primary" id="downloadBackupJsonBtn">
                        <i class="fas fa-download"></i> Baixar Backup em JSON
                    </button>
                    <span class="sync-status" id="catalogSyncStatus">Offline</span>
                </div>

                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchEpi" placeholder="Buscar por nome, código, CA ou categoria...">
                </div>

                <div class="btn-group" style="margin-bottom: 20px;">
                    <button type="button" class="btn btn-primary" id="filterAllEpiBtn">
                        <i class="fas fa-filter"></i> Todos
                    </button>
                    <button type="button" class="btn btn-success" id="filterAvailableEpiBtn">
                        <i class="fas fa-check-circle"></i> Disponíveis
                    </button>
                    <button type="button" class="btn btn-danger" id="deleteSelectedEpisBtn">
                        <i class="fas fa-trash"></i> Deletar Selecionados
                    </button>
                    <button type="button" class="btn btn-danger" id="exportEpiBtn">
                        <i class="fas fa-file-excel"></i> Exportar
                    </button>
                </div>

                <div class="table-container">
                    <table id="episTable">
                        <thead>
                            <tr>
                                <th>Sel</th>
                                <th>Código</th>
                                <th>Nome do EPI</th>
                                <th>Categoria</th>
                                <th>Nº CA</th>
                                <th>Status</th>
                                <th>Quantidade</th>
                                <th>Fabricante</th>
                                <th>Ações</th>
                                <th>IMG</th>
                                <th>Deletar</th>
                            </tr>
                        </thead>
                        <tbody id="episTableBody">
                            <tr>
                                <td colspan="10" style="text-align: center; padding: 40px; color: var(--gray-color);">
                                    Nenhum EPI cadastrado. Clique em "Cadastro de EPI" para adicionar.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ABA 9: BANCO DE DADOS -->
            <div id="database" class="tab-content">
                <h2 class="section-title"><i class="fas fa-database"></i> Banco de Dados Online</h2>

                <div class="form-container">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 25px;">
                        <div
                            style="width: 12px; height: 12px; border-radius: 50%; background-color: var(--success-color);">
                        </div>
                        <h3 id="dbStatusText">Status: <span id="connectionStatus">Online</span></h3>
                    </div>

                    <div style="margin-bottom: 30px;">
                        <h4 style="color: var(--primary-color); margin-bottom: 15px;">
                            <i class="fas fa-cloud"></i> Configuração Automática
                        </h4>

                        <div class="form-group">
                            <label>URL do Projeto</label>
                            <div
                                style="background-color: #f5f5f5; padding: 12px 15px; border-radius: 8px; border: 1px solid var(--border-color);">
                                <strong>https://nhhgjeywyqdcylkcproc.supabase.co</strong>
                                <p style="margin-top: 5px; font-size: 12px; color: var(--gray-color);">
                                    Configurada automaticamente no sistema
                                </p>
                            </div>
                        </div>
                    </div>

                    <div style="margin-bottom: 30px;">
                        <h4 style="color: var(--primary-color); margin-bottom: 15px;">
                            <i class="fas fa-sync-alt"></i> Sincronização por Módulo
                        </h4>

                        <p style="margin-bottom: 15px;">Gerencie a sincronização dos dados com a nuvem por módulo:</p>

                        <div class="btn-group" style="flex-wrap: wrap;">
                            <button type="button" class="btn btn-success" id="uploadEpisBtn">
                                <i class="fas fa-hard-hat"></i> Sincronizar EPIs
                            </button>
                            <button type="button" class="btn btn-success" id="uploadCollaboratorsBtn">
                                <i class="fas fa-users"></i> Sincronizar Colaboradores
                            </button>
                            <button type="button" class="btn btn-success" id="uploadAssignmentsBtn">
                                <i class="fas fa-exchange-alt"></i> Sincronizar Atribuições
                            </button>
                            <button type="button" class="btn btn-success" id="uploadReturnsBtn">
                                <i class="fas fa-undo-alt"></i> Sincronizar Devoluções
                            </button>
                            <button type="button" class="btn btn-success" id="uploadDamagesBtn">
                                <i class="fas fa-exclamation-triangle"></i> Sincronizar Avarias
                            </button>
                        </div>

                        <div class="btn-group" style="margin-top: 10px;">
                            <button type="button" class="btn btn-primary" id="uploadAllBtn">
                                <i class="fas fa-cloud-upload"></i> Subir Tudo na Nuvem
                            </button>
                            <button type="button" class="btn btn-warning" id="downloadAllBtn">
                                <i class="fas fa-cloud-download"></i> Baixar Tudo da Nuvem
                            </button>
                        </div>
                    </div>

                    <div>
                        <h4 style="color: var(--primary-color); margin-bottom: 15px;">
                            <i class="fas fa-info-circle"></i> Status da Conexão por Módulo
                        </h4>

                        <div id="connectionDetails">
                            <div
                                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                <div>
                                    <p><strong>EPIs:</strong> <span id="epiCount">0</span> itens</p>
                                    <p><strong>Colaboradores:</strong> <span id="collaboratorCount">0</span> itens</p>
                                    <p><strong>Atribuições:</strong> <span id="assignmentCount">0</span> itens</p>
                                    <p><strong>Devoluções:</strong> <span id="returnCount">0</span> itens</p>
                                    <p><strong>Avarias:</strong> <span id="damageCount">0</span> itens</p>
                                </div>
                                <div>
                                    <p><strong>Status da Nuvem:</strong> <span id="cloudStatus">Online</span></p>
                                    <p><strong>Última Sincronização:</strong> <span id="lastSync">Nunca</span></p>
                                    <p><strong>Modo de Operação:</strong> <span id="operationMode">Nuvem</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL PARA VISUALIZAR EPI -->
        <div id="epiModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Detalhes do EPI</h3>
                    <button class="modal-close" id="closeModalBtn">&times;</button>
                </div>
                <div class="modal-body" id="epiModalBody">
                    <!-- Conteúdo será preenchido via JavaScript -->
                </div>
            </div>
        </div>

        <!-- MODAL PARA CADASTRAR/EDITAR COLABORADOR -->
        <div id="collaboratorModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Cadastrar Colaborador</h3>
                    <button class="modal-close" id="closeCollaboratorModalBtn">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="collaboratorForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="collaboratorName" class="required">Nome Completo</label>
                                <input type="text" id="collaboratorName" required placeholder="Ex: João da Silva">
                            </div>
                            <div class="form-group">
                                <label for="collaboratorRegistration" class="required">Matrícula</label>
                                <input type="text" id="collaboratorRegistration" required placeholder="Ex: 00123">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="collaboratorSector" class="required">Setor</label>
                                <select id="collaboratorSector" required>
                                    <option value="">Selecione o setor</option>
                                    <option value="Produção">Produção</option>
                                    <option value="Manutenção">Manutenção</option>
                                    <option value="Administrativo">Administrativo</option>
                                    <option value="Logística">Logística</option>
                                    <option value="Qualidade">Qualidade</option>
                                    <option value="Segurança">Segurança</option>
                                    <option value="RH">RH</option>
                                    <option value="Financeiro">Financeiro</option>
                                    <option value="TI">TI</option>
                                    <option value="Outro">Outro</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="collaboratorPosition" class="required">Cargo</label>
                                <input type="text" id="collaboratorPosition" required
                                    placeholder="Ex: Operador de Máquinas">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="collaboratorAdmissionDate" class="required">Data de Admissão</label>
                                <input type="date" id="collaboratorAdmissionDate" required>
                            </div>
                            <div class="form-group">
                                <label for="collaboratorStatus" class="required">Status</label>
                                <select id="collaboratorStatus" required>
                                    <option value="Ativo">Ativo</option>
                                    <option value="Afastado">Afastado</option>
                                    <option value="Férias">Férias</option>
                                    <option value="Desligado">Desligado</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="collaboratorObservations">Observações</label>
                            <textarea id="collaboratorObservations" rows="3"
                                placeholder="Observações sobre o colaborador..."></textarea>
                        </div>

                        <div class="btn-group" style="margin-top: 20px;">
                            <button type="button" class="btn btn-success" id="saveCollaboratorBtn">
                                <i class="fas fa-save"></i> Salvar Colaborador
                            </button>
                            <button type="button" class="btn btn-warning" id="clearCollaboratorFormBtn">
                                <i class="fas fa-eraser"></i> Limpar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- MODAL PARA ATRIBUIR EPI -->
        <div id="assignEpiModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Atribuir EPI a Colaborador</h3>
                    <button class="modal-close" id="closeAssignEpiModalBtn">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="assignEpiForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="assignCollaborator" class="required">Colaborador</label>
                                <select id="assignCollaborator" required>
                                    <option value="">Selecione o colaborador</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="assignEpi" class="required">EPI</label>
                                <select id="assignEpi" required>
                                    <option value="">Selecione o EPI</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="assignDate" class="required">Data de Atribuição</label>
                                <input type="date" id="assignDate" required>
                            </div>
                            <div class="form-group">
                                <label for="assignExpirationDate" class="required">Data de Validade</label>
                                <input type="date" id="assignExpirationDate" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="assignObservations">Observações</label>
                            <textarea id="assignObservations" rows="3"
                                placeholder="Observações sobre a atribuição..."></textarea>
                        </div>

                        <div class="btn-group" style="margin-top: 20px;">
                            <button type="button" class="btn btn-success" id="saveAssignmentBtn">
                                <i class="fas fa-save"></i> Salvar Atribuição
                            </button>
                            <button type="button" class="btn btn-warning" id="clearAssignmentFormBtn">
                                <i class="fas fa-eraser"></i> Limpar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- INPUTS OCULTOS -->
        <input type="file" id="imageFileInputGlobal" accept="image/*" style="display: none;">
        <input type="file" id="pdfFileInput" accept=".pdf" style="display: none;">
    </div>

    <footer class="site-footer">
        <div class="footer-content">
            <p>Desenvolvido por Fábio Mendes Rodrigues, Planejador da F.W. Company</p>
            <p class="footer-version">Sistema de Gestão de EPIs - Revisão 02</p>
        </div>
    </footer>

    <script>
        // ============================================
        // SISTEMA DE GESTÃO DE EPIs - VERSÃO 3.0
        // COM SINCRONIZAÇÃO MODULAR POR ABA
        // ============================================

        // CONFIGURAÇÃO DO SUPABASE
        const SUPABASE_URL = 'https://nhhgjeywyqdcylkcproc.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5oaGdqZXl3eXFkY3lsa2Nwcm9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTEzNTgsImV4cCI6MjA4MzE4NzM1OH0.DBca5su0JNNQWYDrbNy4sk5c-g3tDOqqerHFWwAc-Dk';

        // DADOS DE USUÁRIOS
        const users = {
            'fabio@fwcompany.com.br': {
                password: 'FabioFW123@',
                role: 'dev',
                name: 'Fábio Mendes',
                email: 'fabio@fwcompany.com.br'
            },
            'raquel@fwcompany.com.br': {
                password: 'RaqueL1234',
                role: 'dev',
                name: 'Raquel',
                email: 'raquel@fwcompany.com.br'
            },
            'seguranca@fwcompany.com.br': {
                password: 'Seguranca123@',
                role: 'seguranca',
                name: 'Responsável Segurança',
                email: 'seguranca@fwcompany.com.br'
            },
            'almoxarife@fwcompany.com.br': {
                password: 'Almoxarife123@',
                role: 'almoxarife',
                name: 'Almoxarife',
                email: 'almoxarife@fwcompany.com.br'
            },
            'colaborador@fwcompany.com.br': {
                password: 'Colaborador123@',
                role: 'colaborador',
                name: 'Colaborador',
                email: 'colaborador@fwcompany.com.br'
            }
        };

        // ============================================
        // VARIÁVEIS E FUNÇÕES SUPABASE
        // ============================================
        let supabaseClient = null;
        let isSupabaseConnected = false;
        let lastSyncTimes = {
            epis: null,
            collaborators: null,
            assignments: null,
            returns: null,
            damages: null,
            catalog: null
        };

        // ============================================
        // ESTADO DA APLICAÇÃO
        // ============================================
        let currentUser = null;
        let epis = [];
        let collaborators = [];
        let assignments = [];
        let certificates = [];
        let damages = [];
        let currentStorageType = 'localStorage';
        let editingCollaboratorId = null;

        // FLAG PARA CONTROLE DE BACKUP
        let backupInProgress = false;

        // ============================================
        // FUNÇÕES SUPABASE
        // ============================================
        async function initializeSupabase() {
            try {
                console.log('🔗 Conectando ao Supabase...');

                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

                const { data, error } = await supabaseClient
                    .from('epis')
                    .select('codigo')  // Usar 'codigo' em vez de 'id'
                    .limit(1);

                if (error) {
                    console.error('❌ Erro na conexão com Supabase:', error);
                    isSupabaseConnected = false;
                    updateAllSyncStatuses('offline');
                } else {
                    console.log('✅ Conexão com Supabase estabelecida');
                    isSupabaseConnected = true;
                    updateAllSyncStatuses('online');
                }

            } catch (error) {
                console.error('❌ Erro ao inicializar Supabase:', error);
                isSupabaseConnected = false;
                updateAllSyncStatuses('offline');
            }
        }

        function updateAllSyncStatuses(status) {
            const statusElements = [
                'epiSyncStatus',
                'collaboratorSyncStatus',
                'returnSyncStatus',
                'damageSyncStatus',
                'catalogSyncStatus'
            ];

            statusElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = status === 'online' ? 'Online' : 'Offline';
                    element.className = `sync-status ${status}`;
                }
            });

            const cloudStatusElement = document.getElementById('cloudStatus');
            if (cloudStatusElement) {
                cloudStatusElement.textContent = status === 'online' ? 'Online' : 'Offline';
            }
        }

        // ============================================
        // FUNÇÃO PARA UPLOAD DE IMAGEM PARA STORAGE
        // ============================================
        async function uploadImageToStorage(imageBase64, code) {
            if (!imageBase64 || !code || !isSupabaseConnected) {
                console.log('⚠️ Não foi possível fazer upload: dados incompletos');
                return null;
            }

            try {
                console.log('📤 Iniciando upload da imagem para o Storage...');

                // Converter base64 para blob
                const base64Response = await fetch(imageBase64);
                const blob = await base64Response.blob();

                // Criar nome único do arquivo
                const fileName = `epi_${code}_${Date.now()}.jpg`;
                console.log(`📁 Nome do arquivo: ${fileName}`);

                // Fazer upload para o bucket 'epi-images'
                const { data: uploadData, error: uploadError } = await supabaseClient
                    .storage
                    .from('epi-images')
                    .upload(fileName, blob, {
                        contentType: 'image/jpeg',
                        upsert: true
                    });

                if (uploadError) {
                    console.error('❌ Erro no upload:', uploadError);
                    throw uploadError;
                }

                console.log('✅ Upload concluído:', uploadData);

                // Obter URL pública da imagem
                const { data: urlData } = supabaseClient
                    .storage
                    .from('epi-images')
                    .getPublicUrl(fileName);

                const publicUrl = urlData.publicUrl;
                console.log('🔗 URL pública:', publicUrl);

                return publicUrl;

            } catch (error) {
                console.error('❌ Erro ao fazer upload da imagem:', error);
                return null;
            }
        }

        async function downloadEpisFromCloud() {
            if (!isSupabaseConnected || !supabaseClient) {
                showNotification('Sem conexão com a nuvem. Verifique sua conexão.', 'error');
                return;
            }

            try {
                showNotification('Baixando EPIs da nuvem...', 'info');

                const { data, error } = await supabaseClient
                    .from('epis')
                    .select('*')
                    .order('codigo');

                if (error) {
                    throw error;
                }

                if (data && data.length > 0) {
                    epis = data.map(item => ({
                        id: item.id || Date.now(),
                        name: item.nome_epi,
                        code: item.codigo,
                        category: item.categoria,
                        caNumber: item.ca_numero,
                        manufacturer: item.fabricante,
                        status: item.status,
                        quantity: item.quantidade,
                        conformity: item.conformidade_nr6,
                        inspectionObservations: item.observacoes,
                        inspectionDate: item.ultima_inspecao,
                        nextInspectionDate: item.proxima_inspecao,
                        stockMin: item.estoque_minimo,
                        dataCadastro: item.data_cadastro,
                        usuarioCadastro: item.usuario_cadastro,
                        createdAt: item.created_at || new Date().toISOString(),
                        image: item.imagem || ''
                    }));

                    await saveAllData();
                    loadEpisList();
                    updateDashboardStats();

                    showNotification(`✅ ${data.length} EPI(s) baixado(s) da nuvem`, 'success');
                } else {
                    showNotification('Nenhum EPI encontrado na nuvem.', 'warning');
                }

                lastSyncTimes.epis = new Date();
                updateLastSyncDisplay();

            } catch (error) {
                console.error('Erro ao baixar EPIs da nuvem:', error);
                showNotification('❌ Erro ao baixar EPIs da nuvem.', 'error');
            }
        }

        // ============================================
        // SINCRONIZAÇÃO DE EPIs
        // ============================================
        async function syncEpisToCloud() {
            console.log('🔄 ========== syncEpisToCloud INICIADA ==========');

            if (!isSupabaseConnected || !supabaseClient) {
                console.log('❌ Sem conexão com Supabase');
                showNotification('Sem conexão com a nuvem. Verifique sua conexão.', 'error');
                return;
            }

            try {
                showNotification('Enviando EPIs para a nuvem...', 'info');

                let successCount = 0;
                let errorCount = 0;

                console.log(`📊 Total de EPIs: ${epis.length}`);

                for (const epi of epis) {
                    console.log(`\n--- Processando EPI: ${epi.code} ---`);
                    console.log(`📝 Tem imagem? ${!!epi.image}`);

                    if (epi.image) {
                        console.log(`📸 Tipo: ${epi.image.substring(0, 50)}...`);
                        console.log(`📏 Tamanho base64: ${epi.image.length} caracteres`);
                    }

                    let imageUrl = null;

                    // Verificar se a imagem já está na nuvem (é uma URL)
                    if (epi.image && epi.image.startsWith('http')) {
                        console.log(`🔗 Imagem já é URL: ${epi.image}`);
                        imageUrl = epi.image;
                    } else if (epi.image && epi.image.startsWith('data:image')) {
                        // Se for base64, verificar se já existe no storage
                        console.log('📤 Verificando se imagem já foi enviada...');

                        // Gerar nome de arquivo previsível
                        const fileName = `epi_${epi.code}.jpg`;

                        // Verificar se o arquivo já existe no bucket
                        try {
                            const { data: fileExists } = await supabaseClient
                                .storage
                                .from('epi-images')
                                .list('', {
                                    search: fileName
                                });

                            if (fileExists && fileExists.length > 0) {
                                // Arquivo já existe, usar URL existente
                                const { data: urlData } = supabaseClient
                                    .storage
                                    .from('epi-images')
                                    .getPublicUrl(fileName);

                                imageUrl = urlData.publicUrl;
                                console.log(`✅ Usando imagem existente: ${imageUrl}`);

                                // Atualizar o EPI local com a URL para evitar reuploads futuros
                                const epiIndex = epis.findIndex(e => e.id === epi.id);
                                if (epiIndex !== -1) {
                                    epis[epiIndex].image = imageUrl;
                                }
                            } else {
                                // Fazer upload da nova imagem
                                console.log('🔄 Fazendo upload de nova imagem...');
                                imageUrl = await uploadImageToStorage(epi.image, epi.code);
                                console.log(`📸 Nova imagem: ${imageUrl}`);
                            }
                        } catch (error) {
                            console.error('Erro ao verificar imagem:', error);
                            // Tentar upload de qualquer forma
                            imageUrl = await uploadImageToStorage(epi.image, epi.code);
                        }
                    } else {
                        console.log('📭 Sem imagem para este EPI');
                    }

                    const supabaseData = {
                        codigo: epi.code,
                        nome_epi: epi.name,
                        categoria: epi.category,
                        ca_numero: epi.caNumber,
                        fabricante: epi.manufacturer || '',
                        status: epi.status,
                        quantidade: epi.quantity,
                        conformidade_nr6: epi.conformity,
                        observacoes: epi.inspectionObservations || '',
                        ultima_inspecao: epi.inspectionDate || null,
                        proxima_inspecao: epi.nextInspectionDate || null,
                        estoque_minimo: epi.stockMin || 0,
                        imagem: imageUrl,
                        data_cadastro: epi.dataCadastro || new Date().toISOString().split('T')[0],
                        usuario_cadastro: epi.usuarioCadastro || 'Sistema',
                        updated_at: new Date().toISOString()
                    };

                    console.log('📦 Dados sendo enviados:');
                    console.log(JSON.stringify({
                        codigo: supabaseData.codigo,
                        nome: supabaseData.nome_epi,
                        imagem: supabaseData.imagem ? 'URL/Base64 presente' : 'NULL',
                        imagem_tipo: supabaseData.imagem ?
                            (supabaseData.imagem.startsWith('http') ? 'URL' : 'Base64') :
                            'Nenhuma'
                    }, null, 2));

                    console.log('🔄 Enviando para Supabase...');
                    const { error } = await supabaseClient
                        .from('epis')
                        .upsert(supabaseData, {
                            onConflict: 'codigo'
                        });

                    if (error) {
                        console.error(`❌ Erro no EPI ${epi.code}:`, error);
                        errorCount++;
                    } else {
                        console.log(`✅ EPI ${epi.code} enviado com sucesso!`);
                        successCount++;
                    }
                }

                console.log(`\n📈 RESULTADO: ${successCount} sucesso(s), ${errorCount} erro(s)`);

                lastSyncTimes.epis = new Date();
                updateLastSyncDisplay();

                showNotification(`✅ ${successCount} EPI(s) enviado(s) para a nuvem${errorCount > 0 ? ` (${errorCount} erros)` : ''}`, 'success');

            } catch (error) {
                console.error('❌ Erro geral em syncEpisToCloud:', error);
                showNotification('❌ Erro ao enviar EPIs para a nuvem.', 'error');
            }

            console.log('========== syncEpisToCloud FINALIZADA ==========\n');
        }

        // ============================================
        // SINCRONIZAÇÃO DE COLABORADORES
        // ============================================
        async function syncCollaboratorsToCloud() {
            if (!isSupabaseConnected || !supabaseClient) {
                showNotification('Sem conexão com a nuvem. Verifique sua conexão.', 'error');
                return;
            }

            try {
                showNotification('Enviando colaboradores para a nuvem...', 'info');

                let successCount = 0;
                let errorCount = 0;

                for (const collaborator of collaborators) {
                    const supabaseData = {
                        nome: collaborator.name,
                        matricula: collaborator.registration,
                        setor: collaborator.sector,
                        cargo: collaborator.position,
                        data_admissao: collaborator.admissionDate,
                        status: collaborator.status,
                        observacoes: collaborator.observations || '',
                        usuario_cadastro: currentUser?.name || 'Sistema',
                        updated_at: new Date().toISOString()
                    };

                    const { error } = await supabaseClient
                        .from('colaboradores')
                        .upsert(supabaseData, {
                            onConflict: 'matricula'
                        });

                    if (error) {
                        console.error('Erro ao enviar colaborador:', collaborator.name, error);
                        errorCount++;
                    } else {
                        successCount++;
                    }
                }

                lastSyncTimes.collaborators = new Date();
                updateLastSyncDisplay();

                showNotification(`✅ ${successCount} colaborador(es) enviado(s) para a nuvem${errorCount > 0 ? ` (${errorCount} erros)` : ''}`, 'success');

            } catch (error) {
                console.error('Erro ao enviar colaboradores para a nuvem:', error);
                showNotification('❌ Erro ao enviar colaboradores para a nuvem.', 'error');
            }
        }

        async function downloadCollaboratorsFromCloud() {
            if (!isSupabaseConnected || !supabaseClient) {
                showNotification('Sem conexão com a nuvem. Verifique sua conexão.', 'error');
                return;
            }

            try {
                showNotification('Baixando colaboradores da nuvem...', 'info');

                const { data, error } = await supabaseClient
                    .from('colaboradores')
                    .select('*')
                    .order('nome');

                if (error) {
                    throw error;
                }

                if (data && data.length > 0) {
                    collaborators = data.map(item => ({
                        id: item.id || Date.now(),
                        name: item.nome,
                        registration: item.matricula,
                        sector: item.setor,
                        position: item.cargo,
                        admissionDate: item.data_admissao,
                        status: item.status,
                        observations: item.observacoes || '',
                        usuarioCadastro: item.usuario_cadastro || 'Sistema',
                        dataCadastro: item.data_cadastro || new Date().toISOString().split('T')[0]
                    }));

                    await saveAllData();
                    loadCollaboratorsList();
                    updateDashboardStats();

                    showNotification(`✅ ${data.length} colaborador(es) baixado(s) da nuvem`, 'success');
                } else {
                    showNotification('Nenhum colaborador encontrado na nuvem.', 'warning');
                }

                lastSyncTimes.collaborators = new Date();
                updateLastSyncDisplay();

            } catch (error) {
                console.error('Erro ao baixar colaboradores da nuvem:', error);
                showNotification('❌ Erro ao baixar colaboradores da nuvem.', 'error');
            }
        }

        // ============================================
        // SINCRONIZAÇÃO DE ATRIBUIÇÕES - VERSÃO CORRIGIDA
        // ============================================
        async function syncAssignmentsToCloud() {
            if (!isSupabaseConnected || !supabaseClient) {
                showNotification('Sem conexão com a nuvem. Verifique sua conexão.', 'error');
                return;
            }

            try {
                showNotification('Enviando atribuições para a nuvem...', 'info');

                let successCount = 0;
                let errorCount = 0;

                for (const assignment of assignments) {
                    const epi = epis.find(e => e.id === assignment.epiId);
                    const collaborator = collaborators.find(c => c.id === assignment.collaboratorId);

                    if (!epi || !collaborator) {
                        errorCount++;
                        continue;
                    }

                    // REMOVA data_cadastro daqui - ela não existe na tabela!
                    const supabaseData = {
                        epi_codigo: epi.code,
                        colaborador_matricula: collaborator.registration,
                        data_atribuicao: assignment.assignmentDate,
                        data_validade: assignment.expirationDate,
                        status: assignment.status || 'Ativo',
                        observacoes: assignment.observations || '',
                        usuario_atribuicao: currentUser?.name || 'Sistema'
                        // data_cadastro REMOVIDO!
                    };

                    const { error } = await supabaseClient
                        .from('atribuicoes')
                        .insert(supabaseData);

                    if (error) {
                        // Se der erro de duplicata, tenta UPDATE
                        if (error.code === '23505') {
                            const { error: updateError } = await supabaseClient
                                .from('atribuicoes')
                                .update(supabaseData)
                                .match({
                                    epi_codigo: epi.code,
                                    colaborador_matricula: collaborator.registration,
                                    data_atribuicao: assignment.assignmentDate
                                });

                            if (updateError) {
                                console.error('❌ Erro no UPDATE:', updateError);
                                errorCount++;
                            } else {
                                successCount++;
                            }
                        } else {
                            console.error('❌ Erro no INSERT:', error);
                            errorCount++;
                        }
                    } else {
                        successCount++;
                    }
                }

                lastSyncTimes.assignments = new Date();
                updateLastSyncDisplay();

                showNotification(`✅ ${successCount} atribuição(ões) enviada(s) para a nuvem${errorCount > 0 ? ` (${errorCount} erros)` : ''}`, 'success');

            } catch (error) {
                console.error('❌ Erro ao enviar atribuições:', error);
                showNotification('❌ Erro ao enviar atribuições.', 'error');
            }
        }

        // ============================================
        // SINCRONIZAÇÃO DE DEVOLUÇÕES
        // ============================================
        async function syncReturnsToCloud() {
            if (!isSupabaseConnected || !supabaseClient) {
                showNotification('Sem conexão com a nuvem. Verifique sua conexão.', 'error');
                return;
            }

            try {
                showNotification('Enviando devoluções para a nuvem...', 'info');

                const returnedAssignments = assignments.filter(a => a.status === 'Devolvido' || a.returnDate);

                if (returnedAssignments.length === 0) {
                    showNotification('Nenhuma devolução para enviar.', 'info');
                    return;
                }

                let successCount = 0;
                let errorCount = 0;

                for (const assignment of returnedAssignments) {
                    const epi = epis.find(e => e.id === assignment.epiId);
                    const collaborator = collaborators.find(c => c.id === assignment.collaboratorId);

                    if (!epi || !collaborator) {
                        errorCount++;
                        continue;
                    }

                    const supabaseData = {
                        epi_codigo: epi.code,
                        colaborador_matricula: collaborator.registration,
                        data_devolucao: assignment.returnDate,
                        motivo: assignment.returnReason,
                        condicao: assignment.returnCondition,
                        observacoes: assignment.returnObservations || '',
                        usuario_devolucao: currentUser?.name || 'Sistema',
                        updated_at: new Date().toISOString()
                    };

                    const { error } = await supabaseClient
                        .from('devolucoes')
                        .upsert(supabaseData, {
                            onConflict: 'epi_codigo,colaborador_matricula,data_devolucao'
                        });

                    if (error) {
                        console.error('Erro ao enviar devolução:', error);
                        errorCount++;
                    } else {
                        successCount++;
                    }
                }

                lastSyncTimes.returns = new Date();
                updateLastSyncDisplay();

                showNotification(`✅ ${successCount} devolução(ões) enviada(s) para a nuvem${errorCount > 0 ? ` (${errorCount} erros)` : ''}`, 'success');

            } catch (error) {
                console.error('Erro ao enviar devoluções para a nuvem:', error);
                showNotification('❌ Erro ao enviar devoluções para a nuvem.', 'error');
            }
        }

        async function syncAllReturnsToCloud() {
            if (!isSupabaseConnected || !supabaseClient) {
                showNotification('Sem conexão com a nuvem. Verifique sua conexão.', 'error');
                return;
            }

            try {
                showNotification('Sincronizando todas as devoluções...', 'info');

                await syncAssignmentsToCloud();
                await syncReturnsToCloud();

                showNotification('✅ Sincronização completa de devoluções concluída!', 'success');

            } catch (error) {
                console.error('Erro na sincronização completa:', error);
                showNotification('❌ Erro na sincronização completa.', 'error');
            }
        }

        // ============================================
        // SINCRONIZAÇÃO DE AVARIAS - VERSÃO CORRIGIDA
        // ============================================
        async function syncDamagesToCloud() {
            if (!isSupabaseConnected || !supabaseClient) {
                showNotification('Sem conexão com a nuvem. Verifique sua conexão.', 'error');
                return;
            }

            try {
                showNotification('Enviando avarias para a nuvem...', 'info');

                let successCount = 0;
                let errorCount = 0;

                for (const damage of damages) {
                    const epi = epis.find(e => e.id === damage.epiId);
                    const responsible = collaborators.find(c => c.id === damage.responsibleId);

                    if (!epi || !responsible) {
                        errorCount++;
                        continue;
                    }

                    const supabaseData = {
                        epi_codigo: epi.code,
                        colaborador_matricula: responsible.registration,
                        data_avaria: damage.date,
                        motivo: damage.reason,
                        descricao: damage.description,
                        solucao: damage.solution || '',
                        observacoes: damage.observations || '',
                        status: damage.status || 'Registrada',
                        usuario_registro: damage.reportedBy || currentUser?.name || 'Sistema'
                        // REMOVA on_conflict da chamada!
                    };

                    // Use INSERT simples, sem on_conflict
                    const { error } = await supabaseClient
                        .from('avarias')
                        .insert(supabaseData);

                    if (error) {
                        console.error('Erro ao enviar avaria:', error);
                        errorCount++;
                    } else {
                        successCount++;
                    }
                }

                lastSyncTimes.damages = new Date();
                updateLastSyncDisplay();
                updateDamageSyncStatus();

                showNotification(`✅ ${successCount} avaria(s) enviada(s) para a nuvem${errorCount > 0 ? ` (${errorCount} erros)` : ''}`, 'success');

            } catch (error) {
                console.error('Erro ao enviar avarias para a nuvem:', error);
                showNotification('❌ Erro ao enviar avarias para a nuvem.', 'error');
            }
        }

        async function downloadDamagesFromCloud() {
            if (!isSupabaseConnected || !supabaseClient) {
                showNotification('Sem conexão com a nuvem. Verifique sua conexão.', 'error');
                return;
            }

            try {
                showNotification('Baixando avarias da nuvem...', 'info');

                const { data, error } = await supabaseClient
                    .from('avarias')
                    .select('*')
                    .order('data_avaria', { ascending: false });

                if (error) {
                    throw error;
                }

                if (data && data.length > 0) {
                    const newDamages = [];

                    for (const item of data) {
                        const epi = epis.find(e => e.code === item.epi_codigo);
                        const responsible = collaborators.find(c => c.registration === item.colaborador_matricula);

                        if (epi && responsible) {
                            const damageData = {
                                id: item.id || Date.now(),
                                epiId: epi.id,
                                date: item.data_avaria,
                                reason: item.motivo,
                                responsibleId: responsible.id,
                                description: item.descricao,
                                solution: item.solucao || '',
                                observations: item.observacoes || '',
                                reportedBy: item.usuario_registro,
                                createdAt: item.created_at || new Date().toISOString(),
                                status: item.status
                            };

                            newDamages.push(damageData);
                        }
                    }

                    damages = newDamages;
                    await saveAllData();

                    loadDamageHistory();

                    showNotification(`✅ ${newDamages.length} avaria(s) baixada(s) da nuvem`, 'success');
                } else {
                    showNotification('Nenhuma avaria encontrada na nuvem.', 'warning');
                }

                lastSyncTimes.damages = new Date();
                updateLastSyncDisplay();
                updateDamageSyncStatus();

            } catch (error) {
                console.error('Erro ao baixar avarias da nuvem:', error);
                showNotification('❌ Erro ao baixar avarias da nuvem.', 'error');
            }
        }

        function updateDamageSyncStatus() {
            const element = document.getElementById('damageSyncStatus');
            if (element) {
                element.textContent = isSupabaseConnected ? 'Online' : 'Offline';
                element.className = `sync-status ${isSupabaseConnected ? 'online' : 'offline'}`;
            }
        }

        // ============================================
        // SINCRONIZAÇÃO COMPLETA DO CATÁLOGO
        // ============================================
        async function syncCatalogToCloud() {
            if (!isSupabaseConnected || !supabaseClient) {
                showNotification('Sem conexão com a nuvem. Verifique sua conexão.', 'error');
                return;
            }

            try {
                showNotification('Sincronizando catálogo completo...', 'info');

                await syncEpisToCloud();
                await syncCollaboratorsToCloud();
                await syncAssignmentsToCloud();
                await syncDamagesToCloud();

                lastSyncTimes.catalog = new Date();
                updateLastSyncDisplay();

                showNotification('✅ Catálogo completo sincronizado com a nuvem!', 'success');

            } catch (error) {
                console.error('Erro ao sincronizar catálogo:', error);
                showNotification('❌ Erro ao sincronizar catálogo.', 'error');
            }
        }

        async function downloadCatalogFromCloud() {
            if (!isSupabaseConnected || !supabaseClient) {
                showNotification('Sem conexão com a nuvem. Verifique sua conexão.', 'error');
                return;
            }

            try {
                showNotification('Baixando catálogo completo da nuvem...', 'info');

                await downloadEpisFromCloud();
                await downloadCollaboratorsFromCloud();

                lastSyncTimes.catalog = new Date();
                updateLastSyncDisplay();

                showNotification('✅ Catálogo completo baixado da nuvem!', 'success');

            } catch (error) {
                console.error('Erro ao baixar catálogo:', error);
                showNotification('❌ Erro ao baixar catálogo da nuvem.', 'error');
            }
        }

        // ============================================
        // SINCRONIZAÇÃO GERAL (TUDO)
        // ============================================
        async function syncAllToCloud() {
            if (!isSupabaseConnected || !supabaseClient) {
                showNotification('Sem conexão com a nuvem. Verifique sua conexão.', 'error');
                return;
            }

            try {
                showNotification('Sincronizando todos os dados com a nuvem...', 'info');

                await syncEpisToCloud();
                await syncCollaboratorsToCloud();
                await syncAssignmentsToCloud();
                await syncReturnsToCloud();
                await syncDamagesToCloud();

                showNotification('✅ Todos os dados sincronizados com a nuvem!', 'success');

            } catch (error) {
                console.error('Erro na sincronização geral:', error);
                showNotification('❌ Erro na sincronização geral.', 'error');
            }
        }

        async function downloadAllFromCloud() {
            if (!isSupabaseConnected || !supabaseClient) {
                showNotification('Sem conexão com a nuvem. Verifique sua conexão.', 'error');
                return;
            }

            try {
                showNotification('Baixando todos os dados da nuvem...', 'info');

                await downloadEpisFromCloud();
                await downloadCollaboratorsFromCloud();
                await downloadDamagesFromCloud();

                showNotification('✅ Todos os dados baixados da nuvem!', 'success');

            } catch (error) {
                console.error('Erro ao baixar todos os dados:', error);
                showNotification('❌ Erro ao baixar todos os dados.', 'error');
            }
        }

        // ============================================
        // FUNÇÃO PARA ATUALIZAR DISPLAY DA ÚLTIMA SINCRONIZAÇÃO
        // ============================================
        function updateLastSyncDisplay() {
            const lastSyncElement = document.getElementById('lastSync');
            if (!lastSyncElement) return;

            const times = Object.values(lastSyncTimes).filter(time => time !== null);

            if (times.length === 0) {
                lastSyncElement.textContent = 'Nunca';
                return;
            }

            const latestSync = new Date(Math.max(...times.map(time => new Date(time))));
            lastSyncElement.textContent = latestSync.toLocaleString('pt-BR');
        }

        // ============================================
        // FUNÇÃO PARA BAIXAR BACKUP EM JSON
        // ============================================
        async function downloadBackupJson() {
            if (backupInProgress) {
                showNotification('Backup já está em andamento. Aguarde...', 'warning');
                return;
            }

            try {
                backupInProgress = true;
                showNotification('Gerando backup em JSON...', 'info');

                // Coletar todos os dados
                const backupData = {
                    epis: epis,
                    collaborators: collaborators,
                    assignments: assignments,
                    damages: damages,
                    certificates: certificates,
                    metadata: {
                        sistema: "Sistema de Gestão de EPIs",
                        versao: "3.0",
                        dataBackup: new Date().toISOString(),
                        totalEpis: epis.length,
                        totalColaboradores: collaborators.length,
                        totalAtribuicoes: assignments.length,
                        totalAvarias: damages.length,
                        usuario: currentUser ? currentUser.name : 'Anônimo',
                        dataHora: new Date().toLocaleString('pt-BR')
                    }
                };

                // Converter para JSON
                const jsonString = JSON.stringify(backupData, null, 2);

                // Criar blob e download
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup_epis_${new Date().toISOString().slice(0, 10)}_${new Date().getTime()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                backupInProgress = false;
                showNotification('✅ Backup em JSON baixado com sucesso!', 'success');

            } catch (error) {
                console.error('Erro ao gerar backup:', error);
                backupInProgress = false;
                showNotification('❌ Erro ao gerar backup em JSON.', 'error');
            }
        }

        // ============================================
        // FUNÇÃO PARA RESTAURAR BACKUP DE JSON
        // ============================================
        async function restoreBackupFromJson() {
            return new Promise((resolve, reject) => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';

                input.onchange = async function (e) {
                    const file = e.target.files[0];
                    if (!file) {
                        reject('Nenhum arquivo selecionado');
                        return;
                    }

                    try {
                        showNotification('Lendo arquivo de backup...', 'info');

                        const reader = new FileReader();

                        reader.onload = async function (event) {
                            try {
                                const jsonContent = event.target.result;
                                const backupData = JSON.parse(jsonContent);

                                // Validar estrutura do backup
                                if (!backupData.epis || !backupData.collaborators || !backupData.assignments || !backupData.damages) {
                                    throw new Error('Estrutura do arquivo de backup inválida');
                                }

                                // Pedir confirmação
                                if (!confirm(`Deseja restaurar o backup?\n\nEPIs: ${backupData.epis.length}\nColaboradores: ${backupData.collaborators.length}\nAtribuições: ${backupData.assignments.length}\nAvarias: ${backupData.damages.length}\n\nEsta ação substituirá os dados atuais.`)) {
                                    reject('Restauração cancelada pelo usuário');
                                    return;
                                }

                                // Restaurar dados
                                epis = backupData.epis;
                                collaborators = backupData.collaborators;
                                assignments = backupData.assignments;
                                damages = backupData.damages;
                                certificates = backupData.certificates || [];

                                // Salvar no localStorage
                                await saveAllData();

                                // Atualizar interface
                                loadEpisList();
                                loadCollaboratorsList();
                                loadDamageHistory();
                                updateDashboardStats();
                                updateCategoryChart();

                                showNotification('✅ Backup restaurado com sucesso!', 'success');
                                resolve(true);

                            } catch (error) {
                                console.error('Erro ao processar backup:', error);
                                showNotification('❌ Erro ao processar arquivo de backup.', 'error');
                                reject(error);
                            }
                        };

                        reader.onerror = function () {
                            showNotification('❌ Erro ao ler arquivo de backup.', 'error');
                            reject('Erro ao ler arquivo');
                        };

                        reader.readAsText(file);

                    } catch (error) {
                        console.error('Erro ao restaurar backup:', error);
                        showNotification('❌ Erro ao restaurar backup.', 'error');
                        reject(error);
                    }
                };

                input.click();
            });
        }

        // ============================================
        // FUNÇÃO DE BACKUP AUTOMÁTICO PERIÓDICO
        // ============================================
        function setupAutomaticBackup() {
            // Fazer backup automático a cada 1 hora
            setInterval(async () => {
                try {
                    const lastBackup = localStorage.getItem('lastAutomaticBackup');
                    const now = new Date().getTime();

                    // Se nunca fez backup ou se passou 1 hora
                    if (!lastBackup || (now - parseInt(lastBackup)) > 60 * 60 * 1000) {
                        console.log('⏰ Fazendo backup automático...');

                        // Salvar dados atuais
                        await saveAllData();

                        // Atualizar timestamp do último backup
                        localStorage.setItem('lastAutomaticBackup', now.toString());

                        // Tentar fazer upload para nuvem
                        if (isSupabaseConnected && currentUser) {
                            try {
                                await syncAllToCloud();
                            } catch (syncError) {
                                console.warn('⚠️ Não foi possível sincronizar com nuvem, mas backup local foi salvo');
                            }
                        }

                        console.log('✅ Backup automático concluído');
                    }
                } catch (error) {
                    console.error('Erro no backup automático:', error);
                }
            }, 5 * 60 * 1000); // Verificar a cada 5 minutos

            // Fazer backup quando o usuário sair da página
            window.addEventListener('beforeunload', async function () {
                try {
                    await saveAllData();
                } catch (error) {
                    console.error('Erro no backup ao sair:', error);
                }
            });
        }

        // ============================================
        // INICIALIZAR COM DADOS DE EXEMPLO
        // ============================================
        function initializeSampleData() {
            // EPIs de exemplo
            epis = [
                {
                    id: 1,
                    name: "Capacete de Segurança",
                    code: "EPI-CAP-001",
                    category: "Proteção da Cabeça",
                    caNumber: "CA-12345",
                    manufacturer: "3M do Brasil",
                    status: "Disponível",
                    quantity: 15,
                    conformity: "Conforme",
                    inspectionObservations: "Em bom estado",
                    inspectionDate: "2023-11-01",
                    nextInspectionDate: "2024-02-01",
                    stockMin: 5,
                    image: "",
                    usuarioCadastro: "Sistema",
                    dataCadastro: "2023-01-15",
                    createdAt: "2023-01-15T09:30:00Z"
                },
                {
                    id: 2,
                    name: "Protetor Auricular",
                    code: "EPI-AUD-001",
                    category: "Proteção Auditiva",
                    caNumber: "CA-23456",
                    manufacturer: "Delta Plus",
                    status: "Em Uso",
                    quantity: 25,
                    conformity: "Conforme",
                    inspectionObservations: "Espumas em bom estado",
                    inspectionDate: "2023-10-15",
                    nextInspectionDate: "2024-01-15",
                    stockMin: 10,
                    image: "",
                    usuarioCadastro: "Sistema",
                    dataCadastro: "2023-02-10",
                    createdAt: "2023-02-10T14:20:00Z"
                }
            ];

            // Colaboradores de exemplo
            collaborators = [
                {
                    id: 1,
                    name: "João Silva",
                    registration: "00123",
                    sector: "Produção",
                    position: "Operador de Máquinas",
                    admissionDate: "2022-03-15",
                    status: "Ativo",
                    observations: "Colaborador exemplar"
                },
                {
                    id: 2,
                    name: "Maria Santos",
                    registration: "00124",
                    sector: "Manutenção",
                    position: "Técnica de Manutenção",
                    admissionDate: "2021-08-22",
                    status: "Ativo",
                    observations: ""
                }
            ];

            // Atribuições de exemplo
            assignments = [
                {
                    id: 1,
                    collaboratorId: 1,
                    epiId: 1,
                    assignmentDate: "2023-11-01",
                    expirationDate: "2024-11-01",
                    status: "Ativo",
                    observations: "Atribuição padrão"
                }
            ];

            // Certificados de exemplo
            certificates = [
                {
                    id: 1,
                    caNumber: "CA-12345",
                    epiName: "Capacete de Segurança",
                    manufacturer: "3M do Brasil",
                    issueDate: "2022-01-15",
                    validityDate: "2025-01-15",
                    status: "Válido",
                    fileUrl: ""
                }
            ];

            // Avarias de exemplo
            damages = [
                {
                    id: 1,
                    epiId: 1,
                    date: "2023-11-15",
                    reason: "Desgaste Natural",
                    responsibleId: 1,
                    description: "Capacete apresenta rachaduras na parte interna da viseira.",
                    solution: "Substituído por novo",
                    observations: "Colaborador orientado sobre cuidados com o equipamento.",
                    reportedBy: "Sistema",
                    createdAt: "2023-11-15T10:30:00Z",
                    status: "Resolvida"
                },
                {
                    id: 2,
                    epiId: 2,
                    date: "2023-11-20",
                    reason: "Uso Inadequado",
                    responsibleId: 2,
                    description: "Espumas dos protetores auriculares desgastadas e sujas.",
                    solution: "Enviado para Manutenção",
                    observations: "Necessário treinamento sobre uso correto do EPI.",
                    reportedBy: "Sistema",
                    createdAt: "2023-11-20T14:45:00Z",
                    status: "Em Análise"
                }
            ];
        }

        // ============================================
        // FUNÇÕES DE AUTENTICAÇÃO
        // ============================================
        function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            let user = null;
            let userKey = null;

            if (users[email]) {
                user = users[email];
                userKey = email;
            }

            if (user && user.password === password) {
                currentUser = {
                    ...user,
                    key: userKey
                };

                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showDashboard();
                setupUserInterface();
                initializeSystem();
            } else {
                errorDiv.classList.add('show');
                setTimeout(() => {
                    errorDiv.classList.remove('show');
                }, 3000);
            }
        }

        function logout() {
            if (confirm('Deseja realmente sair do sistema?')) {
                // Fazer backup antes de sair
                saveAllData().then(() => {
                    currentUser = null;
                    localStorage.removeItem('currentUser');
                    showLogin();
                });
            }
        }

        function checkSession() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);

                    if (users[currentUser.key] && users[currentUser.key].password === currentUser.password) {
                        showDashboard();
                        setupUserInterface();
                        initializeSystem();
                        return;
                    }
                } catch (e) {
                    console.error('Erro ao restaurar sessão:', e);
                }
            }

            showLogin();
        }

        function showLogin() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('dashboardScreen').style.display = 'none';
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
        }

        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboardScreen').style.display = 'block';

            if (currentUser) {
                document.getElementById('userWelcomeText').textContent = `Bem-vindo, ${currentUser.name}`;
                document.getElementById('userRoleBadge').textContent = getRoleDisplayName(currentUser.role);
                document.getElementById('userRoleBadge').className = `user-badge ${getRoleBadgeClass(currentUser.role)}`;
            }
        }

        function setupUserInterface() {
            if (!currentUser) return;

            const role = currentUser.role;
            const tabs = document.querySelectorAll('.tab-button');

            tabs.forEach(tab => tab.style.display = 'none');

            switch (role) {
                case 'dev':
                    tabs.forEach(tab => tab.style.display = 'flex');
                    break;

                case 'seguranca':
                    ['dashboard', 'cadastro-epi', 'controle-colaborador', 'devolucao-epi', 'termo-responsabilidade', 'certificados-laudos'].forEach(tabId => {
                        const tab = document.querySelector(`[data-tab="${tabId}"]`);
                        if (tab) tab.style.display = 'flex';
                    });
                    break;

                case 'almoxarife':
                    ['dashboard', 'cadastro-epi', 'devolucao-epi', 'catalogo', 'cadastro-avarias', 'database'].forEach(tabId => {
                        const tab = document.querySelector(`[data-tab="${tabId}"]`);
                        if (tab) tab.style.display = 'flex';
                    });
                    break;

                case 'colaborador':
                    ['dashboard', 'controle-colaborador'].forEach(tabId => {
                        const tab = document.querySelector(`[data-tab="${tabId}"]`);
                        if (tab) tab.style.display = 'flex';
                    });
                    break;
            }

            document.querySelector('[data-tab="dashboard"]').style.display = 'flex';
        }

        function getRoleDisplayName(role) {
            const roles = {
                'dev': 'DEV',
                'seguranca': 'Segurança',
                'almoxarife': 'Almoxarife',
                'colaborador': 'Colaborador'
            };
            return roles[role] || 'Usuário';
        }

        function getRoleBadgeClass(role) {
            const classes = {
                'dev': 'status-completed',
                'seguranca': 'status-ontrack',
                'almoxarife': 'status-delayed',
                'colaborador': ''
            };
            return classes[role] || '';
        }

        // ============================================
        // FUNÇÕES PRINCIPAIS DO SISTEMA
        // ============================================
        async function initializeSystem() {
            try {
                console.log('🔧 INICIALIZANDO SISTEMA DE EPIs COM SINCRONIZAÇÃO MODULAR E BACKUP');

                // INICIALIZAR SUPABASE
                await initializeSupabase();

                // VERIFICAR SE JÁ EXISTEM DADOS NO LOCALSTORAGE
                const hasLocalData = localStorage.getItem('epis') !== null;

                if (!hasLocalData && isSupabaseConnected) {
                    // Se não tem dados locais e está conectado, baixar da nuvem
                    showNotification('Baixando dados da nuvem pela primeira vez...', 'info');
                    await downloadAllFromCloud();
                } else {
                    // Carregar dados locais
                    await loadInitialData();
                }

                updateDashboardStats();
                updateStatistics();
                loadEpisList();
                loadCollaboratorsList();
                updateCategoryChart();

                initializeEpiForm();

                // Inicializar aba de devolução
                initializeReturnTab();

                // Inicializar aba de avarias
                initializeDamageTab();

                // Configurar botões de sincronização
                setupSyncButtons();

                // Configurar botão de backup JSON
                setupBackupButton();

                // Atualizar contadores
                updateCounts();

                // Configurar backup automático
                setupAutomaticBackup();

                showNotification('Sistema de EPIs inicializado com backup automático!', 'success');

            } catch (error) {
                console.error('❌ Erro na inicialização:', error);
                showNotification('Erro ao inicializar sistema.', 'error');
            }
        }

        // ============================================
        // CONFIGURAÇÃO DOS BOTÕES DE SINCRONIZAÇÃO E BACKUP
        // ============================================
        function setupSyncButtons() {
            // Sincronização de EPIs (aba 2)
            document.getElementById('syncEpiBtn')?.addEventListener('click', syncEpisToCloud);
            document.getElementById('downloadEpiBtn')?.addEventListener('click', downloadEpisFromCloud);

            // Sincronização de Colaboradores (aba 3)
            document.getElementById('syncCollaboratorsBtn')?.addEventListener('click', syncCollaboratorsToCloud);
            document.getElementById('downloadCollaboratorsBtn')?.addEventListener('click', downloadCollaboratorsFromCloud);
            document.getElementById('syncAssignmentsBtn')?.addEventListener('click', syncAssignmentsToCloud);

            // Sincronização de Devoluções (aba 4)
            document.getElementById('syncReturnsBtn')?.addEventListener('click', syncReturnsToCloud);
            document.getElementById('downloadReturnsBtn')?.addEventListener('click', function () {
                showNotification('Funcionalidade de download de devoluções em desenvolvimento', 'info');
            });
            document.getElementById('syncAllReturnsBtn')?.addEventListener('click', syncAllReturnsToCloud);

            // Sincronização de Avarias (aba 7)
            document.getElementById('syncDamagesBtn')?.addEventListener('click', syncDamagesToCloud);
            document.getElementById('downloadDamagesBtn')?.addEventListener('click', downloadDamagesFromCloud);

            // Sincronização do Catálogo (aba 8)
            document.getElementById('syncCatalogBtn')?.addEventListener('click', syncCatalogToCloud);
            document.getElementById('downloadCatalogBtn')?.addEventListener('click', downloadCatalogFromCloud);
            document.getElementById('syncCatalogAllBtn')?.addEventListener('click', syncCatalogToCloud);

            // Sincronização do Banco de Dados (aba 9)
            document.getElementById('uploadEpisBtn')?.addEventListener('click', syncEpisToCloud);
            document.getElementById('uploadCollaboratorsBtn')?.addEventListener('click', syncCollaboratorsToCloud);
            document.getElementById('uploadAssignmentsBtn')?.addEventListener('click', syncAssignmentsToCloud);
            document.getElementById('uploadReturnsBtn')?.addEventListener('click', syncReturnsToCloud);
            document.getElementById('uploadDamagesBtn')?.addEventListener('click', syncDamagesToCloud);
            document.getElementById('uploadAllBtn')?.addEventListener('click', syncAllToCloud);
            document.getElementById('downloadAllBtn')?.addEventListener('click', downloadAllFromCloud);
        }

        function setupBackupButton() {
            // Botão de backup JSON na aba Catálogo
            const downloadBackupBtn = document.getElementById('downloadBackupJsonBtn');
            if (downloadBackupBtn) {
                downloadBackupBtn.addEventListener('click', downloadBackupJson);
            }

            // Adicionar botão de restaurar backup na aba Banco de Dados
            const databaseTab = document.getElementById('database');
            if (databaseTab) {
                // Verificar se já existe o botão
                if (!document.getElementById('restoreBackupBtn')) {
                    const restoreBtn = document.createElement('button');
                    restoreBtn.id = 'restoreBackupBtn';
                    restoreBtn.className = 'btn btn-warning';
                    restoreBtn.innerHTML = '<i class="fas fa-file-upload"></i> Restaurar Backup';
                    restoreBtn.style.marginTop = '10px';
                    restoreBtn.addEventListener('click', async () => {
                        try {
                            await restoreBackupFromJson();
                        } catch (error) {
                            console.error('Erro ao restaurar backup:', error);
                        }
                    });

                    // Encontrar o grupo de botões e adicionar
                    const btnGroup = databaseTab.querySelector('.btn-group');
                    if (btnGroup) {
                        btnGroup.appendChild(restoreBtn);
                    }
                }
            }
        }

        function updateCounts() {
            const epiCountElement = document.getElementById('epiCount');
            const collaboratorCountElement = document.getElementById('collaboratorCount');
            const assignmentCountElement = document.getElementById('assignmentCount');
            const returnCountElement = document.getElementById('returnCount');
            const damageCountElement = document.getElementById('damageCount');

            if (epiCountElement) epiCountElement.textContent = epis.length;
            if (collaboratorCountElement) collaboratorCountElement.textContent = collaborators.length;
            if (assignmentCountElement) assignmentCountElement.textContent = assignments.length;

            const returnCount = assignments.filter(a => a.status === 'Devolvido').length;
            if (returnCountElement) returnCountElement.textContent = returnCount;

            if (damageCountElement) damageCountElement.textContent = damages.length;
        }

        async function loadInitialData() {
            try {
                const savedEpis = localStorage.getItem('epis');
                const savedCollaborators = localStorage.getItem('collaborators');
                const savedAssignments = localStorage.getItem('assignments');
                const savedCertificates = localStorage.getItem('certificates');
                const savedDamages = localStorage.getItem('damages');

                if (savedEpis) {
                    epis = JSON.parse(savedEpis);
                }

                if (savedCollaborators) collaborators = JSON.parse(savedCollaborators);
                if (savedAssignments) assignments = JSON.parse(savedAssignments);
                if (savedCertificates) certificates = JSON.parse(savedCertificates);
                if (savedDamages) damages = JSON.parse(savedDamages);

                // Se não houver dados locais, inicializar com dados de exemplo
                if (epis.length === 0 && collaborators.length === 0) {
                    initializeSampleData();
                    await saveAllData();
                }

                updateStorageInfo();

            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                initializeSampleData();
            }
        }

        async function saveAllData() {
            try {
                // Criar cópia dos epis SEM imagens Base64 (para economizar espaço)
                const episSemImagens = epis.map(epi => {
                    const { image, ...epiSemImagem } = epi;
                    return {
                        ...epiSemImagem,
                        // Manter apenas referência se for URL
                        image: epi.image && epi.image.startsWith('http') ? epi.image : ''
                    };
                });

                localStorage.setItem('epis', JSON.stringify(episSemImagens));
                localStorage.setItem('collaborators', JSON.stringify(collaborators));
                localStorage.setItem('assignments', JSON.stringify(assignments));
                localStorage.setItem('certificates', JSON.stringify(certificates));
                localStorage.setItem('damages', JSON.stringify(damages));

                // Salvar timestamp da última modificação
                localStorage.setItem('lastModified', new Date().getTime().toString());

                updateStorageInfo();
                updateCounts();

                console.log('💾 Dados salvos no localStorage:', {
                    epis: epis.length,
                    colaboradores: collaborators.length,
                    atribuicoes: assignments.length,
                    avarias: damages.length
                });

                return true;
            } catch (error) {
                console.error('Erro ao salvar dados:', error);
                showNotification('Erro ao salvar dados.', 'error');
                return false;
            }
        }

        function updateStorageInfo() {
            const localItemsCount = document.getElementById('localItemsCount');
            if (localItemsCount) {
                localItemsCount.textContent = epis.length;
            }
        }
        function getExpiringEpisCount(days) {
            if (!epis || epis.length === 0) return 0;

            const today = new Date();
            const targetDate = new Date();
            targetDate.setDate(today.getDate() + days);

            let count = 0;

            epis.forEach(epi => {
                if (!epi.nextInspectionDate) return;

                const expirationDate = new Date(epi.nextInspectionDate);

                // Verificar se a data de inspeção está dentro do período
                const diffTime = expirationDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                // Contar se expira nos próximos X dias OU já expirou
                if (diffDays <= days) {
                    count++;
                }
            });

            console.log('🔢 Contagem de EPIs vencendo:', count);
            return count;
        }
        function debugEpisData() {
            console.log('🔍 DEBUG - Dados dos EPIs:');

            if (epis.length === 0) {
                console.log('Nenhum EPI cadastrado');
                return;
            }

            epis.forEach((epi, index) => {
                console.log(`\nEPI ${index + 1}: ${epi.name} (${epi.code})`);
                console.log(`- Status: ${epi.status}`);
                console.log(`- Data de inspeção: ${epi.inspectionDate || 'N/A'}`);
                console.log(`- Próxima inspeção: ${epi.nextInspectionDate || 'N/A'}`);

                if (epi.nextInspectionDate) {
                    const daysLeft = getDaysLeft(epi.nextInspectionDate);
                    console.log(`- Dias restantes: ${daysLeft}`);

                    if (daysLeft <= 30) {
                        console.log(`⚠️  Este EPI está VENCENDO/VENCIDO! (${daysLeft} dias)`);
                    }
                }
            });

            // Testar a função getExpiringEpis
            const expiring = getExpiringEpis(30);
            console.log(`\n📊 Total de EPIs vencendo/vencidos: ${expiring.length}`);
        }

        // ============================================
        // DASHBOARD E ESTATÍSTICAS
        // ============================================
        function updateDashboardStats() {
            document.getElementById('totalEpis').textContent = epis.length;
            document.getElementById('totalColaboradores').textContent = collaborators.length;

            const expiringCount = getExpiringEpisCount(30);
            document.getElementById('expiringCount').textContent = expiringCount;

            const compliantEpis = epis.filter(epi => epi.conformity === 'Conforme').length;
            const complianceRate = epis.length > 0 ? Math.round((compliantEpis / epis.length) * 100) : 100;
            document.getElementById('complianceRate').textContent = `${complianceRate}%`;

            document.getElementById('lastUpdate').textContent = new Date().toLocaleDateString('pt-BR');

            updateExpiringEpiList();
            updateSectorStats();
            updateCategoryChart();

            // ATUALIZAR ESTATÍSTICAS DE STATUS
            updateStatistics();

            console.log('📈 Dashboard atualizado:', {
                totalEpis: epis.length,
                expiringCount,
                complianceRate
            });
        }

        function getExpiringEpisCount(days) {
            const today = new Date();
            const targetDate = new Date();
            targetDate.setDate(today.getDate() + days);

            return assignments.filter(assignment => {
                if (!assignment.expirationDate) return false;
                const expirationDate = new Date(assignment.expirationDate);
                return expirationDate <= targetDate && expirationDate >= today && assignment.status === 'Ativo';
            }).length;
        }

        function updateExpiringEpiList() {
            const expiringList = document.getElementById('expiringEpiList');
            const expiringEpis = getExpiringEpis(30);

            console.log('📋 EPIs vencendo/vencidos encontrados:', expiringEpis.length);

            if (expiringEpis.length > 0) {
                let html = '';

                expiringEpis.forEach(item => {
                    const daysLeft = item.daysLeft;
                    const isExpired = daysLeft <= 0;
                    const isExpiring = daysLeft <= 30 && daysLeft > 0;

                    let statusText = '';
                    let statusClass = '';

                    if (isExpired) {
                        statusText = 'VENCIDO';
                        statusClass = 'expired';
                    } else if (isExpiring) {
                        statusText = `${daysLeft} dias`;
                        statusClass = 'expiring';
                    }

                    html += `
                <div class="validity-item ${statusClass}">
                    <div>
                        <strong>${item.epiName}</strong>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px; font-size: 13px;">
                            <span><strong>Código:</strong> ${item.epiCode}</span>
                            <span><strong>Vencimento:</strong> ${formatDate(item.nextInspectionDate)}</span>
                            ${item.collaboratorName !== 'Não atribuído' ?
                            `<span><strong>Colaborador:</strong> ${item.collaboratorName}</span>` :
                            `<span style="color: var(--warning-color);"><strong>Status:</strong> Não atribuído</span>`
                        }
                        </div>
                    </div>
                    <span class="days-left ${statusClass}">
                        ${isExpired ? 'VENCIDO' : `${daysLeft} dias`}
                    </span>
                </div>
            `;
                });

                expiringList.innerHTML = html;
            } else {
                expiringList.innerHTML = `
            <div style="text-align: center; padding: 20px 0;">
                <i class="fas fa-check-circle" style="font-size: 40px; color: var(--success-color); margin-bottom: 15px;"></i>
                <p style="color: var(--success-color); font-weight: 500;">Nenhum EPI vencendo nos próximos 30 dias!</p>
                <p style="font-size: 13px; color: var(--gray-color); margin-top: 10px;">
                    Todos os EPIs estão com validade em dia.
                </p>
            </div>
        `;
            }
        }

        function getExpiringEpis(days) {
            const today = new Date();
            const targetDate = new Date();
            targetDate.setDate(today.getDate() + days);

            return epis
                .filter(epi => {
                    if (!epi.nextInspectionDate) return false;

                    const inspectionDate = new Date(epi.nextInspectionDate);
                    return inspectionDate <= targetDate;
                })
                .map(epi => {
                    // Verificar se o EPI está atribuído a algum colaborador
                    const assignment = assignments.find(a =>
                        a.epiId === epi.id && a.status === 'Ativo'
                    );

                    const collaborator = assignment ?
                        collaborators.find(c => c.id === assignment.collaboratorId) :
                        null;

                    return {
                        epiId: epi.id,
                        epiName: epi.name,
                        epiCode: epi.code,
                        nextInspectionDate: epi.nextInspectionDate,
                        daysLeft: getDaysLeft(epi.nextInspectionDate),
                        collaboratorName: collaborator ? collaborator.name : 'Não atribuído',
                        collaboratorId: collaborator ? collaborator.id : null,
                        assignmentId: assignment ? assignment.id : null,
                        isAssigned: !!assignment
                    };
                })
                .sort((a, b) => getDaysLeft(a.nextInspectionDate) - getDaysLeft(b.nextInspectionDate));
        }

        function updateSectorStats() {
            const sectorStats = document.getElementById('sectorStats');
            const sectors = {};

            collaborators.forEach(collaborator => {
                if (!sectors[collaborator.sector]) {
                    sectors[collaborator.sector] = 0;
                }
                sectors[collaborator.sector]++;
            });

            let html = '';
            for (const [sector, count] of Object.entries(sectors)) {
                const percent = Math.round((count / collaborators.length) * 100);
                html += `
                    <div class="progress-container">
                        <div class="progress-label">
                            <span>${sector}</span>
                            <span>${count}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percent}%; background-color: ${getRandomColor()}"></div>
                        </div>
                    </div>
                `;
            }

            sectorStats.innerHTML = html || '<p style="text-align: center; color: var(--gray-color); padding: 20px 0;">Nenhum colaborador cadastrado</p>';
        }

        function updateCategoryChart() {
            const ctx = document.getElementById('categoryChart').getContext('2d');

            const categories = {};
            epis.forEach(epi => {
                categories[epi.category] = (categories[epi.category] || 0) + 1;
            });

            const categoryLabels = Object.keys(categories);
            const categoryData = Object.values(categories);

            if (window.chartInstance) {
                window.chartInstance.destroy();
            }

            if (categoryLabels.length > 0) {
                window.chartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: categoryLabels,
                        datasets: [{
                            data: categoryData,
                            backgroundColor: categoryLabels.map(() => getRandomColor()),
                            borderColor: 'white',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            }
                        }
                    }
                });
            }
        }

        function updateStatistics() {
            // Contar EPIs por status de validade
            let conformeCount = 0;
            let vencendoCount = 0;
            let vencidosCount = 0;

            const today = new Date();

            // Para EPIs com data de inspeção
            epis.forEach(epi => {
                if (!epi.nextInspectionDate) {
                    conformeCount++; // Considerar como conforme se não tem data
                    return;
                }

                const nextInspection = new Date(epi.nextInspectionDate);
                const diffTime = nextInspection - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays > 30) {
                    conformeCount++;
                } else if (diffDays > 0 && diffDays <= 30) {
                    vencendoCount++;
                } else {
                    vencidosCount++;
                }
            });

            const total = epis.length;
            const conformePercent = total > 0 ? Math.round((conformeCount / total) * 100) : 0;
            const vencendoPercent = total > 0 ? Math.round((vencendoCount / total) * 100) : 0;
            const vencidosPercent = total > 0 ? Math.round((vencidosCount / total) * 100) : 0;

            console.log('📊 Estatísticas atualizadas:', {
                total,
                conformeCount,
                vencendoCount,
                vencidosCount,
                conformePercent,
                vencendoPercent,
                vencidosPercent
            });

            // Atualizar elementos da interface
            const conformePercentElement = document.getElementById('conformePercent');
            const vencendoPercentElement = document.getElementById('vencendoPercent');
            const vencidosPercentElement = document.getElementById('vencidosPercent');
            const conformeBarElement = document.getElementById('conformeBar');
            const vencendoBarElement = document.getElementById('vencendoBar');
            const vencidosBarElement = document.getElementById('vencidosBar');

            // Atualizar porcentagens
            if (conformePercentElement) conformePercentElement.textContent = `${conformePercent}%`;
            if (vencendoPercentElement) vencendoPercentElement.textContent = `${vencendoPercent}%`;
            if (vencidosPercentElement) vencidosPercentElement.textContent = `${vencidosPercent}%`;

            // Na função updateStatistics(), troque estas linhas:
            if (conformeBarElement) {
                conformeBarElement.style.width = `${conformePercent}%`;
                conformeBarElement.className = 'progress-fill actual';
            }

            if (vencendoBarElement) {
                vencendoBarElement.style.width = `${vencendoPercent}%`;
                vencendoBarElement.className = 'progress-fill planned';
            }

            if (vencidosBarElement) {
                vencidosBarElement.style.width = `${vencidosPercent}%`;
                vencidosBarElement.className = 'progress-fill';
            }
        }


        // ============================================
        // CADASTRO DE EPI
        // ============================================
        function initializeEpiForm() {
            const timestamp = Date.now();
            const randomNum = Math.floor(Math.random() * 1000);
            const codeInput = document.getElementById('code');
            if (codeInput) {
                codeInput.value = `EPI-${timestamp.toString().slice(-6)}-${randomNum}`;
            }

            const today = new Date().toISOString().split('T')[0];
            const inspectionDateInput = document.getElementById('inspectionDate');

            if (inspectionDateInput) inspectionDateInput.value = today;

            setupImageCapture();
            addBatchRow();
        }

        function setupImageCapture() {
            const cameraArea = document.getElementById('cameraArea');
            const takePhotoBtn = document.getElementById('takePhotoBtn');
            const uploadPhotoBtn = document.getElementById('uploadPhotoBtn');
            const clearPhotoBtn = document.getElementById('clearPhotoBtn');
            const imageFileInput = document.getElementById('imageFileInput');

            // APENAS a área da câmera deve abrir o seletor de arquivos
            if (cameraArea) cameraArea.addEventListener('click', () => imageFileInput.click());

            // O botão "Tirar Foto" também deve abrir o seletor
            if (takePhotoBtn) takePhotoBtn.addEventListener('click', () => imageFileInput.click());

            // O botão "Carregar Imagem" - deixe como está
            if (uploadPhotoBtn) uploadPhotoBtn.addEventListener('click', () => imageFileInput.click());

            if (clearPhotoBtn) {
                clearPhotoBtn.addEventListener('click', () => {
                    document.getElementById('epiImageBase64').value = '';
                    document.getElementById('epiImagePreview').style.display = 'none';
                    document.getElementById('cameraPlaceholder').style.display = 'block';
                    clearPhotoBtn.style.display = 'none';
                });
            }

            if (imageFileInput) {
                imageFileInput.addEventListener('change', function (e) {
                    const file = e.target.files[0];
                    if (file) {
                        if (!file.type.match('image.*')) {
                            showNotification('Por favor, selecione uma imagem.', 'error');
                            return;
                        }

                        if (file.size > 5 * 1024 * 1024) {
                            showNotification('A imagem deve ser menor que 5MB.', 'error');
                            return;
                        }

                        const reader = new FileReader();
                        reader.onload = function (event) {
                            const base64Image = event.target.result;
                            document.getElementById('epiImageBase64').value = base64Image;
                            document.getElementById('epiImagePreview').src = base64Image;
                            document.getElementById('epiImagePreview').style.display = 'block';
                            document.getElementById('cameraPlaceholder').style.display = 'none';
                            document.getElementById('clearPhotoBtn').style.display = 'inline-block';
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        }

        function addBatchRow() {
            const tbody = document.getElementById('batchTableBody');
            if (!tbody) return;

            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>
                    <input type="text" class="batch-code" placeholder="Ex: EPI-CAP-002" required>
                </td>
                <td>
                    <input type="number" class="batch-quantity" min="1" value="1" required>
                </td>
                <td>
                    <textarea class="batch-observations" rows="2" placeholder="Observações..."></textarea>
                </td>
                <td>
                    <button type="button" class="remove-row-btn" onclick="removeBatchRow(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;

            tbody.appendChild(newRow);

            const timestamp = Date.now();
            const randomNum = Math.floor(Math.random() * 1000);
            const rowNum = tbody.querySelectorAll('tr').length;
            newRow.querySelector('.batch-code').value = `EPI-${timestamp.toString().slice(-6)}-${rowNum}`;

            return newRow;
        }

        function removeBatchRow(button) {
            const row = button.closest('tr');
            if (row && row.parentNode) {
                const tbody = row.parentNode;
                if (tbody.querySelectorAll('tr').length > 1) {
                    row.remove();
                } else {
                    showNotification('É necessário pelo menos um item.', 'warning');
                }
            }
        }

        function validateEpiForm() {
            const epiName = document.getElementById('epiName')?.value.trim();
            const caNumber = document.getElementById('caNumber')?.value.trim();
            const code = document.getElementById('code')?.value.trim();
            const status = document.getElementById('status')?.value;
            const category = document.getElementById('category')?.value;
            const conformity = document.getElementById('conformity')?.value;

            if (!epiName) {
                showNotification('Informe o nome do EPI.', 'error');
                return false;
            }

            if (!caNumber) {
                showNotification('Informe o número do CA.', 'error');
                return false;
            }

            if (!code) {
                showNotification('Informe o código do EPI.', 'error');
                return false;
            }

            if (!status) {
                showNotification('Selecione o status do EPI.', 'error');
                return false;
            }

            if (!category) {
                showNotification('Selecione a categoria do EPI.', 'error');
                return false;
            }

            if (!conformity) {
                showNotification('Selecione a conformidade NR-6.', 'error');
                return false;
            }

            if (epis.some(epi => epi.code.toLowerCase() === code.toLowerCase())) {
                showNotification('Código do EPI já existe no sistema.', 'error');
                return false;
            }

            const rows = document.querySelectorAll('#batchTableBody tr');
            const codes = new Set([code]);

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const batchCode = row.querySelector('.batch-code')?.value.trim();

                if (batchCode) {
                    if (codes.has(batchCode)) {
                        showNotification(`Código ${batchCode} duplicado.`, 'error');
                        return false;
                    }

                    if (epis.some(epi => epi.code.toLowerCase() === batchCode.toLowerCase())) {
                        showNotification(`Código ${batchCode} já existe no sistema.`, 'error');
                        return false;
                    }

                    codes.add(batchCode);
                }
            }

            return true;
        }

        async function saveEpi(saveAndContinue = false) {
            if (!validateEpiForm()) {
                return false;
            }

            try {
                const mainEpi = {
                    id: Date.now(),
                    name: document.getElementById('epiName').value.trim(),
                    code: document.getElementById('code').value.trim(),
                    category: document.getElementById('category').value,
                    caNumber: document.getElementById('caNumber').value.trim(),
                    manufacturer: document.getElementById('manufacturer').value.trim(),
                    status: document.getElementById('status').value,
                    quantity: parseInt(document.getElementById('quantity').value) || 1,
                    conformity: document.getElementById('conformity').value,
                    inspectionObservations: document.getElementById('inspectionObservations').value.trim(),
                    inspectionDate: document.getElementById('inspectionDate').value,
                    nextInspectionDate: document.getElementById('nextInspectionDate').value,
                    stockMin: parseInt(document.getElementById('stockMin').value) || 0,
                    image: document.getElementById('epiImageBase64').value,
                    usuarioCadastro: currentUser ? currentUser.name : 'Sistema',
                    dataCadastro: new Date().toISOString().split('T')[0],
                    createdAt: new Date().toISOString()
                };

                epis.push(mainEpi);

                const rows = document.querySelectorAll('#batchTableBody tr');
                const batchEpis = [];

                rows.forEach(row => {
                    const code = row.querySelector('.batch-code')?.value.trim();
                    const quantity = parseInt(row.querySelector('.batch-quantity')?.value) || 1;
                    const observations = row.querySelector('.batch-observations')?.value.trim();

                    if (code) {
                        const batchEpi = {
                            ...mainEpi,
                            id: Date.now() + Math.floor(Math.random() * 1000),
                            code: code,
                            quantity: quantity,
                            inspectionObservations: observations || mainEpi.inspectionObservations
                        };

                        batchEpis.push(batchEpi);
                    }
                });

                epis.push(...batchEpis);

                await saveAllData();

                updateDashboardStats();
                loadEpisList();

                if (!saveAndContinue) {
                    clearEpiForm();
                    showNotification(`EPI${batchEpis.length > 0 ? 's' : ''} cadastrado${batchEpis.length > 0 ? 's' : ''} com sucesso! Total: ${1 + batchEpis.length}`, 'success');
                } else {
                    clearEpiFormExceptMain();
                    showNotification('EPI salvo. Continue cadastrando...', 'success');
                }

                return true;

            } catch (error) {
                console.error('Erro ao salvar EPI:', error);
                showNotification('Erro ao salvar EPI(s).', 'error');
                return false;
            }
        }

        function clearEpiForm() {
            const epiForm = document.getElementById('epiForm');
            if (epiForm) epiForm.reset();

            const batchTableBody = document.getElementById('batchTableBody');
            if (batchTableBody) batchTableBody.innerHTML = '';

            document.getElementById('epiImageBase64').value = '';
            const epiImagePreview = document.getElementById('epiImagePreview');
            if (epiImagePreview) epiImagePreview.style.display = 'none';

            const cameraPlaceholder = document.getElementById('cameraPlaceholder');
            if (cameraPlaceholder) cameraPlaceholder.style.display = 'block';

            const clearPhotoBtn = document.getElementById('clearPhotoBtn');
            if (clearPhotoBtn) clearPhotoBtn.style.display = 'none';

            const timestamp = Date.now();
            const randomNum = Math.floor(Math.random() * 1000);
            const codeInput = document.getElementById('code');
            if (codeInput) codeInput.value = `EPI-${timestamp.toString().slice(-6)}-${randomNum}`;

            const today = new Date().toISOString().split('T')[0];
            const inspectionDateInput = document.getElementById('inspectionDate');
            if (inspectionDateInput) inspectionDateInput.value = today;

            addBatchRow();
        }

        function clearEpiFormExceptMain() {
            const batchTableBody = document.getElementById('batchTableBody');
            if (batchTableBody) batchTableBody.innerHTML = '';

            const timestamp = Date.now();
            const randomNum = Math.floor(Math.random() * 1000);
            const codeInput = document.getElementById('code');
            if (codeInput) codeInput.value = `EPI-${timestamp.toString().slice(-6)}-${randomNum}`;

            const quantityInput = document.getElementById('quantity');
            if (quantityInput) quantityInput.value = 1;

            const inspectionObservationsInput = document.getElementById('inspectionObservations');
            if (inspectionObservationsInput) inspectionObservationsInput.value = '';

            const stockMinInput = document.getElementById('stockMin');
            if (stockMinInput) stockMinInput.value = 0;

            document.getElementById('epiImageBase64').value = '';
            const epiImagePreview = document.getElementById('epiImagePreview');
            if (epiImagePreview) epiImagePreview.style.display = 'none';

            const cameraPlaceholder = document.getElementById('cameraPlaceholder');
            if (cameraPlaceholder) cameraPlaceholder.style.display = 'block';

            const clearPhotoBtn = document.getElementById('clearPhotoBtn');
            if (clearPhotoBtn) clearPhotoBtn.style.display = 'none';

            addBatchRow();
        }

        // ============================================
        // LISTAGEM DE EPIs
        // ============================================
        function loadEpisList(filter = 'all') {
            const tbody = document.getElementById('episTableBody');
            if (!tbody) return;

            let filteredEpis = epis;

            if (filter === 'available') {
                filteredEpis = epis.filter(epi => epi.status === 'Disponível');
            }

            const searchTermInput = document.getElementById('searchEpi');
            const searchTerm = searchTermInput ? searchTermInput.value.toLowerCase() : '';

            if (searchTerm) {
                filteredEpis = filteredEpis.filter(epi =>
                    epi.name.toLowerCase().includes(searchTerm) ||
                    epi.code.toLowerCase().includes(searchTerm) ||
                    epi.caNumber.toLowerCase().includes(searchTerm) ||
                    epi.category.toLowerCase().includes(searchTerm)
                );
            }

            if (filteredEpis.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 40px; color: var(--gray-color);">
                            Nenhum EPI encontrado${searchTerm ? ' para "' + searchTerm + '"' : ''}
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';
            filteredEpis.forEach(epi => {
                html += `
                    <tr>
                        <td>
                            ${currentUser && (currentUser.role === 'dev' || currentUser.role === 'almoxarife') ? `
                                <input type="checkbox" class="epi-checkbox" value="${epi.id}">
                            ` : ''}
                        </td>
                        <td><strong>${epi.code}</strong></td>
                        <td>${epi.name}</td>
                        <td>${epi.category}</td>
                        <td>${epi.caNumber}</td>
                        <td><span class="status-badge ${getStatusClass(epi.status)}">${epi.status}</span></td>
                        <td>
    <strong>${epi.quantity}</strong> em estoque
    ${getActiveAssignmentsCount(epi.id) > 0 ?
                        `<br><small style="color: var(--secondary-color); font-size: 11px;">
            <i class="fas fa-helmet-safety"></i> ${getActiveAssignmentsCount(epi.id)} em uso
        </small>` :
                        ''
                    }
</td>
                        <td>${epi.manufacturer || '-'}</td>
                        <!-- AÇÕES -->
                        <td>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button class="btn btn-sm btn-primary" onclick="viewEpiDetails(${epi.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${currentUser && currentUser.role !== 'colaborador' ? `
                                    <button class="btn btn-sm btn-warning" onclick="editEpi(${epi.id})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                        <!-- MINIATURA -->
                        <td>
                            ${epi.image ?
                        `<img src="${epi.image}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px; cursor: pointer; border: 1px solid #ddd;" onclick="viewImage('${epi.image.replace(/'/g, "\\'")}')">` :
                        `<div style="width: 40px; height: 40px; background: #f5f5f5; border-radius: 4px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-image" style="color: #999; font-size: 16px;"></i>
                                </div>`
                    }
                        </td>
                        <!-- DELEÇÃO -->
                        <td style="text-align: right; padding-right: 10px;">
                            <div style="display: flex; justify-content: flex-end;">
                                ${currentUser && (currentUser.role === 'dev' || currentUser.role === 'almoxarife') ? `
                                    <button class="btn btn-sm btn-danger" onclick="deleteEpi(${epi.id})" title="Deletar EPI" style="margin-right: 10px;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        function getStatusClass(status) {
            switch (status) {
                case 'Disponível': return 'status-completed'; // Verde
                case 'Em Uso': return 'status-ontrack'; // Azul
                case 'Manutenção': return 'status-delayed'; // Laranja/Amarelo
                case 'Danificado': return 'status-delayed'; // Laranja/Amarelo
                case 'Descartado': return 'status-delayed'; // Laranja/Amarelo
                case 'Vencido': return 'status-delayed'; // Vermelho (corrigido)
                default: return 'status-ontrack'; // Azul padrão
            }
        }
        function getTotalEpiCount() {
            let totalCount = 0;

            epis.forEach(epi => {
                // Somar a quantidade de cada EPI
                totalCount += epi.quantity || 1;
            });

            return totalCount;
        }

        function getTotalEpiItems() {
            // Retorna o número de itens únicos (códigos diferentes)
            return epis.length;
        }

        // ============================================
        // FUNÇÃO PARA DELETAR EPI
        // ============================================
        window.deleteEpi = async function (epiId) {
            if (!currentUser || (currentUser.role !== 'dev' && currentUser.role !== 'almoxarife')) {
                showNotification('Usuário não tem permissão para deletar EPIs.', 'error');
                return;
            }

            const epi = epis.find(e => e.id === epiId);
            if (!epi) {
                showNotification('EPI não encontrado.', 'error');
                return;
            }

            const isAssigned = assignments.some(a => a.epiId === epiId && a.status === 'Ativo');
            if (isAssigned) {
                showNotification(`Não é possível deletar o EPI "${epi.name}" porque está atribuído a um colaborador.`, 'error');
                return;
            }

            if (!confirm(`Tem certeza que deseja deletar o EPI "${epi.name}" (${epi.code})?\n\nEsta ação não pode ser desfeita.`)) {
                return;
            }

            try {
                const epiIndex = epis.findIndex(e => e.id === epiId);
                if (epiIndex !== -1) {
                    epis.splice(epiIndex, 1);
                }

                const assignmentIndex = assignments.findIndex(a => a.epiId === epiId);
                if (assignmentIndex !== -1) {
                    assignments.splice(assignmentIndex, 1);
                }

                await saveAllData();

                loadEpisList();
                updateDashboardStats();
                updateCategoryChart();

                showNotification(`EPI "${epi.name}" deletado com sucesso!`, 'success');

            } catch (error) {
                console.error('Erro ao deletar EPI:', error);
                showNotification('Erro ao deletar EPI.', 'error');
            }
        };

        window.deleteSelectedEpis = async function () {
            const checkboxes = document.querySelectorAll('.epi-checkbox:checked');
            if (checkboxes.length === 0) {
                showNotification('Selecione pelo menos um EPI para deletar.', 'warning');
                return;
            }

            const selectedEpis = Array.from(checkboxes).map(cb => {
                const epiId = parseInt(cb.value);
                return epis.find(e => e.id === epiId);
            }).filter(epi => epi);

            const episInUse = selectedEpis.filter(epi => {
                return assignments.some(a => a.epiId === epi.id && a.status === 'Ativo');
            });

            if (episInUse.length > 0) {
                const epiNames = episInUse.map(epi => epi.name).join(', ');
                showNotification(`Não é possível deletar os seguintes EPIs porque estão atribuídos: ${epiNames}`, 'error');
                return;
            }

            const confirmMessage = selectedEpis.length === 1
                ? `Tem certeza que deseja deletar o EPI "${selectedEpis[0].name}"?`
                : `Tem certeza que deseja deletar ${selectedEpis.length} EPIs?\n\nEsta ação não pode ser desfeita.`;

            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                for (const epi of selectedEpis) {
                    const epiIndex = epis.findIndex(e => e.id === epi.id);
                    if (epiIndex !== -1) {
                        epis.splice(epiIndex, 1);

                        const assignmentIndex = assignments.findIndex(a => a.epiId === epi.id);
                        if (assignmentIndex !== -1) {
                            assignments.splice(assignmentIndex, 1);
                        }
                    }
                }

                await saveAllData();

                loadEpisList();
                updateDashboardStats();
                updateCategoryChart();

                showNotification(`${selectedEpis.length} EPI(s) deletado(s) com sucesso!`, 'success');

            } catch (error) {
                console.error('Erro ao deletar EPIs:', error);
                showNotification('Erro ao deletar EPIs selecionados.', 'error');
            }
        };

        // ============================================
        // COLABORADORES
        // ============================================
        function loadCollaboratorsList() {
            const container = document.getElementById('collaboratorsList');
            if (!container) return;

            if (collaborators.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--gray-color); padding: 40px 0;">Nenhum colaborador cadastrado.</p>';
                const deleteSelectedBtn = document.getElementById('deleteSelectedCollaboratorsBtn');
                if (deleteSelectedBtn) deleteSelectedBtn.style.display = 'none';
                return;
            }

            const searchTermInput = document.getElementById('searchCollaborator');
            const searchTerm = searchTermInput ? searchTermInput.value.toLowerCase() : '';

            let filteredCollaborators = collaborators;

            if (searchTerm) {
                filteredCollaborators = collaborators.filter(c =>
                    c.name.toLowerCase().includes(searchTerm) ||
                    c.registration.toLowerCase().includes(searchTerm) ||
                    c.sector.toLowerCase().includes(searchTerm) ||
                    c.position.toLowerCase().includes(searchTerm)
                );
            }

            if (filteredCollaborators.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--gray-color); padding: 40px 0;">Nenhum colaborador encontrado.</p>';
                const deleteSelectedBtn = document.getElementById('deleteSelectedCollaboratorsBtn');
                if (deleteSelectedBtn) deleteSelectedBtn.style.display = 'none';
                return;
            }

            let html = '';
            filteredCollaborators.forEach(collaborator => {
                const assignedEpis = assignments.filter(a => a.collaboratorId === collaborator.id && a.status === 'Ativo');

                html += `
                    <div class="collaborator-card">
                        <div class="collaborator-header">
                            <div class="collaborator-name">${collaborator.name}</div>
                            <span class="status-badge ${collaborator.status === 'Ativo' ? 'status-completed' : 'status-delayed'}">
                                ${collaborator.status}
                            </span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">
                            <div><strong>Matrícula:</strong> ${collaborator.registration}</div>
                            <div><strong>Setor:</strong> ${collaborator.sector}</div>
                            <div><strong>Cargo:</strong> ${collaborator.position}</div>
                            <div><strong>Data Admissão:</strong> ${formatDate(collaborator.admissionDate)}</div>
                        </div>
                        ${collaborator.observations ? `
                            <div style="margin-bottom: 15px;">
                                <strong>Observações:</strong>
                                <p style="color: var(--gray-color); font-size: 14px;">${collaborator.observations}</p>
                            </div>
                        ` : ''}
                        <div>
                            <h4 style="margin-bottom: 10px; color: var(--primary-color);">EPIs Atribuídos: ${assignedEpis.length}</h4>
                            ${assignedEpis.length > 0 ?
                        assignedEpis.map(assignment => {
                            const epi = epis.find(e => e.id === assignment.epiId);
                            const daysLeft = getDaysLeft(assignment.expirationDate);
                            return epi ? `
                                        <div style="padding: 8px; background: #f8f9fa; margin-bottom: 5px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <strong>${epi.name}</strong> (${epi.code})
                                                <p style="font-size: 12px; color: var(--gray-color); margin: 2px 0;">
                                                    Atribuído em: ${formatDate(assignment.assignmentDate)} | Vence: ${formatDate(assignment.expirationDate)}
                                                </p>
                                            </div>
                                            <span class="days-left ${daysLeft <= 0 ? 'expired' : daysLeft <= 30 ? 'expiring' : 'ok'}">
                                                ${daysLeft <= 0 ? 'Vencido' : `${daysLeft} dias`}
                                            </span>
                                        </div>
                                    ` : '';
                        }).join('') :
                        '<p style="color: var(--gray-color); text-align: center;">Nenhum EPI atribuído</p>'
                    }
                        </div>
                        <div class="collaborator-actions" style="margin-top: 15px;">
                            <button class="btn btn-sm btn-primary" onclick="editCollaborator(${collaborator.id})" title="Editar Colaborador">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button class="btn btn-sm btn-success" onclick="assignEpiToCollaborator(${collaborator.id})" title="Atribuir EPI">
                                <i class="fas fa-hard-hat"></i> Atribuir EPI
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteCollaborator(${collaborator.id})" title="Deletar Colaborador">
                                <i class="fas fa-trash"></i> Deletar
                            </button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;

            const deleteSelectedBtn = document.getElementById('deleteSelectedCollaboratorsBtn');
            if (deleteSelectedBtn) {
                if (filteredCollaborators.length > 0 && currentUser && (currentUser.role === 'dev' || currentUser.role === 'seguranca')) {
                    deleteSelectedBtn.style.display = 'inline-block';
                } else {
                    deleteSelectedBtn.style.display = 'none';
                }
            }
        }

        window.editCollaborator = function (collaboratorId) {
            if (!currentUser || currentUser.role === 'colaborador') {
                showNotification('Usuário não tem permissão para editar colaboradores.', 'error');
                return;
            }

            const collaborator = collaborators.find(c => c.id === collaboratorId);
            if (!collaborator) {
                showNotification('Colaborador não encontrado.', 'error');
                return;
            }

            document.getElementById('collaboratorName').value = collaborator.name;
            document.getElementById('collaboratorRegistration').value = collaborator.registration;
            document.getElementById('collaboratorSector').value = collaborator.sector;
            document.getElementById('collaboratorPosition').value = collaborator.position;
            document.getElementById('collaboratorAdmissionDate').value = collaborator.admissionDate;
            document.getElementById('collaboratorStatus').value = collaborator.status;
            document.getElementById('collaboratorObservations').value = collaborator.observations || '';

            const modalTitle = document.querySelector('#collaboratorModal .modal-title');
            if (modalTitle) modalTitle.textContent = 'Editar Colaborador';

            editingCollaboratorId = collaboratorId;

            const collaboratorModal = document.getElementById('collaboratorModal');
            if (collaboratorModal) collaboratorModal.style.display = 'flex';
        };

        window.deleteCollaborator = async function (collaboratorId) {
            if (!currentUser || (currentUser.role !== 'dev' && currentUser.role !== 'seguranca')) {
                showNotification('Usuário não tem permissão para deletar colaboradores.', 'error');
                return;
            }

            const collaborator = collaborators.find(c => c.id === collaboratorId);
            if (!collaborator) {
                showNotification('Colaborador não encontrado.', 'error');
                return;
            }

            const hasAssignments = assignments.some(a => a.collaboratorId === collaboratorId && a.status === 'Ativo');
            if (hasAssignments) {
                showNotification(`Não é possível deletar o colaborador "${collaborator.name}" porque tem EPIs atribuídos.`, 'error');
                return;
            }

            if (!confirm(`Tem certeza que deseja deletar o colaborador "${collaborator.name}" (${collaborator.registration})?\n\nEsta ação não pode ser desfeita.`)) {
                return;
            }

            try {
                const collaboratorIndex = collaborators.findIndex(c => c.id === collaboratorId);
                if (collaboratorIndex !== -1) {
                    collaborators.splice(collaboratorIndex, 1);
                }

                const assignmentIndexes = assignments
                    .map((a, index) => a.collaboratorId === collaboratorId ? index : -1)
                    .filter(index => index !== -1)
                    .reverse();

                assignmentIndexes.forEach(index => {
                    assignments.splice(index, 1);
                });

                await saveAllData();

                loadCollaboratorsList();
                updateDashboardStats();
                updateSectorStats();

                showNotification(`Colaborador "${collaborator.name}" deletado com sucesso!`, 'success');

            } catch (error) {
                console.error('Erro ao deletar colaborador:', error);
                showNotification('Erro ao deletar colaborador.', 'error');
            }
        };

        window.assignEpiToCollaborator = function (collaboratorId) {
            if (!currentUser || currentUser.role === 'colaborador') {
                showNotification('Usuário não tem permissão para atribuir EPIs.', 'error');
                return;
            }

            const collaborator = collaborators.find(c => c.id === collaboratorId);
            if (!collaborator) {
                showNotification('Colaborador não encontrado.', 'error');
                return;
            }

            const assignCollaboratorSelect = document.getElementById('assignCollaborator');
            if (!assignCollaboratorSelect) return;

            assignCollaboratorSelect.innerHTML = '<option value="">Selecione o colaborador</option>';
            collaborators.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = `${c.name} (${c.registration})`;
                if (c.id === collaboratorId) {
                    option.selected = true;
                }
                assignCollaboratorSelect.appendChild(option);
            });

            // Usar a nova função para atualizar o dropdown
            updateAssignEpiDropdown();

            const today = new Date().toISOString().split('T')[0];
            const assignDateInput = document.getElementById('assignDate');
            if (assignDateInput) assignDateInput.value = today;

            const nextYear = new Date();
            nextYear.setFullYear(nextYear.getFullYear() + 1);
            const assignExpirationDateInput = document.getElementById('assignExpirationDate');
            if (assignExpirationDateInput) assignExpirationDateInput.value = nextYear.toISOString().split('T')[0];

            const assignEpiModal = document.getElementById('assignEpiModal');
            if (assignEpiModal) assignEpiModal.style.display = 'flex';
        };

        function validateCollaboratorForm() {
            const name = document.getElementById('collaboratorName')?.value.trim();
            const registration = document.getElementById('collaboratorRegistration')?.value.trim();
            const sector = document.getElementById('collaboratorSector')?.value;
            const position = document.getElementById('collaboratorPosition')?.value.trim();
            const admissionDate = document.getElementById('collaboratorAdmissionDate')?.value;
            const status = document.getElementById('collaboratorStatus')?.value;

            if (!name) {
                showNotification('Informe o nome do colaborador.', 'error');
                return false;
            }

            if (!registration) {
                showNotification('Informe a matrícula do colaborador.', 'error');
                return false;
            }

            if (!sector) {
                showNotification('Selecione o setor do colaborador.', 'error');
                return false;
            }

            if (!position) {
                showNotification('Informe o cargo do colaborador.', 'error');
                return false;
            }

            if (!admissionDate) {
                showNotification('Informe a data de admissão.', 'error');
                return false;
            }

            if (!status) {
                showNotification('Selecione o status do colaborador.', 'error');
                return false;
            }

            const existingCollaborator = collaborators.find(c =>
                c.registration.toLowerCase() === registration.toLowerCase() &&
                (!editingCollaboratorId || c.id !== editingCollaboratorId)
            );

            if (existingCollaborator) {
                showNotification(`Matrícula ${registration} já está cadastrada para o colaborador ${existingCollaborator.name}.`, 'error');
                return false;
            }

            return true;
        }

        async function saveCollaborator() {
            if (!validateCollaboratorForm()) {
                return false;
            }

            try {
                const collaboratorData = {
                    id: editingCollaboratorId || Date.now(),
                    name: document.getElementById('collaboratorName').value.trim(),
                    registration: document.getElementById('collaboratorRegistration').value.trim(),
                    sector: document.getElementById('collaboratorSector').value,
                    position: document.getElementById('collaboratorPosition').value.trim(),
                    admissionDate: document.getElementById('collaboratorAdmissionDate').value,
                    status: document.getElementById('collaboratorStatus').value,
                    observations: document.getElementById('collaboratorObservations').value.trim(),
                    usuarioCadastro: currentUser ? currentUser.name : 'Sistema',
                    dataCadastro: new Date().toISOString().split('T')[0],
                    createdAt: new Date().toISOString()
                };

                if (editingCollaboratorId) {
                    const index = collaborators.findIndex(c => c.id === editingCollaboratorId);
                    if (index !== -1) {
                        collaborators[index] = { ...collaborators[index], ...collaboratorData };
                    }
                } else {
                    collaborators.push(collaboratorData);
                }

                await saveAllData();

                loadCollaboratorsList();
                updateDashboardStats();
                updateSectorStats();

                const collaboratorModal = document.getElementById('collaboratorModal');
                if (collaboratorModal) collaboratorModal.style.display = 'none';

                clearCollaboratorForm();
                editingCollaboratorId = null;

                const message = editingCollaboratorId ?
                    `Colaborador "${collaboratorData.name}" atualizado com sucesso!` :
                    `Colaborador "${collaboratorData.name}" cadastrado com sucesso!`;

                showNotification(message, 'success');

                return true;

            } catch (error) {
                console.error('Erro ao salvar colaborador:', error);
                showNotification('Erro ao salvar colaborador.', 'error');
                return false;
            }
        }

        function clearCollaboratorForm() {
            const collaboratorForm = document.getElementById('collaboratorForm');
            if (collaboratorForm) collaboratorForm.reset();

            const collaboratorAdmissionDateInput = document.getElementById('collaboratorAdmissionDate');
            if (collaboratorAdmissionDateInput) collaboratorAdmissionDateInput.value = new Date().toISOString().split('T')[0];

            editingCollaboratorId = null;
            const modalTitle = document.querySelector('#collaboratorModal .modal-title');
            if (modalTitle) modalTitle.textContent = 'Cadastrar Colaborador';
        }

        function validateAssignmentForm() {
            const collaboratorId = document.getElementById('assignCollaborator')?.value;
            const epiId = document.getElementById('assignEpi')?.value;
            const assignDate = document.getElementById('assignDate')?.value;
            const expirationDate = document.getElementById('assignExpirationDate')?.value;

            if (!collaboratorId) {
                showNotification('Selecione o colaborador.', 'error');
                return false;
            }

            if (!epiId) {
                showNotification('Selecione o EPI.', 'error');
                return false;
            }

            if (!assignDate) {
                showNotification('Informe a data de atribuição.', 'error');
                return false;
            }

            if (!expirationDate) {
                showNotification('Informe a data de validade.', 'error');
                return false;
            }

            const assignDateObj = new Date(assignDate);
            const expirationDateObj = new Date(expirationDate);

            if (expirationDateObj <= assignDateObj) {
                showNotification('A data de validade deve ser maior que a data de atribuição.', 'error');
                return false;
            }

            // Verificar se o EPI selecionado realmente existe e tem estoque
            const epi = epis.find(e => e.id === parseInt(epiId));
            if (!epi) {
                showNotification('EPI selecionado não encontrado.', 'error');
                return false;
            }

            const quantity = Number(epi.quantity) || 0;
            if (quantity <= 0) {
                showNotification(`EPI "${epi.name}" sem estoque disponível.`, 'error');
                return false;
            }

            return true;
        }

        async function saveAssignment() {
            if (!validateAssignmentForm()) {
                return false;
            }

            try {
                const collaboratorId = parseInt(document.getElementById('assignCollaborator').value);
                const epiId = parseInt(document.getElementById('assignEpi').value);
                const quantityToAssign = 1;

                // VERIFICAR SE O EPI EXISTE
                const epiIndex = epis.findIndex(e => e.id === epiId);
                if (epiIndex === -1) {
                    showNotification('EPI não encontrado.', 'error');
                    return false;
                }

                const epi = epis[epiIndex];

                // VERIFICAR ESTOQUE
                if (!epi.quantity || epi.quantity < quantityToAssign) {
                    showNotification(`Estoque insuficiente! Disponível: ${epi.quantity || 0} unidade(s).`, 'error');
                    return false;
                }

                // VERIFICAR SE O EPI ESTÁ DISPONÍVEL PARA RETIRADA
                if (epi.status !== 'Disponível' && epi.status !== 'Esgotado') {
                    showNotification(`EPI não está disponível para atribuição. Status atual: ${epi.status}`, 'error');
                    return false;
                }

                const assignmentData = {
                    id: Date.now(),
                    collaboratorId: collaboratorId,
                    epiId: epiId,
                    assignmentDate: document.getElementById('assignDate').value,
                    expirationDate: document.getElementById('assignExpirationDate').value,
                    status: 'Ativo',
                    observations: document.getElementById('assignObservations').value.trim(),
                    usuarioCadastro: currentUser ? currentUser.name : 'Sistema',
                    dataCadastro: new Date().toISOString().split('T')[0],
                    createdAt: new Date().toISOString(),
                    quantityAssigned: quantityToAssign
                };

                // REDUZIR ESTOQUE
                epis[epiIndex].quantity -= quantityToAssign;

                // ATUALIZAR STATUS BASEADO APENAS NA QUANTIDADE EM ESTOQUE
                if (epis[epiIndex].quantity <= 0) {
                    epis[epiIndex].status = 'Esgotado';
                    epis[epiIndex].quantity = 0; // Garantir que não fique negativo
                } else {
                    // MANTER COMO "DISPONÍVEL" ENQUANTO HOUVER ESTOQUE
                    epis[epiIndex].status = 'Disponível';
                }

                // ADICIONAR ATRIBUIÇÃO
                assignments.push(assignmentData);

                // SALVAR DADOS
                await saveAllData();

                // ATUALIZAR INTERFACES
                loadCollaboratorsList();
                loadEpisList();
                updateDashboardStats();
                updateStatistics();
                updateAssignEpiDropdown();

                // FECHAR MODAL
                const assignEpiModal = document.getElementById('assignEpiModal');
                if (assignEpiModal) assignEpiModal.style.display = 'none';

                // LIMPAR FORMULÁRIO
                clearAssignmentForm();

                // NOTIFICAÇÃO DE SUCESSO
                showNotification(
                    `✅ EPI atribuído com sucesso! 
            \nColaborador: ${collaborators.find(c => c.id === collaboratorId)?.name}
            \nEPI: ${epi.name}
            \nEstoque restante: ${epis[epiIndex].quantity} unidade(s)`,
                    'success'
                );

                return true;

            } catch (error) {
                console.error('❌ Erro ao salvar atribuição:', error);
                console.error('Stack:', error.stack);
                showNotification('Erro ao atribuir EPI. Verifique o console para mais detalhes.', 'error');
                return false;
            }
        }

        function clearAssignmentForm() {
            const assignEpiForm = document.getElementById('assignEpiForm');
            if (assignEpiForm) assignEpiForm.reset();

            const today = new Date().toISOString().split('T')[0];
            const assignDateInput = document.getElementById('assignDate');
            if (assignDateInput) assignDateInput.value = today;

            const nextYear = new Date();
            nextYear.setFullYear(nextYear.getFullYear() + 1);
            const assignExpirationDateInput = document.getElementById('assignExpirationDate');
            if (assignExpirationDateInput) assignExpirationDateInput.value = nextYear.toISOString().split('T')[0];

            // Recarregar o dropdown de EPIs
            setTimeout(() => {
                updateAssignEpiDropdown();
            }, 100);
        }


        // ============================================
        // NOVA ABA: DEVOLUÇÃO DE EPI
        // ============================================
        function initializeReturnTab() {
            const today = new Date().toISOString().split('T')[0];
            const returnDateInput = document.getElementById('returnDate');
            if (returnDateInput) returnDateInput.value = today;

            updateCollaboratorSelect();

            const selectCollaboratorReturn = document.getElementById('selectCollaboratorReturn');
            if (selectCollaboratorReturn) {
                selectCollaboratorReturn.addEventListener('change', function () {
                    const collaboratorId = this.value;
                    loadAssignedEpis(collaboratorId);
                });
            }

            const confirmReturnBtn = document.getElementById('confirmReturnBtn');
            if (confirmReturnBtn) confirmReturnBtn.addEventListener('click', confirmReturn);

            const clearReturnFormBtn = document.getElementById('clearReturnFormBtn');
            if (clearReturnFormBtn) clearReturnFormBtn.addEventListener('click', clearReturnForm);
        }
        // Garantir que todos os EPIs tenham quantidade definida
        function ensureEpiQuantities() {
            epis.forEach(epi => {
                if (epi.quantity === undefined || epi.quantity === null) {
                    epi.quantity = 1; // Valor padrão
                }
                epi.quantity = Number(epi.quantity);
                if (isNaN(epi.quantity) || epi.quantity < 0) {
                    epi.quantity = 0;
                }
            });
        }

        // Chame esta função no initializeSystem():
        // ensureEpiQuantities();
        function updateCollaboratorSelect() {
            const select = document.getElementById('selectCollaboratorReturn');
            if (!select) return;

            select.innerHTML = '<option value="">Selecione um colaborador</option>';

            if (collaborators.length === 0) {
                return;
            }

            collaborators.forEach(collaborator => {
                const hasAssignments = assignments.some(a => a.collaboratorId === collaborator.id && a.status === 'Ativo');

                if (hasAssignments) {
                    const option = document.createElement('option');
                    option.value = collaborator.id;
                    option.textContent = `${collaborator.name} (${collaborator.registration}) - ${collaborator.sector}`;
                    select.appendChild(option);
                }
            });

            if (select.options.length === 1) {
                select.innerHTML = '<option value="">Nenhum colaborador com EPIs atribuídos</option>';
            }
        }

        function loadAssignedEpis(collaboratorId) {
            const container = document.getElementById('assignedEpiList');
            const returnActions = document.getElementById('returnActions');

            if (!container) return;

            if (!collaboratorId) {
                container.innerHTML = `
                    <h3 class="form-section-title"><i class="fas fa-hard-hat"></i> EPIs Atribuídos ao Colaborador</h3>
                    <div class="no-assignments-message">
                        <i class="fas fa-info-circle" style="font-size: 40px; margin-bottom: 15px;"></i>
                        <p>Selecione um colaborador para visualizar os EPIs atribuídos.</p>
                    </div>
                `;
                if (returnActions) returnActions.style.display = 'none';
                return;
            }

            const collaborator = collaborators.find(c => c.id === parseInt(collaboratorId));
            if (!collaborator) {
                container.innerHTML = '<p style="text-align: center; color: var(--danger-color);">Colaborador não encontrado.</p>';
                if (returnActions) returnActions.style.display = 'none';
                return;
            }

            const assignedEpis = assignments
                .filter(a => a.collaboratorId === parseInt(collaboratorId) && a.status === 'Ativo')
                .map(assignment => {
                    const epi = epis.find(e => e.id === assignment.epiId);
                    return {
                        ...assignment,
                        epiName: epi ? epi.name : 'EPI não encontrado',
                        epiCode: epi ? epi.code : 'N/A',
                        epiCategory: epi ? epi.category : 'N/A',
                        epiCaNumber: epi ? epi.caNumber : 'N/A'
                    };
                });

            if (assignedEpis.length === 0) {
                container.innerHTML = `
                    <h3 class="form-section-title"><i class="fas fa-hard-hat"></i> EPIs Atribuídos ao Colaborador</h3>
                    <div class="no-assignments-message">
                        <i class="fas fa-check-circle" style="font-size: 40px; margin-bottom: 15px; color: var(--success-color);"></i>
                        <p>O colaborador <strong>${collaborator.name}</strong> não tem EPIs atribuídos no momento.</p>
                    </div>
                `;
                if (returnActions) returnActions.style.display = 'none';
                return;
            }

            let html = `
                <h3 class="form-section-title"><i class="fas fa-hard-hat"></i> EPIs Atribuídos a ${collaborator.name}</h3>
                <p style="margin-bottom: 15px; color: var(--gray-color);">Selecione os EPIs que serão devolvidos:</p>
            `;

            assignedEpis.forEach(assignment => {
                const daysLeft = getDaysLeft(assignment.expirationDate);
                const daysLeftClass = daysLeft <= 0 ? 'expired' : daysLeft <= 30 ? 'expiring' : 'ok';
                const daysLeftText = daysLeft <= 0 ? 'Vencido' : `${daysLeft} dias`;

                html += `
                    <div class="epi-return-item" data-assignment-id="${assignment.id}">
                        <div class="select-checkbox">
                            <input type="checkbox" class="epi-return-checkbox" value="${assignment.id}">
                        </div>
                        <div class="epi-info">
                            <h4>${assignment.epiName}</h4>
                            <div class="epi-details">
                                <span><strong>Código:</strong> ${assignment.epiCode}</span>
                                <span><strong>CA:</strong> ${assignment.epiCaNumber}</span>
                                <span><strong>Categoria:</strong> ${assignment.epiCategory}</span>
                                <span><strong>Atribuído em:</strong> ${formatDate(assignment.assignmentDate)}</span>
                                <span><strong>Validade:</strong> ${formatDate(assignment.expirationDate)}</span>
                            </div>
                        </div>
                        <div class="days-left ${daysLeftClass}">
                            ${daysLeftText}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            if (returnActions) returnActions.style.display = 'block';

            addCheckboxEvents();
        }

        function addCheckboxEvents() {
            const checkboxes = document.querySelectorAll('.epi-return-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    const item = this.closest('.epi-return-item');
                    if (this.checked) {
                        item.classList.add('selected');
                    } else {
                        item.classList.remove('selected');
                    }
                });
            });
        }

        async function confirmReturn() {
            const selectedCheckboxes = document.querySelectorAll('.epi-return-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                showNotification('Selecione pelo menos um EPI para devolver.', 'warning');
                return;
            }

            const selectCollaboratorReturn = document.getElementById('selectCollaboratorReturn');
            const collaboratorId = selectCollaboratorReturn ? selectCollaboratorReturn.value : null;

            if (!collaboratorId) {
                showNotification('Selecione um colaborador.', 'error');
                return;
            }

            const returnDateInput = document.getElementById('returnDate');
            const returnDate = returnDateInput ? returnDateInput.value : null;

            if (!returnDate) {
                showNotification('Informe a data de devolução.', 'error');
                return;
            }

            const returnReasonSelect = document.getElementById('returnReason');
            const returnReason = returnReasonSelect ? returnReasonSelect.value : null;

            if (!returnReason) {
                showNotification('Selecione o motivo da devolução.', 'error');
                return;
            }

            const returnConditionSelect = document.getElementById('returnCondition');
            const returnCondition = returnConditionSelect ? returnConditionSelect.value : null;

            if (!returnCondition) {
                showNotification('Selecione a condição do EPI.', 'error');
                return;
            }

            const collaborator = collaborators.find(c => c.id === parseInt(collaboratorId));
            if (!collaborator) {
                showNotification('Colaborador não encontrado.', 'error');
                return;
            }

            const confirmMessage = selectedCheckboxes.length === 1
                ? `Confirmar devolução do EPI selecionado para ${collaborator.name}?`
                : `Confirmar devolução de ${selectedCheckboxes.length} EPIs para ${collaborator.name}?`;

            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                const returnObservationsInput = document.getElementById('returnObservations');
                const returnObservations = returnObservationsInput ? returnObservationsInput.value.trim() : '';

                for (const checkbox of selectedCheckboxes) {
                    const assignmentId = parseInt(checkbox.value);
                    const assignmentIndex = assignments.findIndex(a => a.id === assignmentId);

                    if (assignmentIndex !== -1) {
                        const assignment = assignments[assignmentIndex];

                        // ===== LÓGICA DE DEVOLUÇÃO AO ESTOQUE =====
                        const epiIndex = epis.findIndex(e => e.id === assignment.epiId);
                        if (epiIndex !== -1) {
                            // Devolver 1 unidade ao estoque
                            epis[epiIndex].quantity += 1;

                            // SEMPRE MANTER COMO "DISPONÍVEL" QUANDO TIVER ESTOQUE
                            if (epis[epiIndex].quantity > 0) {
                                epis[epiIndex].status = 'Disponível';
                            }

                            console.log(`📦 Devolução: ${epis[epiIndex].name} - Estoque atualizado para ${epis[epiIndex].quantity}`);
                        }
                        // ==========================================

                        assignments[assignmentIndex] = {
                            ...assignment,
                            status: 'Devolvido',
                            returnDate: returnDate,
                            returnReason: returnReason,
                            returnCondition: returnCondition,
                            returnObservations: returnObservations,
                            returnedBy: currentUser ? currentUser.name : 'Sistema'
                        };
                    }
                }

                await saveAllData();

                loadAssignedEpis(collaboratorId);
                loadEpisList();
                loadCollaboratorsList();
                updateDashboardStats();
                updateStatistics();
                updateAssignEpiDropdown();

                showNotification(`${selectedCheckboxes.length} EPI(s) devolvido(s) com sucesso!`, 'success');

                setTimeout(() => {
                    clearReturnForm();
                }, 2000);

            } catch (error) {
                console.error('Erro ao processar devolução:', error);
                showNotification('Erro ao processar devolução.', 'error');
            }
        }

        function clearReturnForm() {
            const selectCollaboratorReturn = document.getElementById('selectCollaboratorReturn');
            if (selectCollaboratorReturn) selectCollaboratorReturn.value = '';

            const returnDateInput = document.getElementById('returnDate');
            if (returnDateInput) returnDateInput.value = new Date().toISOString().split('T')[0];

            const returnReasonSelect = document.getElementById('returnReason');
            if (returnReasonSelect) returnReasonSelect.value = '';

            const returnConditionSelect = document.getElementById('returnCondition');
            if (returnConditionSelect) returnConditionSelect.value = '';

            const returnObservationsInput = document.getElementById('returnObservations');
            if (returnObservationsInput) returnObservationsInput.value = '';

            const container = document.getElementById('assignedEpiList');
            if (container) {
                container.innerHTML = `
                    <h3 class="form-section-title"><i class="fas fa-hard-hat"></i> EPIs Atribuídos ao Colaborador</h3>
                    <div class="no-assignments-message">
                        <i class="fas fa-info-circle" style="font-size: 40px; margin-bottom: 15px;"></i>
                        <p>Selecione um colaborador para visualizar os EPIs atribuídos.</p>
                    </div>
                `;
            }

            const returnActions = document.getElementById('returnActions');
            if (returnActions) returnActions.style.display = 'none';

            updateCollaboratorSelect();
        }

        // ============================================
        // ABA DE AVARIAS
        // ============================================
        function initializeDamageTab() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('damageDate').value = today;

            populateEpiDropdown();
            populateResponsibleDropdown();

            loadDamageHistory();

            document.getElementById('searchDamage')?.addEventListener('input', loadDamageHistory);

            updateDamageSyncStatus();
        }

        function populateEpiDropdown() {
            const select = document.getElementById('damageEpiSelect');
            if (!select) return;

            select.innerHTML = '<option value="">Selecione o EPI</option>';

            const availableEpis = epis.filter(epi =>
                epi.status === 'Em Uso' || epi.status === 'Disponível' || epi.status === 'Danificado'
            );

            if (availableEpis.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Nenhum EPI disponível';
                select.appendChild(option);
                return;
            }

            availableEpis.forEach(epi => {
                const option = document.createElement('option');
                option.value = epi.id;
                option.textContent = `${epi.name} (${epi.code}) - ${epi.status}`;
                select.appendChild(option);
            });
        }

        function populateResponsibleDropdown() {
            const select = document.getElementById('damageResponsible');
            if (!select) return;

            select.innerHTML = '<option value="">Selecione o responsável</option>';

            if (collaborators.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Nenhum colaborador cadastrado';
                select.appendChild(option);
                return;
            }

            collaborators.forEach(collaborator => {
                const option = document.createElement('option');
                option.value = collaborator.id;
                option.textContent = `${collaborator.name} (${collaborator.registration})`;
                select.appendChild(option);
            });
        }

        function validateDamageForm() {
            const epiId = document.getElementById('damageEpiSelect').value;
            const date = document.getElementById('damageDate').value;
            const reason = document.getElementById('damageReason').value;
            const responsible = document.getElementById('damageResponsible').value;
            const description = document.getElementById('damageDescription').value.trim();

            if (!epiId) {
                showNotification('Selecione o EPI avariado.', 'error');
                return false;
            }

            if (!date) {
                showNotification('Informe a data da avaria.', 'error');
                return false;
            }

            if (!reason) {
                showNotification('Selecione o motivo da avaria.', 'error');
                return false;
            }

            if (!responsible) {
                showNotification('Selecione o responsável.', 'error');
                return false;
            }

            if (!description) {
                showNotification('Descreva a avaria.', 'error');
                return false;
            }

            return true;
        }

        async function saveDamage() {
            if (!validateDamageForm()) {
                return;
            }

            try {
                const damageData = {
                    id: Date.now(),
                    epiId: parseInt(document.getElementById('damageEpiSelect').value),
                    date: document.getElementById('damageDate').value,
                    reason: document.getElementById('damageReason').value,
                    responsibleId: parseInt(document.getElementById('damageResponsible').value),
                    description: document.getElementById('damageDescription').value.trim(),
                    solution: document.getElementById('damageSolution').value || '',
                    observations: document.getElementById('damageObservations').value.trim() || '',
                    reportedBy: currentUser ? currentUser.name : 'Sistema',
                    createdAt: new Date().toISOString(),
                    status: 'Registrada'
                };

                const epiIndex = epis.findIndex(e => e.id === damageData.epiId);
                if (epiIndex !== -1) {
                    epis[epiIndex].status = 'Danificado';
                }

                damages.push(damageData);

                await saveAllData();

                populateEpiDropdown();
                loadDamageHistory();

                clearDamageForm();

                showNotification('Avaria registrada com sucesso!', 'success');

            } catch (error) {
                console.error('Erro ao salvar avaria:', error);
                showNotification('Erro ao registrar avaria.', 'error');
            }
        }

        function clearDamageForm() {
            const form = document.getElementById('damageForm');
            if (form) form.reset();

            document.getElementById('damageDate').value = new Date().toISOString().split('T')[0];

            populateEpiDropdown();
            populateResponsibleDropdown();
        }

        function loadDamageHistory() {
            const container = document.getElementById('damageHistory');
            if (!container) return;

            const searchTermInput = document.getElementById('searchDamage');
            const searchTerm = searchTermInput ? searchTermInput.value.toLowerCase() : '';

            let filteredDamages = damages;

            if (searchTerm) {
                filteredDamages = damages.filter(damage => {
                    const epi = epis.find(e => e.id === damage.epiId);
                    const responsible = collaborators.find(c => c.id === damage.responsibleId);

                    const epiName = epi ? epi.name.toLowerCase() : '';
                    const epiCode = epi ? epi.code.toLowerCase() : '';
                    const responsibleName = responsible ? responsible.name.toLowerCase() : '';

                    return epiName.includes(searchTerm) ||
                        epiCode.includes(searchTerm) ||
                        damage.reason.toLowerCase().includes(searchTerm) ||
                        responsibleName.includes(searchTerm) ||
                        damage.description.toLowerCase().includes(searchTerm);
                });
            }

            if (filteredDamages.length === 0) {
                container.innerHTML = `
                    <p style="text-align: center; color: var(--gray-color); padding: 40px 0;">
                        ${searchTerm ? 'Nenhuma avaria encontrada para "' + searchTerm + '"' : 'Nenhuma avaria registrada.'}
                    </p>
                `;
                return;
            }

            filteredDamages.sort((a, b) => new Date(b.date) - new Date(a.date));

            let html = '';
            filteredDamages.forEach(damage => {
                const epi = epis.find(e => e.id === damage.epiId);
                const responsible = collaborators.find(c => c.id === damage.responsibleId);

                if (!epi) return;

                const daysAgo = getDaysDifference(damage.date);

                html += `
                    <div class="damage-card" style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid var(--warning-color);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div>
                                <h4 style="margin-bottom: 5px; color: var(--primary-color);">${epi.name}</h4>
                                <div style="display: flex; flex-wrap: wrap; gap: 10px; font-size: 14px; color: var(--gray-color);">
                                    <span><strong>Código:</strong> ${epi.code}</span>
                                    <span><strong>CA:</strong> ${epi.caNumber}</span>
                                    <span><strong>Data:</strong> ${formatDate(damage.date)} (${daysAgo} dias atrás)</span>
                                </div>
                            </div>
                            <span class="status-badge status-delayed" style="white-space: nowrap;">
                                ${damage.reason}
                            </span>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-bottom: 10px;">
                                <div><strong>Responsável:</strong> ${responsible ? responsible.name : 'Não identificado'}</div>
                                <div><strong>Solução:</strong> ${damage.solution || 'Pendente'}</div>
                                <div><strong>Status:</strong> ${damage.status}</div>
                                <div><strong>Registrado por:</strong> ${damage.reportedBy}</div>
                            </div>
                            
                            <div style="margin-bottom: 10px;">
                                <strong>Descrição:</strong>
                                <p style="color: var(--text-color); padding: 8px; background: #f8f9fa; border-radius: 4px; margin-top: 5px;">${damage.description}</p>
                            </div>
                            
                            ${damage.observations ? `
                                <div style="margin-bottom: 10px;">
                                    <strong>Observações:</strong>
                                    <p style="color: var(--gray-color); padding: 8px; background: #f8f9fa; border-radius: 4px; margin-top: 5px;">${damage.observations}</p>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end; border-top: 1px solid var(--border-color); padding-top: 15px;">
                            <button class="btn btn-sm btn-warning" onclick="editDamage(${damage.id})" title="Editar Avaria">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteDamage(${damage.id})" title="Deletar Avaria">
                                <i class="fas fa-trash"></i> Deletar
                            </button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function getDaysDifference(dateString) {
            if (!dateString) return 0;
            try {
                const date = new Date(dateString);
                const today = new Date();
                const diffTime = Math.abs(today - date);
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            } catch (e) {
                return 0;
            }
        }
        function getStatusClass(status) {
            switch (status) {
                case 'Disponível': return 'status-completed'; // Verde
                case 'Esgotado': return 'status-delayed'; // Laranja/Amarelo (adicionar esta linha)
                case 'Em Uso': return 'status-ontrack'; // Azul
                case 'Manutenção': return 'status-delayed'; // Laranja/Amarelo
                case 'Danificado': return 'status-delayed'; // Laranja/Amarelo
                case 'Descartado': return 'status-delayed'; // Laranja/Amarelo
                case 'Vencido': return 'status-delayed'; // Vermelho
                default: return 'status-ontrack'; // Azul padrão
            }
        }

        window.editDamage = function (damageId) {
            const damage = damages.find(d => d.id === damageId);
            if (!damage) {
                showNotification('Avaria não encontrada.', 'error');
                return;
            }

            document.getElementById('damageEpiSelect').value = damage.epiId;
            document.getElementById('damageDate').value = damage.date;
            document.getElementById('damageReason').value = damage.reason;
            document.getElementById('damageResponsible').value = damage.responsibleId;
            document.getElementById('damageDescription').value = damage.description;
            document.getElementById('damageSolution').value = damage.solution || '';
            document.getElementById('damageObservations').value = damage.observations || '';

            const damageIndex = damages.findIndex(d => d.id === damageId);
            if (damageIndex !== -1) {
                damages.splice(damageIndex, 1);
            }

            saveAllData();

            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            document.querySelector('[data-tab="cadastro-avarias"]').classList.add('active');
            document.getElementById('cadastro-avarias').classList.add('active');

            showNotification('Avaria carregada para edição. Faça as alterações e salve novamente.', 'success');
        };

        window.deleteDamage = async function (damageId) {
            const damage = damages.find(d => d.id === damageId);
            if (!damage) {
                showNotification('Avaria não encontrada.', 'error');
                return;
            }

            if (!confirm('Tem certeza que deseja deletar esta avaria?\n\nEsta ação não pode ser desfeita.')) {
                return;
            }

            try {
                const damageIndex = damages.findIndex(d => d.id === damageId);
                if (damageIndex !== -1) {
                    damages.splice(damageIndex, 1);
                }

                await saveAllData();

                loadDamageHistory();

                showNotification('Avaria deletada com sucesso!', 'success');

            } catch (error) {
                console.error('Erro ao deletar avaria:', error);
                showNotification('Erro ao deletar avaria.', 'error');
            }
        };

        // ============================================
        // FUNÇÕES AUXILIARES
        // ============================================
        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString;
                return date.toLocaleDateString('pt-BR');
            } catch (e) {
                return dateString;
            }
        }

        function getDaysLeft(dateString) {
            if (!dateString) return Infinity;
            try {
                const today = new Date();
                const targetDate = new Date(dateString);
                const diffTime = targetDate - today;
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            } catch (e) {
                return Infinity;
            }
        }

        function getRandomColor() {
            const colors = [
                '#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6',
                '#1abc9c', '#d35400', '#c0392b', '#16a085', '#8e44ad'
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function showNotification(message, type) {
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            });

            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;

            let icon = 'info-circle';
            if (type === 'success') icon = 'check-circle';
            if (type === 'error') icon = 'exclamation-circle';
            if (type === 'warning') icon = 'exclamation-triangle';

            notification.innerHTML = `
                <i class="fas fa-${icon}"></i>
                <span>${message}</span>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }

        // ============================================
        // FUNÇÕES GLOBAIS PARA BOTÕES
        // ============================================
        window.viewEpiDetails = function (epiId) {
            const epi = epis.find(e => e.id === epiId);
            if (!epi) return;

            const modalBody = document.getElementById('epiModalBody');
            let modalContent = `
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 30px;">
                    <div>
                        ${epi.image ?
                    `<img src="${epi.image}" alt="${epi.name}" style="width: 100%; border-radius: 8px;">` :
                    '<div style="background-color: #f5f5f5; height: 200px; display: flex; align-items: center; justify-content: center; border-radius: 8px;"><i class="fas fa-hard-hat" style="font-size: 60px; color: #ccc;"></i></div>'
                }
                    </div>
                    <div>
                        <h3 style="margin-bottom: 10px; color: var(--primary-color);">${epi.name}</h3>
                        <p style="color: var(--gray-color); margin-bottom: 20px;">Código: ${epi.code} | CA: ${epi.caNumber}</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                            <div><strong>Categoria:</strong> ${epi.category}</div>
                            <div><strong>Status:</strong> <span class="status-badge ${getStatusClass(epi.status)}">${epi.status}</span></div>
                            <div><strong>Fabricante:</strong> ${epi.manufacturer || '-'}</div>
                            <div><strong>Quantidade:</strong> ${epi.quantity}</div>
                            <div><strong>Conformidade NR-6:</strong> ${epi.conformity}</div>
                            <div><strong>Última Inspeção:</strong> ${formatDate(epi.inspectionDate)}</div>
                            <div><strong>Vencimento:</strong> ${formatDate(epi.nextInspectionDate)}</div>
                            <div><strong>Estoque Mínimo:</strong> ${epi.stockMin}</div>
                        </div>
                        
                        ${epi.inspectionObservations ? `
                            <div style="margin-bottom: 15px;">
                                <strong>Observações da Inspeção:</strong>
                                <p>${epi.inspectionObservations}</p>
                            </div>
                        ` : ''}
                        
                        <p style="font-size: 12px; color: var(--gray-color); margin-top: 20px;">
                            Cadastrado por: ${epi.usuarioCadastro} em ${formatDate(epi.dataCadastro)}
                        </p>
                    </div>
                </div>
            `;

            if (currentUser.role === 'dev' || currentUser.role === 'almoxarife') {
                modalContent += `
                    <div style="text-align: right; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                        <button class="btn btn-danger" onclick="deleteEpi(${epi.id}); document.getElementById('epiModal').style.display='none'">
                            <i class="fas fa-trash"></i> Deletar EPI
                        </button>
                    </div>
                `;
            }

            modalBody.innerHTML = modalContent;

            document.getElementById('epiModal').style.display = 'flex';
        };

        window.editEpi = function (epiId) {
            if (currentUser.role === 'colaborador') {
                showNotification('Usuário não tem permissão para editar EPIs.', 'error');
                return;
            }

            const epi = epis.find(e => e.id === epiId);
            if (!epi) return;

            document.getElementById('epiName').value = epi.name;
            document.getElementById('caNumber').value = epi.caNumber;
            document.getElementById('code').value = epi.code;
            document.getElementById('status').value = epi.status;
            document.getElementById('quantity').value = epi.quantity;
            document.getElementById('category').value = epi.category;
            document.getElementById('manufacturer').value = epi.manufacturer || '';
            document.getElementById('conformity').value = epi.conformity;
            document.getElementById('inspectionObservations').value = epi.inspectionObservations || '';
            document.getElementById('inspectionDate').value = epi.inspectionDate || '';
            document.getElementById('nextInspectionDate').value = epi.nextInspectionDate || '';
            document.getElementById('stockMin').value = epi.stockMin || 0;

            if (epi.image) {
                document.getElementById('epiImageBase64').value = epi.image;
                document.getElementById('epiImagePreview').src = epi.image;
                document.getElementById('epiImagePreview').style.display = 'block';
                document.getElementById('cameraPlaceholder').style.display = 'none';
                document.getElementById('clearPhotoBtn').style.display = 'inline-block';
            }

            const epiIndex = epis.findIndex(e => e.id === epiId);
            if (epiIndex !== -1) {
                epis.splice(epiIndex, 1);
            }

            document.getElementById('batchTableBody').innerHTML = '';

            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            document.querySelector('[data-tab="cadastro-epi"]').classList.add('active');
            document.getElementById('cadastro-epi').classList.add('active');

            showNotification('EPI carregado para edição. Faça as alterações e salve novamente.', 'success');
        };

        // ============================================
        // EXPORTAÇÃO
        // ============================================
        function exportToExcel() {
            try {
                const epiData = epis.map(epi => ({
                    'Código': epi.code,
                    'Nome do EPI': epi.name,
                    'Categoria': epi.category,
                    'Nº CA': epi.caNumber,
                    'Fabricante': epi.manufacturer || '',
                    'Status': epi.status,
                    'Quantidade': epi.quantity,
                    'Conformidade NR-6': epi.conformity,
                    'Observações': epi.inspectionObservations || '',
                    'Última Inspeção': formatDate(epi.inspectionDate),
                    'Vencimento': formatDate(epi.nextInspectionDate),
                    'Estoque Mínimo': epi.stockMin,
                    'Data Cadastro': formatDate(epi.dataCadastro)
                }));

                const wsEpis = XLSX.utils.json_to_sheet(epiData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, wsEpis, 'EPIs');

                const fileName = `epis_${new Date().toISOString().slice(0, 10)}.xlsx`;
                XLSX.writeFile(wb, fileName);

                showNotification('Dados exportados com sucesso!', 'success');

            } catch (error) {
                console.error('Erro ao exportar:', error);
                showNotification('Erro ao exportar.', 'error');
            }
        }

        window.viewImage = function (imageSrc) {
            // Criar overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.95);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 9999;
                cursor: zoom-out;
            `;

            // Criar imagem
            const img = document.createElement('img');
            img.src = imageSrc;
            img.style.cssText = `
                max-width: 90%;
                max-height: 90%;
                border-radius: 8px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.5);
                cursor: default;
            `;

            // Fechar ao clicar
            overlay.onclick = function (e) {
                if (e.target === overlay) {
                    document.body.removeChild(overlay);
                }
            };

            // Fechar com ESC
            const keyHandler = function (e) {
                if (e.key === 'Escape') {
                    document.body.removeChild(overlay);
                    document.removeEventListener('keydown', keyHandler);
                }
            };

            // Adicionar ao documento
            overlay.appendChild(img);
            document.body.appendChild(overlay);
            document.addEventListener('keydown', keyHandler);
        };

        // ============================================
        // EVENT LISTENERS PRINCIPAIS
        // ============================================
        document.addEventListener('DOMContentLoaded', function () {
            checkSession();

            // Login
            document.getElementById('loginBtn').addEventListener('click', login);
            document.getElementById('loginPassword').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') login();
            });

            // Logout
            document.getElementById('logoutBtn').addEventListener('click', logout);

            // Abas
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function () {
                    const tabId = this.getAttribute('data-tab');

                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

                    this.classList.add('active');
                    document.getElementById(tabId).classList.add('active');

                    if (tabId === 'catalogo') {
                        loadEpisList();
                    } else if (tabId === 'controle-colaborador') {
                        loadCollaboratorsList();
                    } else if (tabId === 'devolucao-epi') {
                        updateCollaboratorSelect();
                    } else if (tabId === 'cadastro-avarias') {
                        populateEpiDropdown();
                        populateResponsibleDropdown();
                        loadDamageHistory();
                    } else if (tabId === 'certificados-laudos') {
                        // Em desenvolvimento
                    } else if (tabId === 'cadastro-epi') {
                        setTimeout(initializeEpiForm, 100);
                    }
                });
            });

            // Cadastro de EPI
            document.getElementById('saveEpiBtn').addEventListener('click', () => saveEpi(false));
            document.getElementById('saveAndAddBtn').addEventListener('click', () => saveEpi(true));
            document.getElementById('clearFormBtn').addEventListener('click', clearEpiForm);
            document.getElementById('addBatchRowBtn').addEventListener('click', addBatchRow);

            // Catálogo de EPIs
            document.getElementById('searchEpi').addEventListener('input', () => loadEpisList());
            document.getElementById('filterAllEpiBtn').addEventListener('click', () => loadEpisList('all'));
            document.getElementById('filterAvailableEpiBtn').addEventListener('click', () => loadEpisList('available'));
            document.getElementById('deleteSelectedEpisBtn').addEventListener('click', deleteSelectedEpis);
            document.getElementById('exportEpiBtn').addEventListener('click', exportToExcel);

            // Colaboradores
            document.getElementById('searchCollaborator').addEventListener('input', loadCollaboratorsList);
            document.getElementById('addCollaboratorBtn').addEventListener('click', function () {
                clearCollaboratorForm();
                document.getElementById('collaboratorModal').style.display = 'flex';
            });
            document.getElementById('assignEpiBtn').addEventListener('click', function () {
                if (collaborators.length === 0) {
                    showNotification('Cadastre pelo menos um colaborador antes de atribuir EPIs.', 'warning');
                    return;
                }
                if (epis.length === 0) {
                    showNotification('Cadastre pelo menos um EPI antes de atribuir.', 'warning');
                    return;
                }
                clearAssignmentForm();
                updateAssignEpiDropdown(); // <-- ADICIONAR ESTA LINHA
                document.getElementById('assignEpiModal').style.display = 'flex';
            });

            // Botões do modal de colaborador
            document.getElementById('saveCollaboratorBtn').addEventListener('click', saveCollaborator);
            document.getElementById('clearCollaboratorFormBtn').addEventListener('click', clearCollaboratorForm);

            // Botões do modal de atribuição de EPI
            document.getElementById('saveAssignmentBtn').addEventListener('click', saveAssignment);
            document.getElementById('clearAssignmentFormBtn').addEventListener('click', clearAssignmentForm);

            // Avarias
            document.getElementById('saveDamageBtn').addEventListener('click', saveDamage);
            document.getElementById('clearDamageBtn').addEventListener('click', clearDamageForm);

            // Termo de Responsabilidade
            document.getElementById('printTermoBtn').addEventListener('click', function () {
                window.print();
            });

            document.getElementById('generateTermoBtn').addEventListener('click', function () {
                showNotification('Funcionalidade de PDF em desenvolvimento.', 'info');
            });

            // Modais - Fechar
            document.getElementById('closeModalBtn').addEventListener('click', function () {
                document.getElementById('epiModal').style.display = 'none';
            });

            document.getElementById('closeCollaboratorModalBtn').addEventListener('click', function () {
                document.getElementById('collaboratorModal').style.display = 'none';
                clearCollaboratorForm();
            });

            document.getElementById('closeAssignEpiModalBtn').addEventListener('click', function () {
                document.getElementById('assignEpiModal').style.display = 'none';
                clearAssignmentForm();
            });

            // Fechar modais ao clicar fora
            document.getElementById('epiModal').addEventListener('click', function (e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });

            document.getElementById('collaboratorModal').addEventListener('click', function (e) {
                if (e.target === this) {
                    this.style.display = 'none';
                    clearCollaboratorForm();
                }
            });

            document.getElementById('assignEpiModal').addEventListener('click', function (e) {
                if (e.target === this) {
                    this.style.display = 'none';
                    clearAssignmentForm();
                }
            });

            // ============================================
            // FUNÇÃO PARA ATUALIZAR QUANTIDADE DE EPI NO ESTOQUE
            // ============================================
            function updateEpiQuantity(epiId, quantityToRemove) {
                const epiIndex = epis.findIndex(e => e.id === epiId);
                if (epiIndex !== -1) {
                    const epi = epis[epiIndex];

                    // Verificar se há estoque suficiente
                    if (epi.quantity < quantityToRemove) {
                        showNotification(`Estoque insuficiente para ${epi.name}. Disponível: ${epi.quantity}`, 'error');
                        return false;
                    }

                    // Reduzir a quantidade
                    epi.quantity -= quantityToRemove;

                    // Se a quantidade chegar a zero, atualizar status para "Esgotado" ou manter como "Em Uso"?
                    if (epi.quantity === 0) {
                        // Opção 1: Marcar como "Esgotado"
                        epi.status = 'Esgotado';
                        // Opção 2: Manter como "Em Uso" (descomente a linha abaixo e comente a de cima)
                        // epi.status = 'Em Uso';
                    }

                    console.log(`📦 Estoque atualizado: ${epi.name} - Nova quantidade: ${epi.quantity}`);
                    return true;
                }
                return false;
            }
        });

        // ============================================
        // ATUALIZAR DROPDOWN DE EPIs DISPONÍVEIS
        // ============================================
        function updateAssignEpiDropdown() {
            const assignEpiSelect = document.getElementById('assignEpi');
            if (!assignEpiSelect) return;

            assignEpiSelect.innerHTML = '<option value="">Selecione o EPI</option>';

            // Filtrar APENAS EPIs com status "Disponível" E quantidade > 0
            const availableEpis = epis.filter(epi => {
                const quantity = Number(epi.quantity) || 0;
                return quantity > 0 && epi.status === 'Disponível'; // APENAS Disponível, não "Em Uso"
            });

            if (availableEpis.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Nenhum EPI disponível em estoque';
                option.disabled = true;
                assignEpiSelect.appendChild(option);
                return;
            }

            availableEpis.forEach(epi => {
                const option = document.createElement('option');
                option.value = epi.id;
                const quantity = Number(epi.quantity) || 0;
                option.textContent = `${epi.name} (${epi.code}) - Estoque: ${quantity} unid. - CA: ${epi.caNumber}`;
                assignEpiSelect.appendChild(option);
            });
        }
        // ============================================
        // CONTAR QUANTOS EPIs ESTÃO EM USO (ATRIBUIÇÕES ATIVAS)
        // ============================================
        function getActiveAssignmentsCount(epiId) {
            return assignments.filter(a => a.epiId === epiId && a.status === 'Ativo').length;
        }

        function getEpiStockStatus(epiId) {
            const epi = epis.find(e => e.id === epiId);
            const activeAssignments = getActiveAssignmentsCount(epiId);

            return {
                estoque: epi ? epi.quantity : 0,
                emUso: activeAssignments,
                totalOriginal: epi ? (epi.quantity + activeAssignments) : 0
            };
        }
        // ============================================
        // FUNÇÕES PARA LIMPAR CACHE E BAIXAR DADOS AUTOMATICAMENTE
        // ============================================

        // Função para limpar todo o cache (ZERAR TUDO)
        async function limparTodoCache() {
            if (!confirm('⚠️ ATENÇÃO! Você está prestes a:\n\n' +
                '• Deletar TODOS os EPIs cadastrados\n' +
                '• Deletar TODOS os Colaboradores\n' +
                '• Deletar TODAS as Atribuições\n' +
                '• Deletar TODAS as Devoluções\n' +
                '• Deletar TODAS as Avarias\n' +
                '• Deletar TODOS os Certificados\n\n' +
                'Esta ação NÃO PODE SER DESFEITA!\n\n' +
                'Deseja realmente limpar todo o cache do sistema?')) {
                return;
            }

            // Segunda confirmação para segurança
            if (!confirm('🔥 CONFIRMAÇÃO FINAL 🔥\n\n' +
                'Tem certeza absoluta que deseja apagar TODOS os dados do sistema?\n\n' +
                'Digite "SIM" no campo abaixo para confirmar.')) {

                // Criar prompt personalizado
                const senhaConfirmacao = prompt('Para confirmar a limpeza total do cache, digite a palavra: LIMPAR');
                if (senhaConfirmacao !== 'LIMPAR') {
                    showNotification('❌ Operação cancelada - confirmação incorreta.', 'error');
                    return;
                }
            }

            try {
                showNotification('🧹 Limpando todo o cache do sistema...', 'info');

                // 1. Fazer backup automático antes de limpar
                if (epis.length > 0 || collaborators.length > 0) {
                    const backupData = {
                        epis: epis,
                        collaborators: collaborators,
                        assignments: assignments,
                        damages: damages,
                        certificates: certificates,
                        metadata: {
                            sistema: "BACKUP_AUTOMATICO_ANTES_LIMPEZA",
                            versao: "3.0",
                            dataBackup: new Date().toISOString(),
                            usuario: currentUser ? currentUser.name : 'Anônimo'
                        }
                    };

                    const jsonString = JSON.stringify(backupData, null, 2);
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `backup_automatico_antes_limpeza_${new Date().toISOString().slice(0, 10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    showNotification('💾 Backup automático criado antes da limpeza!', 'success');
                }

                // 2. LIMPAR TODOS OS ARRAYS
                epis = [];
                collaborators = [];
                assignments = [];
                damages = [];
                certificates = [];

                // 3. LIMPAR localStorage
                localStorage.removeItem('epis');
                localStorage.removeItem('collaborators');
                localStorage.removeItem('assignments');
                localStorage.removeItem('damages');
                localStorage.removeItem('certificates');
                localStorage.removeItem('lastModified');
                localStorage.removeItem('lastAutomaticBackup');

                // 4. Limpar timestamps de sincronização
                lastSyncTimes = {
                    epis: null,
                    collaborators: null,
                    assignments: null,
                    returns: null,
                    damages: null,
                    catalog: null
                };

                // 5. ATUALIZAR TODAS AS INTERFACES
                loadEpisList();
                loadCollaboratorsList();
                loadDamageHistory();
                updateDashboardStats();
                updateCategoryChart();
                updateStatistics();
                updateCounts();
                updateLastSyncDisplay();

                // 6. Recarregar dropdowns
                updateAssignEpiDropdown();
                updateCollaboratorSelect();
                populateEpiDropdown();
                populateResponsibleDropdown();

                showNotification('✅ Cache do sistema completamente limpo! Backup automático salvo.', 'success');

                console.log('🧹 Sistema completamente zerado:', {
                    epis: epis.length,
                    colaboradores: collaborators.length,
                    atribuicoes: assignments.length,
                    avarias: damages.length
                });

            } catch (error) {
                console.error('❌ Erro ao limpar cache:', error);
                showNotification('❌ Erro ao limpar cache do sistema.', 'error');
            }
        }

        // Função para baixar TODOS os dados da nuvem automaticamente
        async function baixarTodosDadosAutomatico() {
            if (!isSupabaseConnected || !supabaseClient) {
                showNotification('❌ Sem conexão com a nuvem. Verifique sua conexão.', 'error');
                return;
            }

            try {
                showNotification('📥 Baixando TODOS os dados da nuvem automaticamente...', 'info');

                let totalEpis = 0;
                let totalColaboradores = 0;
                let totalAtribuicoes = 0;
                let totalDevolucoes = 0;
                let totalAvarias = 0;

                // 1. BAIXAR EPIs
                const { data: episData, error: episError } = await supabaseClient
                    .from('epis')
                    .select('*')
                    .order('codigo');

                if (!episError && episData) {
                    epis = episData.map(item => ({
                        id: item.id || Date.now(),
                        name: item.nome_epi,
                        code: item.codigo,
                        category: item.categoria,
                        caNumber: item.ca_numero,
                        manufacturer: item.fabricante || '',
                        status: item.status,
                        quantity: item.quantidade,
                        conformity: item.conformidade_nr6,
                        inspectionObservations: item.observacoes || '',
                        inspectionDate: item.ultima_inspecao || null,
                        nextInspectionDate: item.proxima_inspecao || null,
                        stockMin: item.estoque_minimo || 0,
                        image: item.imagem || '',
                        dataCadastro: item.data_cadastro || new Date().toISOString().split('T')[0],
                        usuarioCadastro: item.usuario_cadastro || 'Sistema',
                        createdAt: item.created_at || new Date().toISOString()
                    }));
                    totalEpis = epis.length;
                }

                // 2. BAIXAR COLABORADORES
                const { data: colaboradoresData, error: colabError } = await supabaseClient
                    .from('colaboradores')
                    .select('*')
                    .order('nome');

                if (!colabError && colaboradoresData) {
                    collaborators = colaboradoresData.map(item => ({
                        id: item.id || Date.now(),
                        name: item.nome,
                        registration: item.matricula,
                        sector: item.setor,
                        position: item.cargo,
                        admissionDate: item.data_admissao,
                        status: item.status,
                        observations: item.observacoes || '',
                        usuarioCadastro: item.usuario_cadastro || 'Sistema',
                        dataCadastro: item.data_cadastro || new Date().toISOString().split('T')[0]
                    }));
                    totalColaboradores = collaborators.length;
                }

                // 3. BAIXAR ATRIBUIÇÕES
                const { data: atribuicoesData, error: attrError } = await supabaseClient
                    .from('atribuicoes')
                    .select('*')
                    .order('data_atribuicao', { ascending: false });

                if (!attrError && atribuicoesData) {
                    assignments = [];
                    for (const item of atribuicoesData) {
                        const epi = epis.find(e => e.code === item.epi_codigo);
                        const colaborador = collaborators.find(c => c.registration === item.colaborador_matricula);

                        if (epi && colaborador) {
                            assignments.push({
                                id: item.id || Date.now() + Math.random(),
                                collaboratorId: colaborador.id,
                                epiId: epi.id,
                                assignmentDate: item.data_atribuicao,
                                expirationDate: item.data_validade,
                                status: item.status || 'Ativo',
                                observations: item.observacoes || '',
                                usuarioCadastro: item.usuario_atribuicao || 'Sistema',
                                dataCadastro: item.data_cadastro || new Date().toISOString().split('T')[0],
                                createdAt: item.created_at || new Date().toISOString()
                            });
                        }
                    }
                    totalAtribuicoes = assignments.filter(a => a.status === 'Ativo').length;
                }

                // 4. BAIXAR DEVOLUÇÕES
                const { data: devolucoesData, error: devError } = await supabaseClient
                    .from('devolucoes')
                    .select('*')
                    .order('data_devolucao', { ascending: false });

                if (!devError && devolucoesData) {
                    let devolucoesCount = 0;
                    for (const item of devolucoesData) {
                        const epi = epis.find(e => e.code === item.epi_codigo);
                        const colaborador = collaborators.find(c => c.registration === item.colaborador_matricula);

                        if (epi && colaborador) {
                            // Verificar se já existe uma atribuição com esses dados
                            const existingAssignment = assignments.find(a =>
                                a.epiId === epi.id &&
                                a.collaboratorId === colaborador.id &&
                                a.assignmentDate === item.data_atribuicao
                            );

                            if (existingAssignment) {
                                existingAssignment.status = 'Devolvido';
                                existingAssignment.returnDate = item.data_devolucao;
                                existingAssignment.returnReason = item.motivo;
                                existingAssignment.returnCondition = item.condicao;
                                existingAssignment.returnObservations = item.observacoes || '';
                            }
                            devolucoesCount++;
                        }
                    }
                    totalDevolucoes = devolucoesCount;
                }

                // 5. BAIXAR AVARIAS
                const { data: avariasData, error: avariaError } = await supabaseClient
                    .from('avarias')
                    .select('*')
                    .order('data_avaria', { ascending: false });

                if (!avariaError && avariasData) {
                    damages = [];
                    for (const item of avariasData) {
                        const epi = epis.find(e => e.code === item.epi_codigo);
                        const responsible = collaborators.find(c => c.registration === item.colaborador_matricula);

                        if (epi && responsible) {
                            damages.push({
                                id: item.id || Date.now() + Math.random(),
                                epiId: epi.id,
                                date: item.data_avaria,
                                reason: item.motivo,
                                responsibleId: responsible.id,
                                description: item.descricao,
                                solution: item.solucao || '',
                                observations: item.observacoes || '',
                                reportedBy: item.usuario_registro || 'Sistema',
                                createdAt: item.created_at || new Date().toISOString(),
                                status: item.status || 'Registrada'
                            });
                        }
                    }
                    totalAvarias = damages.length;
                }

                // 6. SALVAR TODOS OS DADOS NO LOCALSTORAGE
                await saveAllData();

                // 7. ATUALIZAR TODAS AS INTERFACES
                loadEpisList();
                loadCollaboratorsList();
                loadDamageHistory();
                updateDashboardStats();
                updateCategoryChart();
                updateStatistics();
                updateCounts();
                updateAssignEpiDropdown();
                updateCollaboratorSelect();
                populateEpiDropdown();
                populateResponsibleDropdown();

                lastSyncTimes = {
                    epis: new Date(),
                    collaborators: new Date(),
                    assignments: new Date(),
                    returns: new Date(),
                    damages: new Date(),
                    catalog: new Date()
                };
                updateLastSyncDisplay();

                // 8. MOSTRAR RESUMO DO DOWNLOAD
                showNotification(`✅ DOWNLOAD AUTOMÁTICO CONCLUÍDO!
            
📊 RESUMO:
📦 EPIs: ${totalEpis}
👥 Colaboradores: ${totalColaboradores}
🪪 Atribuições Ativas: ${totalAtribuicoes}
↩️ Devoluções: ${totalDevolucoes}
⚠️ Avarias: ${totalAvarias}`, 'success');

                console.log('📥 Download automático concluído:', {
                    epis: totalEpis,
                    colaboradores: totalColaboradores,
                    atribuicoes: totalAtribuicoes,
                    devolucoes: totalDevolucoes,
                    avarias: totalAvarias
                });

            } catch (error) {
                console.error('❌ Erro no download automático:', error);
                showNotification('❌ Erro ao baixar dados da nuvem.', 'error');
            }
        }

        // ============================================
        // ADICIONAR BOTÕES NA INTERFACE
        // ============================================
        function adicionarBotoesCacheEDownload() {
            // Encontrar a aba de Banco de Dados
            const databaseTab = document.getElementById('database');
            if (!databaseTab) return;

            // Verificar se os botões já existem
            if (document.getElementById('limparCacheBtn')) return;

            // Criar seção para os novos botões
            const novaSecao = document.createElement('div');
            novaSecao.style.marginTop = '30px';
            novaSecao.style.marginBottom = '20px';
            novaSecao.innerHTML = `
        <div style="border-top: 2px solid var(--danger-color); margin-bottom: 20px;"></div>
        
        <h4 style="color: var(--primary-color); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-tools" style="color: var(--danger-color);"></i> 
            FERRAMENTAS DE SISTEMA
        </h4>
        
        <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 25px;">
            <!-- BOTÃO DE LIMPAR CACHE -->
            <button id="limparCacheBtn" class="btn btn-danger" style="background-color: #c0392b; border: none; padding: 14px 25px; font-size: 16px; font-weight: 600;">
                <i class="fas fa-broom" style="margin-right: 10px;"></i>
                🧹 LIMPAR TODO O CACHE (ZERAR SISTEMA)
            </button>
            
            <!-- BOTÃO DE DOWNLOAD AUTOMÁTICO -->
            <button id="downloadAutomaticoBtn" class="btn btn-success" style="background-color: #27ae60; border: none; padding: 14px 25px; font-size: 16px; font-weight: 600;">
                <i class="fas fa-cloud-download-alt" style="margin-right: 10px;"></i>
                📥 BAIXAR TUDO DA NUVEM (AUTOMÁTICO)
            </button>
        </div>
        
        <div style="background-color: #fff3cd; border-left: 4px solid var(--warning-color); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <i class="fas fa-exclamation-triangle" style="font-size: 24px; color: var(--warning-color);"></i>
                <div>
                    <strong style="color: #856404; font-size: 15px;">⚠️ ATENÇÃO - BOTÕES CRÍTICOS</strong>
                    <p style="color: #856404; margin-top: 5px; font-size: 13px;">
                        • <strong>LIMPAR CACHE:</strong> Apaga TODOS os dados do sistema. Backup automático é criado antes da limpeza.<br>
                        • <strong>DOWNLOAD AUTOMÁTICO:</strong> Baixa EPIs, Colaboradores, Atribuições, Devoluções e Avarias da nuvem.
                    </p>
                </div>
            </div>
        </div>
    `;

            // Adicionar a nova seção após os botões existentes
            const formContainer = databaseTab.querySelector('.form-container');
            if (formContainer) {
                formContainer.appendChild(novaSecao);
            }

            // Adicionar event listeners aos botões
            setTimeout(() => {
                const limparBtn = document.getElementById('limparCacheBtn');
                if (limparBtn) {
                    limparBtn.addEventListener('click', limparTodoCache);
                }

                const downloadBtn = document.getElementById('downloadAutomaticoBtn');
                if (downloadBtn) {
                    downloadBtn.addEventListener('click', baixarTodosDadosAutomatico);
                }
            }, 100);
        }

        // Sobrescrever o initializeSystem para incluir os novos botões
        const originalInitializeSystem = initializeSystem;
        initializeSystem = async function () {
            await originalInitializeSystem.call(this);
            adicionarBotoesCacheEDownload();
        };

        // Adicionar também quando a aba de banco de dados for aberta
        document.addEventListener('DOMContentLoaded', function () {
            const originalTabClick = document.querySelectorAll('.tab-button')?.forEach;
            if (originalTabClick) {
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.addEventListener('click', function () {
                        const tabId = this.getAttribute('data-tab');
                        if (tabId === 'database') {
                            setTimeout(adicionarBotoesCacheEDownload, 200);
                        }
                    });
                });
            }
        });
        // ============================================
        // DOWNLOAD AUTOMÁTICO AO INICIAR O SISTEMA
        // ============================================

        // Função modificada para baixar dados automaticamente sem notificações excessivas
        async function baixarDadosAutomaticoInicial(silencioso = true) {
            if (!isSupabaseConnected || !supabaseClient) {
                console.log('⚠️ Download automático: Sem conexão com nuvem');
                if (!silencioso) {
                    showNotification('❌ Sem conexão com a nuvem para download automático.', 'error');
                }
                return false;
            }

            try {
                if (!silencioso) {
                    showNotification('📥 Baixando dados da nuvem automaticamente...', 'info');
                } else {
                    console.log('📥 Download automático silencioso iniciado...');
                }

                let totalEpis = 0;
                let totalColaboradores = 0;
                let totalAtribuicoes = 0;
                let totalDevolucoes = 0;
                let totalAvarias = 0;

                // 1. BAIXAR EPIs
                const { data: episData, error: episError } = await supabaseClient
                    .from('epis')
                    .select('*')
                    .order('codigo');

                if (!episError && episData && episData.length > 0) {
                    epis = episData.map(item => ({
                        id: item.id || Date.now(),
                        name: item.nome_epi,
                        code: item.codigo,
                        category: item.categoria,
                        caNumber: item.ca_numero,
                        manufacturer: item.fabricante || '',
                        status: item.status,
                        quantity: item.quantidade || 1,
                        conformity: item.conformidade_nr6,
                        inspectionObservations: item.observacoes || '',
                        inspectionDate: item.ultima_inspecao || null,
                        nextInspectionDate: item.proxima_inspecao || null,
                        stockMin: item.estoque_minimo || 0,
                        image: item.imagem || '',
                        dataCadastro: item.data_cadastro || new Date().toISOString().split('T')[0],
                        usuarioCadastro: item.usuario_cadastro || 'Sistema',
                        createdAt: item.created_at || new Date().toISOString()
                    }));
                    totalEpis = epis.length;
                    console.log(`✅ Download automático: ${totalEpis} EPIs carregados`);
                }

                // 2. BAIXAR COLABORADORES
                const { data: colaboradoresData, error: colabError } = await supabaseClient
                    .from('colaboradores')
                    .select('*')
                    .order('nome');

                if (!colabError && colaboradoresData && colaboradoresData.length > 0) {
                    collaborators = colaboradoresData.map(item => ({
                        id: item.id || Date.now(),
                        name: item.nome,
                        registration: item.matricula,
                        sector: item.setor,
                        position: item.cargo,
                        admissionDate: item.data_admissao,
                        status: item.status,
                        observations: item.observacoes || '',
                        usuarioCadastro: item.usuario_cadastro || 'Sistema',
                        dataCadastro: item.data_cadastro || new Date().toISOString().split('T')[0]
                    }));
                    totalColaboradores = collaborators.length;
                    console.log(`✅ Download automático: ${totalColaboradores} colaboradores carregados`);
                }

                // 3. BAIXAR ATRIBUIÇÕES
                const { data: atribuicoesData, error: attrError } = await supabaseClient
                    .from('atribuicoes')
                    .select('*')
                    .order('data_atribuicao', { ascending: false });

                if (!attrError && atribuicoesData && atribuicoesData.length > 0) {
                    assignments = [];
                    for (const item of atribuicoesData) {
                        const epi = epis.find(e => e.code === item.epi_codigo);
                        const colaborador = collaborators.find(c => c.registration === item.colaborador_matricula);

                        if (epi && colaborador) {
                            assignments.push({
                                id: item.id || Date.now() + Math.random(),
                                collaboratorId: colaborador.id,
                                epiId: epi.id,
                                assignmentDate: item.data_atribuicao,
                                expirationDate: item.data_validade,
                                status: item.status || 'Ativo',
                                observations: item.observacoes || '',
                                usuarioCadastro: item.usuario_atribuicao || 'Sistema',
                                dataCadastro: item.data_cadastro || new Date().toISOString().split('T')[0],
                                createdAt: item.created_at || new Date().toISOString()
                            });
                        }
                    }
                    totalAtribuicoes = assignments.filter(a => a.status === 'Ativo').length;
                    console.log(`✅ Download automático: ${totalAtribuicoes} atribuições ativas carregadas`);
                }

                // 4. BAIXAR DEVOLUÇÕES
                const { data: devolucoesData, error: devError } = await supabaseClient
                    .from('devolucoes')
                    .select('*')
                    .order('data_devolucao', { ascending: false });

                if (!devError && devolucoesData && devolucoesData.length > 0) {
                    let devolucoesCount = 0;
                    for (const item of devolucoesData) {
                        const epi = epis.find(e => e.code === item.epi_codigo);
                        const colaborador = collaborators.find(c => c.registration === item.colaborador_matricula);

                        if (epi && colaborador) {
                            const existingAssignment = assignments.find(a =>
                                a.epiId === epi.id &&
                                a.collaboratorId === colaborador.id &&
                                a.assignmentDate === item.data_atribuicao
                            );

                            if (existingAssignment) {
                                existingAssignment.status = 'Devolvido';
                                existingAssignment.returnDate = item.data_devolucao;
                                existingAssignment.returnReason = item.motivo;
                                existingAssignment.returnCondition = item.condicao;
                                existingAssignment.returnObservations = item.observacoes || '';
                            }
                            devolucoesCount++;
                        }
                    }
                    totalDevolucoes = devolucoesCount;
                    console.log(`✅ Download automático: ${totalDevolucoes} devoluções carregadas`);
                }

                // 5. BAIXAR AVARIAS
                const { data: avariasData, error: avariaError } = await supabaseClient
                    .from('avarias')
                    .select('*')
                    .order('data_avaria', { ascending: false });

                if (!avariaError && avariasData && avariasData.length > 0) {
                    damages = [];
                    for (const item of avariasData) {
                        const epi = epis.find(e => e.code === item.epi_codigo);
                        const responsible = collaborators.find(c => c.registration === item.colaborador_matricula);

                        if (epi && responsible) {
                            damages.push({
                                id: item.id || Date.now() + Math.random(),
                                epiId: epi.id,
                                date: item.data_avaria,
                                reason: item.motivo,
                                responsibleId: responsible.id,
                                description: item.descricao,
                                solution: item.solucao || '',
                                observations: item.observacoes || '',
                                reportedBy: item.usuario_registro || 'Sistema',
                                createdAt: item.created_at || new Date().toISOString(),
                                status: item.status || 'Registrada'
                            });
                        }
                    }
                    totalAvarias = damages.length;
                    console.log(`✅ Download automático: ${totalAvarias} avarias carregadas`);
                }

                // 6. SALVAR TODOS OS DADOS NO LOCALSTORAGE
                await saveAllData();

                // 7. ATUALIZAR TODAS AS INTERFACES (APENAS SE HOUVER DADOS)
                if (totalEpis > 0 || totalColaboradores > 0) {
                    loadEpisList();
                    loadCollaboratorsList();
                    loadDamageHistory();
                    updateDashboardStats();
                    updateCategoryChart();
                    updateStatistics();
                    updateCounts();
                    updateAssignEpiDropdown();
                    updateCollaboratorSelect();
                    populateEpiDropdown();
                    populateResponsibleDropdown();
                }

                lastSyncTimes = {
                    epis: new Date(),
                    collaborators: new Date(),
                    assignments: new Date(),
                    returns: new Date(),
                    damages: new Date(),
                    catalog: new Date()
                };
                updateLastSyncDisplay();

                // 8. MOSTRAR NOTIFICAÇÃO APENAS SE HOUVER MUITOS DADOS OU SE NÃO FOR SILENCIOSO
                const totalGeral = totalEpis + totalColaboradores + totalAtribuicoes + totalDevolucoes + totalAvarias;

                if (!silencioso && totalGeral > 0) {
                    showNotification(`📥 Download automático concluído!\n\n📊 ${totalEpis} EPIs | 👥 ${totalColaboradores} Colabs | 🪪 ${totalAtribuicoes} Atrib. | ⚠️ ${totalAvarias} Avar.`, 'success');
                } else if (totalGeral > 0) {
                    console.log(`✅ Download automático silencioso concluído: ${totalGeral} itens carregados`);
                }

                return true;

            } catch (error) {
                console.error('❌ Erro no download automático inicial:', error);
                if (!silencioso) {
                    showNotification('❌ Erro ao baixar dados da nuvem automaticamente.', 'error');
                }
                return false;
            }
        }

        // ============================================
        // SUBSTITUIR A FUNÇÃO initializeSystem ORIGINAL
        // ============================================

        // Salvar referência da função original se existir
        const initializeSystemOriginal = window.initializeSystem || function () { };

        // Nova função initializeSystem com download automático
        window.initializeSystem = async function () {
            try {
                console.log('🔧 INICIALIZANDO SISTEMA DE EPIs COM DOWNLOAD AUTOMÁTICO');
                console.log('👤 Usuário atual:', currentUser?.name || 'Não autenticado');
                console.log('🔑 Nível de acesso:', currentUser?.role || 'Nenhum');

                // 1. INICIALIZAR SUPABASE
                await initializeSupabase();

                // 2. VERIFICAR SE TEM DADOS LOCAIS
                const hasLocalData = localStorage.getItem('epis') !== null;

                // 3. SE ESTIVER CONECTADO À NUVEM, FAZER DOWNLOAD AUTOMÁTICO
                if (isSupabaseConnected) {
                    console.log('☁️ Conexão com nuvem estabelecida. Iniciando download automático...');

                    // TENTAR BAIXAR DADOS DA NUVEM (SILENCIOSO)
                    await baixarDadosAutomaticoInicial(true);

                    console.log('✅ Download automático concluído');
                } else {
                    console.log('⚠️ Sem conexão com nuvem. Usando dados locais...');

                    // CARREGAR DADOS LOCAIS
                    await loadInitialData();
                }

                // 4. ATUALIZAR TODAS AS INTERFACES
                updateDashboardStats();
                updateStatistics();
                loadEpisList();
                loadCollaboratorsList();
                updateCategoryChart();
                initializeEpiForm();
                initializeReturnTab();
                initializeDamageTab();
                setupSyncButtons();
                setupBackupButton();
                updateCounts();
                setupAutomaticBackup();

                // 5. ADICIONAR BOTÕES DE CACHE E DOWNLOAD
                adicionarBotoesCacheEDownload();

                // 6. NOTIFICAÇÃO DE BOAS-VINDAS COM RESUMO
                setTimeout(() => {
                    const totalEpisCount = epis.length;
                    const totalColabsCount = collaborators.length;
                    const totalAtribCount = assignments.filter(a => a.status === 'Ativo').length;

                    showNotification(
                        ` Bem-vindo, ${currentUser?.name || 'Usuário'}!\n\n` +
                        `📊 Sistema carregado:\n` +
                        `📦 ${totalEpisCount} EPIs | 👥 ${totalColabsCount} Colabs | 🪪 ${totalAtribCount} Atribuições\n` +
                        `${isSupabaseConnected ? '☁️ Conectado à nuvem' : '⚠️ Modo offline'}`,
                        'success'
                    );
                }, 500);

                console.log('✅ Sistema inicializado com sucesso!');

            } catch (error) {
                console.error('❌ Erro na inicialização:', error);
                showNotification('Erro ao inicializar sistema. Carregando dados locais...', 'error');

                // TENTAR CARREGAR DADOS LOCAIS EM CASO DE ERRO
                await loadInitialData();
            }
        };

        // ============================================
        // GARANTIR QUE O DOWNLOAD AUTOMÁTICO ACONTEÇA EM TODOS OS CENÁRIOS
        // ============================================

        // 1. Quando o sistema é inicializado após login
        const originalShowDashboard = window.showDashboard;
        window.showDashboard = function () {
            if (originalShowDashboard) {
                originalShowDashboard.call(this);
            }

            // Inicializar sistema com download automático
            setTimeout(async () => {
                await initializeSystem();
            }, 100);
        };

        // 2. Quando a página é carregada/atualizada
        document.addEventListener('DOMContentLoaded', function () {
            // Verificar se já está logado
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    if (currentUser && users[currentUser.key]) {
                        // Se já estiver logado, fazer download automático
                        setTimeout(async () => {
                            await initializeSupabase();
                            if (isSupabaseConnected) {
                                await baixarDadosAutomaticoInicial(true);
                            }
                        }, 200);
                    }
                } catch (e) {
                    console.error('Erro ao restaurar sessão:', e);
                }
            }
        });

        // 3. Quando a conexão com Supabase é estabelecida
        const originalInitializeSupabase = window.initializeSupabase;
        window.initializeSupabase = async function () {
            await originalInitializeSupabase.call(this);

            // Se conectou e tem usuário logado, fazer download automático
            if (isSupabaseConnected && currentUser) {
                setTimeout(async () => {
                    await baixarDadosAutomaticoInicial(true);
                }, 300);
            }
        };

        // 4. Forçar download automático após login bem-sucedido
        const originalLogin = window.login;
        window.login = function () {
            const result = originalLogin.call(this);

            // Após login bem-sucedido, fazer download automático
            setTimeout(async () => {
                if (isSupabaseConnected) {
                    console.log('🔄 Login detectado, iniciando download automático...');
                    await baixarDadosAutomaticoInicial(false); // Não silencioso no login
                }
            }, 500);

            return result;
        };
        // ============================================
        // ADICIONAR INDICADOR DE DOWNLOAD AUTOMÁTICO NO HEADER
        // ============================================
        function adicionarIndicadorDownloadAutomatico() {
            const userInfo = document.querySelector('.user-info');
            if (!userInfo) return;

            // Verificar se já existe
            if (document.getElementById('autoDownloadIndicator')) return;

            const indicator = document.createElement('div');
            indicator.id = 'autoDownloadIndicator';
            indicator.style.marginLeft = '10px';
            indicator.style.display = 'inline-flex';
            indicator.style.alignItems = 'center';
            indicator.style.gap = '5px';

            // Atualizar status a cada 30 segundos
            function updateIndicator() {
                if (isSupabaseConnected) {
                    indicator.innerHTML = `
                <span style="background-color: rgba(46, 204, 113, 0.2); padding: 5px 10px; border-radius: 20px; font-size: 12px; color: #27ae60; display: flex; align-items: center; gap: 5px;">
                    <i class="fas fa-cloud-download-alt"></i>
                    Download automático ativo
                </span>
            `;
                } else {
                    indicator.innerHTML = `
                <span style="background-color: rgba(231, 76, 60, 0.2); padding: 5px 10px; border-radius: 20px; font-size: 12px; color: #e74c3c; display: flex; align-items: center; gap: 5px;">
                    <i class="fas fa-cloud"></i>
                    Modo offline
                </span>
            `;
                }
            }

            updateIndicator();
            setInterval(updateIndicator, 30000);

            userInfo.appendChild(indicator);
        }

        // Adicionar ao mostrar dashboard
        const originalShowDashboardWithIndicator = window.showDashboard;
        window.showDashboard = function () {
            if (originalShowDashboardWithIndicator) {
                originalShowDashboardWithIndicator.call(this);
            }
            setTimeout(adicionarIndicadorDownloadAutomatico, 200);
        };
        // ============================================
        // CONTAR QUANTOS EPIs ESTÃO EM USO (ATRIBUIÇÕES ATIVAS)
        // ============================================
        function getActiveAssignmentsCount(epiId) {
            return assignments.filter(a => a.epiId === epiId && a.status === 'Ativo').length;
        }
    </script>
</body>

</html>
